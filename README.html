<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>README</title>
  <style>
    html {
      line-height: 1.5;
      font-family: Georgia, serif;
      font-size: 20px;
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      word-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 1em;
      }
    }
    @media print {
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, 'Lucida Console', Consolas, monospace;
      font-size: 85%;
      margin: 0;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<ul>
<li><a href="#rdbms-history">RDBMS history</a></li>
<li><a href="#rdbms-pros-and-cons">RDBMS Pros and cons</a></li>
<li><a href="#why-rdbms-is-successful">Why RDBMS is successful?</a></li>
<li><a href="#how-rdbms-is-tuned">How RDBMS is tuned</a></li>
<li><a href="#two-phase-commit-vs-compensation">Two-phase commit vs Compensation</a></li>
<li><a href="#sharding-share-nothing">Sharding (Share nothing)</a></li>
<li><a href="#list-of-nosql-databases">List of NoSQL databases</a></li>
<li><a href="#apache-cassandra---official-definition">Apache Cassandra - Official definition</a></li>
<li><a href="#cassandra-features">Cassandra Features</a></li>
<li><a href="#what-are-all-consistency-forms">What are all Consistency Forms?</a></li>
<li><a href="#strong-consistency-in-cassandra">Strong consistency in Cassandra</a></li>
<li><a href="#row-oriented-data-store">Row-Oriented data store</a></li>
<li><a href="#always-writeable">Always writeable</a></li>
<li><a href="#notable-tools">Notable tools</a></li>
<li><a href="#few-use-cases">Few use cases</a></li>
<li><a href="#updated-cap---brewers-theorem">Updated CAP - Brewer’s Theorem</a></li>
<li><a href="#what-is-the-alternative-for-two-phase-commit">What is the alternative for Two-phase commit</a></li>
<li><a href="#how-to-horizontally-scale-rdbms-shard">How to horizontally scale RDBMS (shard)</a></li>
<li><a href="#there-are-three-basic-strategies-for-determining-shard-structure">There are three basic strategies for determining shard structure:</a></li>
<li><a href="#shared-nothing">Shared nothing</a></li>
<li><a href="#new-sql-scalable-acid-transactions">New SQL (Scalable ACID transactions)</a></li>
<li><a href="#cassandra-features-1">Cassandra features</a></li>
<li><a href="#cap-theorem-brewers-theorem">Cap Theorem (Brewer’s theorem)</a></li>
<li><a href="#cassandra-lightweight-transaction-lwt---linearizable-consistency">Cassandra Lightweight transaction (LWT) - Linearizable consistency</a></li>
<li><a href="#row-oriented-wide-column-store">Row-Oriented (Wide column store)</a></li>
<li><a href="#cassandra---schema-free">Cassandra - schema free?</a></li>
<li><a href="#cassandra---use-cases">Cassandra - use-cases?</a></li>
<li><a href="#cassandra-directories">Cassandra directories</a></li>
<li><a href="#cassandra-directories-and-files">Cassandra directories and files</a></li>
<li><a href="#cassandra-run-time-properties">Cassandra run-time properties</a></li>
<li><a href="#cassandra-cqlsh">Cassandra cqlsh</a></li>
<li><a href="#how-to-run-apache-cassandra-using-docker">How to run apache Cassandra using docker</a></li>
<li><a href="#datamodel-quick-checklist">Datamodel quick checklist</a></li>
<li><a href="#the-wide-partition-pattern">THE WIDE PARTITION PATTERN</a></li>
<li><a href="#cassandra-architecture---logical-components-24341">Cassandra Architecture - logical components (2+4+3+4+1)</a></li>
<li><a href="#cassandra-token-ring">Cassandra token ring</a></li>
<li><a href="#hinted-handoff">Hinted Handoff</a></li>
<li><a href="#conflict-free-replicated-data-type">Conflict-free replicated data type</a></li>
<li><a href="#what-is-anti-entropy-repair">What is anti-entropy repair?</a></li>
<li><a href="#merkle-tree-usage-in-cassandra">MERKLE TREE usage in Cassandra?</a></li>
<li><a href="#commit-log">Commit Log</a></li>
<li><a href="#comapaction-stragies-in-cassandra">Comapaction stragies in Cassandra</a></li>
<li><a href="#cassandra-under-the-hood">Cassandra under the hood</a></li>
<li><a href="#deletion-and-tombstones">Deletion and Tombstones</a></li>
<li><a href="#bloom-filter">Bloom Filter</a></li>
<li><a href="#cluster-topology-of-cassandra">cluster topology of Cassandra</a></li>
<li><a href="#cql---primary-key-and-clustering-key">CQL - Primary key and Clustering key</a></li>
<li><a href="#cqlsh---useful">CQLSH - useful</a></li>
<li><a href="#how-to-remove-node-using-nodetool">How to remove node using nodetool</a></li>
<li><a href="#cassandra-linux-limits">Cassandra linux limits</a></li>
<li><a href="#cassandra-troubleshoot-linux-commands">Cassandra troubleshoot linux commands</a></li>
<li><a href="#how-does-cassandra-topolgoy.properties-look-alike">How does cassandra-topolgoy.properties look alike</a></li>
<li><a href="#cassandra-client---features-datastax-driver-4.9.0">Cassandra Client - features (Datastax Driver 4.9.0)</a></li>
<li><a href="#cassandra-client---retry-failied-queries-if-node-failed">Cassandra Client - Retry Failied Queries (if node failed)</a></li>
<li><a href="#cassandra-client-side---speculative-execution">Cassandra Client side - SPECULATIVE EXECUTION</a></li>
<li><a href="#cassandra-client-side---connection-pooling">Cassandra Client side - CONNECTION POOLING</a></li>
<li><a href="#cassandra-client-side-driver-configuration">Cassandra Client side driver configuration</a></li>
<li><a href="#cassandra-client-datastax-driver-4.9.0---java-api">Cassandra Client (Datastax Driver 4.9.0) - Java API</a></li>
<li><a href="#cassandra-client-mapperentity-annotations">Cassandra Client Mapper/Entity Annotations</a></li>
<li><a href="#cassandra-client-datastax-driver-5.0---querybuilder-api-api">Cassandra Client (Datastax Driver 5.0) - QueryBuilder API API</a></li>
<li><a href="#cassandra-client-datastax-driver-5.0---async-api">Cassandra Client (Datastax Driver 5.0) - Async API</a></li>
<li><a href="#jdk-9---reactive-style-api">JDK 9 - Reactive style API</a></li>
<li><a href="#cassandra-write-path">Cassandra write path</a></li>
<li><a href="#cassandra-write-path---materialized-view">Cassandra write path - Materialized view</a></li>
<li><a href="#cassandra-writeread---consistency-cqls">Cassandra write/read - consistency CQLS</a></li>
<li><a href="#cassandra-failures-and-solutions">Cassandra failures and solutions</a></li>
<li><a href="#scaling-quotes">Scaling Quotes</a></li>
<li><a href="#performance-quotes">Performance Quotes</a></li>
<li><a href="#nodetool">Nodetool</a></li>
<li><a href="#building-cassandra">Building Cassandra</a></li>
<li><a href="#resources">Resources</a></li>
<li><a href="#follow-up-questions-for-cassandra">Follow-up questions for Cassandra</a></li>
<li><a href="#definitive-guide-references">Definitive Guide References</a></li>
<li><a href="#code">Code</a></li>
<li><a href="#how-to-create-anki-from-this-markdown-file">How to create anki from this markdown file</a></li>
<li><a href="#pre-requisite-for-this-tutorial-is-docker">Pre-requisite for this tutorial is docker</a></li>
<li><a href="#use-os-boxes-as-virtual-machine-to-install-cassandra">Use Os-boxes as virtual machine to install cassandra</a>
<ul>
<li><a href="#to-start-cassandra">To start Cassandra</a></li>
</ul></li>
<li><a href="#cassandra-cluster-using-apache-cassandra-wait-at-least-1-minute-between-successive-container-spin-off">Cassandra cluster using apache cassandra (Wait at-least 1 minute between successive container spin-off)</a></li>
<li><a href="#connect-to-cassandra-docker-cluster">Connect to cassandra docker cluster</a></li>
<li><a href="#run-commands-into-cassandra-docker-node">Run commands into cassandra docker node</a></li>
<li><a href="#via-docker-for-dse-server">Via docker for DSE server</a></li>
<li><a href="#setting-up-application-using-dse-image--running-cassandra-in-docker">Setting up application using DSE image -Running Cassandra in Docker</a></li>
<li><a href="#copy-files-into-and-out-of-containers">Copy files into and out-of containers</a></li>
<li><a href="#some-cassandra-commands">Some Cassandra commands</a></li>
<li><a href="#cassandra-directory-apache-cassandra">Cassandra directory (Apache Cassandra)</a></li>
<li><a href="#cassandra-stress-tool">Cassandra stress-tool</a></li>
<li><a href="#to-start-cqlsh">To start CQLSH</a></li>
<li><a href="#references">References</a>
<ul>
<li><a href="#nodetool-1">nodetool</a></li>
</ul></li>
<li><a href="#ring">Ring</a></li>
<li><a href="#when-a-new-node-joins-the-ring">When a new node joins the ring</a></li>
<li><a href="#driver">Driver</a></li>
<li><a href="#peer-to-peer">Peer-to-Peer</a></li>
<li><a href="#vnode">VNode</a>
<ul>
<li><a href="#why-vnode">Why Vnode?</a></li>
</ul></li>
<li><a href="#gossip-protocol">Gossip protocol</a>
<ul>
<li><a href="#what-is-gossiped">What is gossiped?</a></li>
</ul></li>
<li><a href="#snitch">Snitch</a>
<ul>
<li><a href="#property-file-snitch">Property File Snitch</a></li>
<li><a href="#gossiping-property-file-snitch">Gossiping Property File Snitch</a></li>
</ul></li>
<li><a href="#cassandra-replication">Cassandra replication</a></li>
<li><a href="#consistency">Consistency</a>
<ul>
<li><a href="#consistency-level-in-cassandra">Consistency level in Cassandra</a></li>
</ul></li>
<li><a href="#hinted-hand-off">Hinted hand-off</a></li>
<li><a href="#read-repair-assume-rf3">Read repair (Assume RF=3)</a>
<ul>
<li><a href="#read-repair-chance">Read Repair Chance</a></li>
</ul></li>
<li><a href="#node-repai">Node-repai</a>
<ul>
<li><a href="#nodetool-has-a-repair-tool-that-can-repair-entire-cluster---quite-expensive-operation">Nodetool has a repair tool that can repair entire cluster - Quite expensive operation</a></li>
</ul></li>
<li><a href="#datastax-node-sync">Datastax Node-sync</a></li>
<li><a href="#write-path">Write path</a></li>
<li><a href="#read-path">Read path</a></li>
<li><a href="#data-stax">Data-stax</a></li>
<li><a href="#compaction">Compaction</a>
<ul>
<li><a href="#compacting-partition">Compacting partition</a></li>
<li><a href="#compacting-sstables">Compacting SSTables</a></li>
<li><a href="#types-of-compaction">Types of compaction</a></li>
</ul></li>
<li><a href="#datastax-es6">Datastax ES6</a></li>
<li><a href="#reference">Reference</a></li>
<li><a href="#clustering-columns">Clustering Columns</a></li>
<li><a href="#primary-key">Primary Key</a></li>
<li><a href="#impact-of-partition-key-on-query-cql">Impact of partition key on query (CQL)</a></li>
<li><a href="#querying">Querying</a></li>
<li><a href="#cql">CQL</a></li>
<li><a href="#datastax-slides">Datastax slides</a></li>
<li><a href="#what-is-each_quorum">What is Each_Quorum</a></li>
<li><a href="#peformance-could-be-degraded-for-many-reasons">Peformance could be degraded for many reasons</a>
<ul>
<li><a href="#dropped-mutataions">Dropped Mutataions</a></li>
<li><a href="#configuration-that-affects-dropped-mutations">Configuration that affects dropped mutations</a></li>
</ul></li>
<li><a href="#when-does-cassandra-end-up-having-useless-data">When does Cassandra end up having useless data</a></li>
<li><a href="#usage-statistics-of-thread-pool---output">Usage statistics of thread-pool - output</a></li>
<li><a href="#what-is-d210-course-about">What is D210 Course about</a></li>
<li><a href="#what-are-basic-parameter-required-for-cassandra-quickstart">What are basic parameter required for Cassandra quickstart</a></li>
<li><a href="#what-is-the-location-of-default-cassandra.yaml">What is the location of default Cassandra.yaml?</a></li>
<li><a href="#what-are-two-file-systedm-that-should-be-separated">What are two file-systedm that should be separated</a></li>
<li><a href="#cluster-sizing">Cluster Sizing</a></li>
<li><a href="#cluster-sizing---writethrough-put-example">Cluster Sizing - Writethrough put example</a></li>
<li><a href="#cluster-sizing---read-throughput-example">Cluster Sizing - Read throughput example</a></li>
<li><a href="#cluster-sizing---monthly-calculate">Cluster-sizing - Monthly calculate</a></li>
<li><a href="#cluster-sizing---latency-calculate">Cluster-sizing - Latency calculate</a></li>
<li><a href="#cluster-sizing---probing-questions">Cluster Sizing - Probing Questions</a></li>
<li><a href="#cassandra-stress-tool-1">Cassandra stress tool</a></li>
<li><a href="#linux-top-command">Linux top command</a></li>
<li><a href="#linux-top-command---cassandra">Linux top command - Cassandra</a></li>
<li><a href="#linux-dstat-command-alternative-to-top">Linux dstat command (alternative to top)</a></li>
<li><a href="#nodetool-performance-analysis-inside-cluster-node">Nodetool (Performance Analysis inside cluster node)</a></li>
<li><a href="#nodetool-compaction-history---what-are-all-the-fields-and-output">Nodetool compaction-history - what are all the fields and output?</a></li>
<li><a href="#to-figure-out-the-name-of-a-nodes-datacenter-and-rack-which-nodetool-sub-command-should-you-use">To figure out the name of a node’s datacenter and rack, which nodetool sub-command should you use?</a></li>
<li><a href="#nodetool-gcstats">Nodetool gcstats</a></li>
<li><a href="#nodetool-gossipinfo">Nodetool Gossipinfo</a></li>
<li><a href="#nodetool-ring-command">Nodetool Ring command</a></li>
<li><a href="#nodetool-tableinfo-tablestats---quite-useful-for-data-modelling-information">Nodetool Tableinfo (tablestats) - Quite useful for data-modelling information</a></li>
<li><a href="#how-to-find-large-partition">How to find large partition?</a></li>
<li><a href="#nodetool-threadpoolinfo-tpstats">Nodetool Threadpoolinfo (tpstats)</a></li>
<li><a href="#cassandra-logging">Cassandra logging</a></li>
<li><a href="#cassandra-jvm-gc-logging">Cassandra JVM GC logging</a></li>
<li><a href="#how-cassandra-jvm-gc-logging-can-be-configured">How Cassandra JVM GC logging can be configured</a></li>
<li><a href="#how-to-read-gc.log">How to read GC.log?</a></li>
<li><a href="#adding-a-node">Adding a node</a></li>
<li><a href="#bootstrapping-adding-a-note">Bootstrapping (Adding a note)</a></li>
<li><a href="#what-are-the-steps-followed-by-a-boostrapping-node-when-joining">What are the steps followed by a boostrapping node when joining?</a></li>
<li><a href="#what-are-the-help-rendered-by-a-existing-node-to-a-joining">What are the help rendered by a existing node to a joining?</a></li>
<li><a href="#issues-during-bootstrap">Issues during bootstrap</a></li>
<li><a href="#if-bootstrap-fails">If Bootstrap fails</a></li>
<li><a href="#after-boostrap-cleanup">After Boostrap (Cleanup)</a></li>
<li><a href="#removing-node">Removing node</a></li>
<li><a href="#where-is-the-data-coming-from-when-a-node-is-removed">Where is the data coming from when a node is removed?</a></li>
<li><a href="#how-to-replace-a-down-node">How to replace a down-node</a></li>
<li><a href="#why-replace-a-node-than-removing-and-adding">Why replace a node than removing-and-adding?</a></li>
<li><a href="#stcs---size-tieres-compaction-strategy">STCS - Size Tieres Compaction Strategy</a></li>
<li><a href="#stcs-pros-and-disadvantage">STCS Pros and Disadvantage</a></li>
<li><a href="#what-triggers-a-stcs-compaction">What triggers a STCS Compaction</a></li>
<li><a href="#stcs---tombstones">STCS - Tombstones</a></li>
<li><a href="#lcs---leveled-compaction-strategy">LCS - Leveled Compaction Strategy</a></li>
<li><a href="#lcs-pros-and-cons">LCS Pros and Cons</a></li>
<li><a href="#lcs---lagging-behind">LCS - Lagging behind</a></li>
<li><a href="#leveledcompactionstrategy">LeveledCompactionStrategy</a></li>
<li><a href="#twcs---time-window-compaction-strategies">TWCS - Time-window compaction strategies</a></li>
<li><a href="#nodesync-datastax-enterprise-6.0">Nodesync (Datastax Enterprise 6.0)</a></li>
<li><a href="#what-are-all-the-possible-reason-for-large-sstable">What are all the possible reason for large SSTable</a></li>
<li><a href="#multi-datacenter">Multi-Datacenter</a></li>
<li><a href="#multi-datacenter-consistency-level">Multi-Datacenter Consistency Level</a></li>
<li><a href="#what-if-one-datacenter-goes-down">What if one datacenter goes down?</a></li>
<li><a href="#why-we-need-additional-dc">Why we need additional DC?</a></li>
<li><a href="#sstabledump">SSTableDump</a></li>
<li><a href="#sstableloader">SSTableloader</a></li>
<li><a href="#loading-different-formats-of-data-into-cassandra">Loading different formats of data into Cassandra</a></li>
<li><a href="#datstax---dse-bulk-configuration-should-be-in-hocon-format">Datstax - DSE Bulk (configuration should be in HOCON format)</a></li>
<li><a href="#backup-and-snapshots">Backup and Snapshots</a></li>
<li><a href="#what-is-cassandra-snapshots">What is Cassandra snapshots?</a></li>
<li><a href="#how-do-incrementa-backup-works">How do incrementa backup works</a></li>
<li><a href="#where-to-store-snapshots">Where to store snapshots?</a></li>
<li><a href="#how-truncate-works">How Truncate works?</a></li>
<li><a href="#how-to-snapshot">How to snapshot?</a></li>
<li><a href="#restore-we-get-1-point-for-backup-99-point-for-restore">Restore (We get 1 point for backup, 99 point for restore)</a></li>
<li><a href="#steps-to-restore-from-snapshots">Steps to restore from snapshots</a></li>
<li><a href="#jvm-settings">JVM settings</a></li>
<li><a href="#garbage-collections-apache-cassandra">Garbage Collections (Apache Cassandra)</a></li>
<li><a href="#why-does-full-gc-runs">Why does full GC runs?</a></li>
<li><a href="#how-to-troubleshoot-outofmemoryerror-issues-in-casssandra">How to troubleshoot OutOfMemoryError issues in Casssandra?</a></li>
<li><a href="#what-is-tsc">What is TSC?</a></li>
<li><a href="#tuning-the-linux-kernel">Tuning the Linux Kernel</a></li>
<li><a href="#what-should-be-removeddisabled-from-linux-for-cassandra-to-work-how-to-remove">What should be removed/disabled from Linux for Cassandra to work? How to remove</a></li>
<li><a href="#hardware-resources-to-consider">Hardware resources to consider</a></li>
<li><a href="#datastax-on-cloud">Datastax on Cloud</a></li>
<li><a href="#cassandra-on-cloud-challenges">Cassandra on Cloud Challenges</a></li>
<li><a href="#cassandra-on-cloud-security">Cassandra on cloud security</a></li>
<li><a href="#cassandra-security-considerations">Cassandra Security Considerations</a></li>
<li><a href="#what-is-the-default-security-configuration">What is the default security configuration</a></li>
<li><a href="#where-is-roles-are-stored-in-internal-scheme-in-default-scheme">Where is roles are stored in internal-scheme? (in default scheme)</a></li>
<li><a href="#cassandra-authentication-table-system_auth.roles---in-default-scheme">Cassandra Authentication table (system_auth.roles - in default scheme)</a></li>
<li><a href="#what-are-best-practices-for-cassandra-security">What are best practices for Cassandra security</a></li>
<li><a href="#cassandra-roleauthorization-management">Cassandra Role/Authorization management</a></li>
<li><a href="#cassandra-encryption-ssl">Cassandra encryption SSL</a></li>
<li><a href="#what-are-two-artifacts-required-for-cassandra-to-enable-ssl">What are two artifacts required for Cassandra to enable SSL</a></li>
<li><a href="#steps-for-ssl-setup-node-to-node">8 Steps for SSL setup (node-to-node)</a></li>
<li><a href="#how-to-harden-cassandra-security">How to harden Cassandra security</a></li>
<li><a href="#datastax-opscenter">Datastax OpsCenter</a></li>
<li><a href="#datastax-opscenter-cluster-monitoringalert">Datastax OpsCenter (Cluster Monitoring/Alert)</a></li>
<li><a href="#datastax-opscenter-management-service">Datastax OpsCenter (Management Service)</a></li>
<li><a href="#datastax-opscenter-backup-and-restore-service">Datastax OpsCenter (Backup and restore Service)</a></li>
<li><a href="#datastax-opscenter-lifecycle-manager-provisioning">Datastax OpsCenter LifeCycle Manager (Provisioning)</a></li>
<li><a href="#datastax-opscenter-nodesync">Datastax OpsCenter NodeSync</a></li>
<li><a href="#datastax-opscenter-other-features">Datastax OpsCenter other features</a></li>
<li><a href="#follow-up-course">Follow-up course</a></li>
<li><a href="#lab-notes">Lab notes</a></li>
<li><a href="#cassandra-people">Cassandra people</a></li>
<li><a href="#cassandra-production-error">Cassandra production error</a></li>
<li><a href="#server-side---com.datastax.oss.driver.api.core.connection.connectionintiexception..-ssl-should-be-configured">(Server side) - com.datastax.oss.driver.api.core.connection.ConnectionIntiException.. ssl should be configured</a></li>
<li><a href="#how-to-connect-to-cassandra-from-api">How to connect to Cassandra from API</a></li>
<li><a href="#to-setup-python">TO setup python</a></li>
<li><a href="#cluster-level-monitoring">Cluster level monitoring</a></li>
<li><a href="#top-worst-performing">Top worst performing</a></li>
<li><a href="#list-monitoring-elements">List monitoring elements</a></li>
<li><a href="#list-table-level">List table level</a></li>
<li><a href="#node-status">Node Status</a></li>
<li><a href="#nodetool-usage">Nodetool usage</a></li>
<li><a href="#nodetool-commands">Nodetool commands</a></li>
<li><a href="#repair-service-on-opscenter">Repair Service (on OpsCenter)</a></li>
<li><a href="#repair-command">Repair command</a></li>
<li><a href="#why-repairs-are-necessary">Why repairs are necessary?</a></li>
<li><a href="#repair-guideline">Repair guideline</a></li>
<li><a href="#what-is-primary-range-repair">What is Primary Range Repair?</a></li>
<li><a href="#how-does-repair-work">How does repair work?</a></li>
<li><a href="#events-that-trigger-repair">Events that trigger Repair</a></li>
<li><a href="#dropped-mutation-vs-repair">Dropped Mutation vs Repair</a></li>
<li><a href="#if-10-nodes-equally-sharing-data-with-rf3-if-we-try-to-repair-nodetool-repair-on-node-3-how-many-node-will-be-involved-in-repair">If 10 nodes equally sharing data with RF=3, if we try to repair ‘nodetool repair on node-3’, How many node will be involved in repair?</a></li>
<li><a href="#how-to-specifically-use-only-one-node-to-repair-itself">How to specifically use only one node to repair itself</a></li>
<li><a href="#if-we-run-full-repair-on-a-n-node-cluster-with-rf3-how-many-times-we-are-repairing-the-data">If we run full repair on a ‘n’ node cluster with RF=3, How many times we are repairing the data?</a></li>
<li><a href="#developer-who-maintainspresented-about-reaper">Developer who maintains/presented about Reaper</a></li>
<li><a href="#repair-documentation">Repair documentation</a></li>
<li><a href="#repair-and-some-number-related-to-time">Repair and some number related to time</a></li>
<li><a href="#what-are-reaper-settings">What are Reaper settings</a></li>
<li><a href="#reaper-is-predominantly-used-for-repair-tasks">Reaper is predominantly used for repair tasks</a></li>
<li><a href="#repair-related-commands">Repair related commands</a></li>
<li><a href="#reference-1">Reference</a></li>
<li><a href="#how-to-create-anki-from-this-markdown-file-2">How to create anki from this markdown file</a></li>
<li><a href="#create-keyspace-and-use-it">Create Keyspace (and use it)</a></li>
<li><a href="#create-table-and-loadexport-data-in-and-out-of-tables">Create TABLE and load/export data in and out-of-tables</a></li>
<li><a href="#how-to-select-token-values-of-primary-key">How to select token values of primary-key</a></li>
<li><a href="#cql-copy-and-rules">CQL Copy and rules</a></li>
<li><a href="#cql-copy-options">CQL Copy options</a></li>
<li><a href="#how-to-list-partition_key-or-the-actual-token-along-with-other-columns">How to list partition_key (or the actual token) along with other columns</a></li>
<li><a href="#gosspinfo">Gosspinfo</a></li>
<li><a href="#nodetool-getendpoints-killrvideo-videos_by_tag-cassandra">nodetool getendpoints killrvideo videos_by_tag cassandra</a></li>
<li><a href="#what-are-all-the-system-schema">What are all the System Schema</a></li>
<li><a href="#see-how-many-rows-have-been-written-into-this-table-warning---row-scans-are-expensive-operations-on-large-tables">See how many rows have been written into this table (Warning - row scans are expensive operations on large tables)</a></li>
<li><a href="#write-a-couple-of-rows-populate-different-columns-for-each-and-view-the-results">Write a couple of rows, populate different columns for each, and view the results</a></li>
<li><a href="#view-the-timestamps-generated-for-previous-writes">View the timestamps generated for previous writes</a></li>
<li><a href="#note-that-were-not-allowed-to-ask-for-the-timestamp-on-primary-key-columns">Note that we’re not allowed to ask for the timestamp on primary key columns</a></li>
<li><a href="#set-the-timestamp-on-a-write">Set the timestamp on a write</a></li>
<li><a href="#verify-the-timestamp-used">Verify the timestamp used</a></li>
<li><a href="#view-the-time-to-live-value-for-a-column">View the time to live value for a column</a></li>
<li><a href="#set-the-ttl-on-the-last-name-column-to-one-hour">Set the TTL on the last name column to one hour</a></li>
<li><a href="#view-the-ttl-of-the-last_name---counting-down">View the TTL of the last_name - (counting down)</a></li>
<li><a href="#find-the-token">Find the token</a></li>
<li><a href="#clear-the-screen-of-output-from-previous-commands">Clear the screen of output from previous commands</a></li>
<li><a href="#cassandra-dual-equivalent-table-and-sql">Cassandra Dual equivalent table and SQL</a></li>
<li><a href="#exit-cqlsh">Exit cqlsh</a></li>
<li><a href="#reference-2">Reference</a></li>
<li><a href="#storage-architecture">Storage Architecture</a></li>
<li><a href="#sstable---settings-in-cassandra.yaml">SStable - settings in cassandra.yaml</a></li>
<li><a href="#what-are-the-files-part-of-sstable">What are the files part of SSTable</a></li>
<li><a href="#what-is-the-role-of-index-file">What is the role of index file</a></li>
<li><a href="#what-is-the-role-of-statitics-file">What is the role of statitics file</a></li>
<li><a href="#why-sqlite4-didnt-use-lsm">Why SQLite4 didn’t use LSM?</a></li>
<li><a href="#lsm-pros-and-cons">LSM Pros and Cons</a></li>
<li><a href="#sstable-references">SSTable references</a></li>
<li><a href="#course-dse-installation">Course DSE installation</a></li>
<li><a href="#nodetool-vs-dsetool">Nodetool vs DSEtool</a></li>
<li><a href="#nodetool-gauge-the-server-performance">Nodetool Gauge the server performance</a></li>
<li><a href="#find-all-the-material-view-of-a-keyspace">Find all the material view of a keyspace</a></li>
<li><a href="#how-to-find-number-of-partitionsnode-of-partition-in-a-table">How to find number of partitions/node-of partition in a table</a></li>
<li><a href="#cassandra-node-servervmhw">Cassandra Node (Server/VM/H/W)</a></li>
<li><a href="#cassandra-ring-the-cluster">Cassandra Ring (The cluster)</a></li>
<li><a href="#how-new-nodes-join-the-ring">How new nodes join the ring</a></li>
<li><a href="#peer-to-peer-1">Peer-to-Peer</a></li>
<li><a href="#why-do-we-need-vnode">Why do we need VNode?</a></li>
<li><a href="#how-to-enable-vnode">How to enable VNode?</a></li>
<li><a href="#gossip-protocol-nodemeta-data-is-the-subject">Gossip protocol (nodemeta data is the subject)</a></li>
<li><a href="#what-do-nodes-gossip-about">What do nodes Gossip about?</a></li>
<li><a href="#what-is-gossip-data-structure-look-like">What is Gossip data structure look like?</a></li>
<li><a href="#what-is-gossip-protocol">What is Gossip protocol?</a></li>
<li><a href="#how-to-find-more-details-about-gossip">How to find more details about Gossip</a></li>
<li><a href="#sample-gossipinfo">Sample Gossipinfo</a></li>
<li><a href="#node-failure-detector">Node failure detector</a></li>
<li><a href="#snitch-meaning-informer">Snitch (meaning informer)</a></li>
<li><a href="#what-is-the-role-of-dynamicsnitch">What is the role of DynamicSnitch</a></li>
<li><a href="#mandatory-operational-practice">Mandatory operational practice</a></li>
<li><a href="#replication-with-rf1">Replication with RF=1</a></li>
<li><a href="#replication-with-rf2">Replication with RF&gt;=2</a></li>
<li><a href="#replication-with-rf2-and-cross-datacenter">Replication with RF&gt;=2 and Cross DataCenter</a></li>
<li><a href="#consistency-in-cql">Consistency in CQL</a></li>
<li><a href="#reference-3">Reference</a></li>
<li><a href="#time-series-presentations">Time-series presentations</a></li>
<li><a href="#what-are-all-the-majore-issues-due-to-tombstones">What are all the majore issues due to Tombstones</a></li>
<li><a href="#how-to-agressively-collect-tombstones-to-resolve-few-of-the-query-timeout-tactical-solution">How to agressively collect tombstones (to resolve few of the query timeout tactical solution)</a></li>
<li><a href="#where-is-tombstones-are-handled">Where is Tombstones are handled?</a></li>
<li><a href="#how-read-works">How read works?</a></li>
<li><a href="#read-repair-happens-only-when-clall">Read Repair (Happens only when CL=All)</a></li>
<li><a href="#read-repair-chance-when-cl-all-less-than-all-consistency-read">Read Repair Chance (when CL &lt; ALL) (less than ALL consistency read)</a></li>
<li><a href="#nodetool-repair">Nodetool repair</a></li>
<li><a href="#nodetool-sync-only-datastax">Nodetool Sync (only datastax)</a></li>
<li><a href="#nodetool-sync-save-points-only-datastax">Nodetool Sync Save points (only datastax)</a></li>
<li><a href="#nodetool-sync---segments-sizes">Nodetool Sync - Segments Sizes</a></li>
<li><a href="#nodetool-sync---segments-failures">Nodetool Sync - Segments failures</a></li>
<li><a href="#nodetool-sync---segments-validation">Nodetool Sync - Segments Validation</a></li>
<li><a href="#cassandra-write-path-inside-the-node-and-for-a-partition">Cassandra Write Path (inside the node, and for <em>a</em> partition)</a></li>
<li><a href="#cassandra-read-path-inside-the-node-and-for-particular-a-partition">Cassandra Read Path (inside the node, and for particular a partition)</a></li>
<li><a href="#cassandra-read-path-workflow">Cassandra Read Path workflow</a></li>
<li><a href="#bloom-filter-1">Bloom filter</a></li>
<li><a href="#datastax">Datastax</a></li>
<li><a href="#compaction-merging-ss-tables">Compaction (merging ss-tables)</a></li>
<li><a href="#compaction-strategies-based-on-use-case">Compaction Strategies (based on use-case)</a></li>
<li><a href="#advanced-peformance-gains-in-dse">Advanced Peformance Gains in (DSE)</a></li>
<li><a href="#before-and-after-flush">Before and after flush</a></li>
<li><a href="#sample-data-directory-wiht-with-bloom_filter_fp_chance-0.1">Sample data directory wiht WITH bloom_filter_fp_chance = 0.1;</a></li>
<li><a href="#sample-data-directory-wiht-with-bloom_filter_fp_chance-0.0001">Sample data directory wiht WITH bloom_filter_fp_chance = 0.0001;</a></li>
<li><a href="#sample-data-directory-wiht-with-bloom_filter_fp_chance-1.0-100-false-positive-allowed-no-filter-file">Sample data directory wiht WITH bloom_filter_fp_chance = 1.0; (100% false positive allowed… No filter file)</a></li>
<li><a href="#nodetool-cfstats">Nodetool CFStats</a></li>
<li><a href="#followup-questions">Followup questions</a></li>
<li><a href="#what-is-compaction-in-cassandra">What is compaction in Cassandra?</a></li>
<li><a href="#pre-requisite-for-compaction">Pre-requisite for Compaction</a></li>
<li><a href="#we-have-problem-with-two-nodes-with-large-number-of-compaction-pending-how-to-speed-up">We have problem with two nodes with large number of compaction pending, how to speed up?</a></li>
<li><a href="#reference-4">Reference</a></li>
<li><a href="#anti-patterns-in-the-cassandra">Anti-patterns in the Cassandra</a></li>
<li><a href="#important-spring-java-project">Important Spring Java project</a></li>
<li><a href="#jira-based-on-labels">JIRA based on labels</a></li>
<li><a href="#jira-features-in-cassandra">JIRA Features in Cassandra</a></li>
<li><a href="#cassandra-index">Cassandra index</a></li>
<li><a href="#famous-cassandra-articles">Famous Cassandra articles</a></li>
<li><a href="#analyze-cassandra-code">Analyze Cassandra code</a></li>
<li><a href="#k8ssandra">K8ssandra</a></li>
</ul>
<h2 id="rdbms-history">RDBMS history</h2>
<ul>
<li>IBM DB1 - IMS Hierarchical dbms - DBI/DB1 - Released in 1968</li>
<li>IBM DB2 - 1970 - “A Relational Model of Data for Large Shared Data Banks - Dr. Edgar F. Codd”</li>
<li>1979-DB2 (E.F Cod 1970s), RDBMS relational model (not working system, just theoratical model)</li>
<li>Traditionally RDBMS supports locks, locks helps to maintain consistency but reduces access/availability to others</li>
<li>Journal or WAL log files are used for rollback or atomic-commit in RDBMS, journal sometime switched of to increase performance</li>
<li>Codd provided a list of 12 rules (0-12, actually 13 :-)) in ComputerWorld Magazine in 1985 (15 years later from original paper)</li>
<li>ANSI SQL - 1986</li>
</ul>
<h2 id="rdbms-pros-and-cons">RDBMS Pros and cons</h2>
<ul>
<li>Pros : It works for most of the cases
<ul>
<li>SQL - Support</li>
<li>ACID - Transaction (A Transformation of State - Jim Gray)
<ul>
<li>Atomic (State A to State B - no in-between)</li>
<li>Consistency</li>
<li>Isolated - Force transactions to be serially executed. (If it doesn’t require consistency and atomic, it is possible to have isolated and parallel txns)</li>
<li>Durable - Never lost</li>
</ul></li>
</ul></li>
<li>Cons : Won’t work for massively web scale db</li>
</ul>
<h2 id="why-rdbms-is-successful">Why RDBMS is successful?</h2>
<ul>
<li>SQL</li>
<li>Atomic Transaction with ACID properties</li>
<li>Two-phase commit was marketted well (Co-ordinated txn)</li>
<li>Rich schema</li>
</ul>
<h2 id="how-rdbms-is-tuned">How RDBMS is tuned</h2>
<ul>
<li>Introduce Index</li>
<li>Master(write), Slave (many times only used for read)
<ul>
<li>Introduces replication and transaction issues</li>
<li>Introduces consistency issues</li>
</ul></li>
<li>Add more CPU, RAM - Vertical scaling</li>
<li>Partitioning/Sharding</li>
<li>Disable journaling</li>
</ul>
<h2 id="two-phase-commit-vs-compensation">Two-phase commit vs Compensation</h2>
<ul>
<li>Compensation
<ul>
<li>Writing off the transaction if it fails, deciding to discard erroneous transactions and reconciling later.</li>
<li>Retry failed operations later on notification.</li>
</ul></li>
<li>In a reservation system or a stock sales ticker, these are not likely to meet your requirements.</li>
<li>For other kinds of applications, such as billing or ticketing applications, this can be acceptable.</li>
<li>Starbucks Does Not Use Two-Phase Commit
<ul>
<li>https://www.enterpriseintegrationpatterns.com/ramblings/18_starbucks.html</li>
</ul></li>
</ul>
<h2 id="sharding-share-nothing">Sharding (Share nothing)</h2>
<ul>
<li>Rather keeping all customer in one table, divide up that single customer table so that each database has only some of the records, with their order preserved? Then, when clients execute queries, they put load only on the machine that has the record they’re looking for, with no load on the other machines.</li>
<li>How to shard?
<ul>
<li>Name-wise sharding issues like customer names that starts with “Q,J” will have less, whereas customer name starts with J, M and S may be busy</li>
<li>Shard by DOB, SSN, HASH</li>
</ul></li>
<li>Three basic strategies for determining shard structure
<ul>
<li>Feature-based shard or functional segmentation</li>
<li>Key-based sharding - one-way hash on a key data element and distribute data across machines according to the hash.</li>
<li>Lookup Table</li>
</ul></li>
</ul>
<h2 id="list-of-nosql-databases"><a href="http://nosql-database.org/">List of NoSQL databases</a></h2>
<ul>
<li>Key-Value stores - Oracle Coherence, Redis, and MemcacheD, Amazon’s Dynamo DB, Riak, and Voldemort.</li>
<li>Column stores - Cassandra, Hypertable, and Apache Hadoop’s HBase.</li>
<li>Document stores - MongoDB and CouchDB.</li>
<li>Graph databases - Blazegraph, FlockDB, Neo4J, and Polyglot</li>
<li>Object databases - db4o and InterSystems Caché</li>
<li>XML databases - Tamino from Software AG and eXist.</li>
</ul>
<h2 id="apache-cassandra---official-definition">Apache Cassandra - Official definition</h2>
<ul>
<li>“Apache Cassandra is an open source, distributed, decentralized, elastically scalable, highly available, fault-tolerant, tuneably consistent, row-oriented database. Cassandra bases its distribution design on Amazon’s Dynamo and its data model on Google’s Bigtable, with a query language similar to SQL”</li>
<li>Tuneably consistent (not Eventual Consisten as majority believes)</li>
</ul>
<h2 id="cassandra-features">Cassandra Features</h2>
<ul>
<li>CQL (Thrift API is completely removed in 3.x)
<ul>
<li>CQL also known as native-transport</li>
</ul></li>
<li>Secondary indexes</li>
<li>Materialized views</li>
<li>Lightweight transactions</li>
<li>Consistency = Replication factor + consistency level (delegated to clients)
<ul>
<li>Consistency level &lt;= replication factor</li>
</ul></li>
<li>Cassandra is not column-oriented (it is row oriented)</li>
<li>Column values are stored according to a consistent sort order, omitting columns that are not populated</li>
</ul>
<h2 id="what-are-all-consistency-forms">What are all Consistency Forms?</h2>
<ul>
<li>Strict (or Serial) Consistency or Strong (sequential consistency)
<ul>
<li>Works on Single CPU</li>
<li>“Rather than dealing with the uncertainty of the correctness of an answer, the data is made unavailable until it is absolutely certain that it is correct.”</li>
</ul></li>
<li>Casual Consistency (like Casuation)
<ul>
<li>Happens before</li>
<li>The cause of events to create some consistency in their order.</li>
<li>Writes that are potentially related must be read in sequence.</li>
<li>If two different, unrelated operations suddenly write to the same field, then those writes are inferred not to be causally related.</li>
</ul></li>
<li>Weak (or) Eventual Consistency
<ul>
<li>Rather than dealing with the uncertainty of the correctness of an answer, the data is made unavailable until it is absolutely certain that it is correct</li>
<li>Eventual consisteny (matter of milli-seconds)</li>
</ul></li>
</ul>
<h2 id="strong-consistency-in-cassandra">Strong consistency in Cassandra</h2>
<ul>
<li>R + W &gt; RF = Strong consistency</li>
<li>In this equation, R, W, and RF are the read replica count, the write replica count, and the replication factor, respectively;</li>
</ul>
<h2 id="row-oriented-data-store">Row-Oriented data store</h2>
<ul>
<li>Cassandra’s data model can be described as a partitioned row store, in which data is stored in sparse multidimensional hashtables.</li>
<li>“Sparse” means that for any given row you can have one or more columns, but each row doesn’t need to have all the same columns as other rows like it (as in a relational model).</li>
<li>“Partitioned” means that each row has a unique key which makes its data accessible, and the keys are used to distribute the rows across multiple data stores.</li>
</ul>
<h2 id="always-writeable">Always writeable</h2>
<ul>
<li>A design approach must decide whether to resolve these conflicts at one of two possible times: during reads or during writes. That is, a distributed database designer must choose to make the system either always readable or always writable. Dynamo and Cassandra choose to be always writable, opting to defer the complexity of reconciliation to read operations, and realize tremendous performance gains. The alternative is to reject updates amidst network and server failures.</li>
<li>CAP Theorem
<ul>
<li>Choose any two (of threee)</li>
<li>Cassandra assumes that network partitioning is unavoidable, hence it lets us deal only with availability and consistency.</li>
<li>CAP placement is independent of the orientation of the data storage mechanism</li>
<li>CAP theorem database mapping
<ul>
<li>AP - ?
<ul>
<li>To primarily support availability and partition tolerance, your system may return inaccurate data, but the system will always be available, even in the face of network partitioning. DNS is perhaps the most popular example of a system that is massively scalable, highly available, and partition tolerant.</li>
</ul></li>
<li>CP - ?
<ul>
<li>To primarily support consistency and partition tolerance, you may try to advance your architecture by setting up data shards in order to scale. Your data will be consistent, but you still run the risk of some data becoming unavailable if nodes fail.</li>
</ul></li>
<li>CA - ?
<ul>
<li>To primarily support consistency and availability means that you’re likely using two-phase commit for distributed transactions. It means that the system will block when a network partition occurs, so it may be that your system is limited to a single data center cluster in an attempt to mitigate this. If your application needs only this level of scale, this is easy to manage and allows you to rely on familiar, simple structures.</li>
</ul></li>
</ul></li>
</ul></li>
</ul>
<h2 id="notable-tools">Notable tools</h2>
<ul>
<li>Sstableloader - Bulk loader</li>
<li>Leveled compaction strategy - for faster reads</li>
<li>Atomic batches</li>
<li>Lightweight transactions were added using the Paxos consensus protocol</li>
<li>User-defined functions</li>
<li>Materialized views (sometimes also called global indexes)</li>
</ul>
<h2 id="few-use-cases">Few use cases</h2>
<ul>
<li>Cassandra has been used to create a variety of applications, including a windowed time-series store, an inverted index for document searching, and a distributed job priority queue.</li>
</ul>
<h2 id="updated-cap---brewers-theorem">Updated CAP - Brewer’s Theorem</h2>
<ul>
<li>Brewer now describes the “2 out of 3” axiom as somewhat misleading.</li>
<li>He notes that designers only need sacrifice consistency or availability in the presence of partitions. And that advances in partition recovery techniques have made it possible for designers to achieve high levels of both consistency and availability.</li>
</ul>
<h2 id="what-is-the-alternative-for-two-phase-commit">What is the alternative for Two-phase commit</h2>
<ul>
<li>Compensation or compensatory action</li>
<li>Writing off the tranaction if it fails, deciding to discard erroneous transactions and reconciling later
<ul>
<li>Won’t work on trading or reservation system</li>
</ul></li>
<li>Retry failed operation later on notification</li>
<li>“Starbucks does not use Two-phase commit” - Gregor Hohpe</li>
</ul>
<h2 id="how-to-horizontally-scale-rdbms-shard">How to horizontally scale RDBMS (shard)</h2>
<ul>
<li>Shard the database, (key for sharding is important)</li>
<li>Split the customer based on name (few letter has less load) or according to phone-number or dob</li>
<li>Host all the data that begins with certain letter in different database</li>
<li>Shard users in one database, items in another database</li>
</ul>
<h2 id="there-are-three-basic-strategies-for-determining-shard-structure">There are three basic strategies for determining shard structure:</h2>
<ul>
<li>Feature-based shard or functional segmentation
<ul>
<li>Shard users in one database, items in another database</li>
</ul></li>
<li>Key-based sharding
<ul>
<li>Hash based sharding</li>
<li>time-based on numeri-ckeys to hash on</li>
</ul></li>
<li>Lookup table
<ul>
<li>Make one of the noe as “Yellow-pages”, look-up for information about where the data stored</li>
</ul></li>
</ul>
<h2 id="shared-nothing">Shared nothing</h2>
<ul>
<li>Sharding could be termed a kind of shared-nothing architecture that’s specific to databases</li>
<li>Shared-nothing - no primary or no-secondary</li>
<li>Every node is independent</li>
<li>No centralized shared state</li>
<li>Cassandra (key-based sharding) and MongoDB - Autho sharding database</li>
</ul>
<h2 id="new-sql-scalable-acid-transactions">New SQL (Scalable ACID transactions)</h2>
<ul>
<li>Calvin transaction protocol vs Google’s Spanner paper</li>
<li>FaunaDB is an example of a database that implements the approach on the Calvin paper</li>
</ul>
<h2 id="cassandra-features-1">Cassandra features</h2>
<ul>
<li>It uses gossip protcol (feature of peer-to-peer architecture) to maintain details of other nodes.</li>
<li>It allows tunable cosistency and client can decide for each write/read (how many RF?)</li>
<li>It is possible to remove one column value alone in Cassandra</li>
</ul>
<h2 id="cap-theorem-brewers-theorem">Cap Theorem (Brewer’s theorem)</h2>
<ul>
<li>CAP - Choose two (as of 2000)</li>
<li>Network issue would certainly happens, hence network partition failures is un-avoidable, And should be handled. Hence choose between compromise on A or C (Availablity or consistency)</li>
<li>CA - MySQL, Postgres, SQL</li>
<li>CP - Neo4j, MongoDB, HBase, BigTable</li>
<li>AP - DNS, Cassandra, Amazon Dynamo</li>
</ul>
<h2 id="cassandra-lightweight-transaction-lwt---linearizable-consistency">Cassandra Lightweight transaction (LWT) - Linearizable consistency</h2>
<ul>
<li>Ensure there are not operation between read and write</li>
<li>Example: Check if user exist, if not create user (don’t overwrite in between)</li>
<li>Example: Update the value if and only if the value is X (Check-and-set)</li>
<li>LWT is based on Paxos algorithm (and it is better than two-phase commit)</li>
</ul>
<h2 id="row-oriented-wide-column-store">Row-Oriented (Wide column store)</h2>
<ul>
<li>Partitioned row store - sparse multidimensional hash tables</li>
<li>Partitioned - means that each row has a unique partition key used to distribute the rows across multiple data stores.</li>
<li>Sparse - not all rows has same number of columns</li>
<li>Cassandra stores data in a multidimensional, sorted hash table.</li>
<li>As data is stored in each column, it is stored as a separate entry in the hash table.</li>
<li>Column values are stored according to a consistent sort order, omitting columns that are not populated.</li>
</ul>
<h2 id="cassandra---schema-free">Cassandra - schema free?</h2>
<ul>
<li>Started as schema free using Thrift API, later CQL was introduced</li>
<li>No! Till 2.0 CQL and Thrit API co-exist, It was known as “Schema Optional”</li>
<li>From 3.0, Thrift API is deprecated, and from 4.0 Thrif API is removed</li>
<li>Additional values for columns can be added using List, Sets and Maps
<ul>
<li>Now-a-days it is considered flexible-schema</li>
</ul></li>
<li>Schema free -&gt; “Optional Schema” -&gt; “Flexible Schema”</li>
</ul>
<h2 id="cassandra---use-cases">Cassandra - use-cases?</h2>
<ul>
<li>Storing user activity updates</li>
<li>Social network usage, recommendations/reviews,</li>
<li>Application statistics</li>
<li>Inverted index for document searching</li>
<li><del>Distributed job priority queue</del> (queues are not recommended anymore)</li>
<li>Ability to handle application workloads that require high performance at significant write volumes with many concurrent client threads is one of the primary features of Cassandra.</li>
</ul>
<h2 id="cassandra-directories">Cassandra directories</h2>
<ul>
<li>/opt/cassadra/bin</li>
<li>/opt/cassadra/bin/cassandra -f –run the process in foreground for debug print and learning..</li>
<li>/opt/cassadra/conf/cassandra.yaml</li>
<li>/var/lib/cassandra/hints/</li>
<li>/var/lib/cassandra/saved_caches/</li>
<li>/var/lib/cassandra/data/</li>
<li>/var/lib/cassandra/commitlog/</li>
<li>/var/log/cassandra/system.log</li>
<li>/var/log/cassandra/debug.log</li>
</ul>
<h2 id="cassandra-directories-and-files">Cassandra directories and files</h2>
<ul>
<li>$CASSANDRA_HOME/data/commitlog
<ul>
<li>CommitLog-<version><timestamp>.log</li>
<li>CommitLog-7-1566780133999.log</li>
</ul></li>
<li>1-SSTable has multiple files
<ul>
<li>SSTable stored under - $CASSANDRA_HOME/data/data</li>
</ul></li>
</ul>
<h2 id="cassandra-run-time-properties">Cassandra run-time properties</h2>
<ul>
<li>-Dcassandra-foreground=yes</li>
<li>-Dcassandra.jmx.local.port=7199</li>
<li>-Dcassandra.libjemalloc=/usr/local/lib/libjemalloc.so</li>
<li>-Dcassandra.logdir=/opt/cassandra/logs</li>
<li>-Dcassandra.storagedir=/opt/cassandra/data</li>
<li>-Dcom.sun.management.jmxremote.authenticate=false</li>
<li>-Dcom.sun.management.jmxremote.password.file=/etc/cassandra/jmxremote.password</li>
<li>-Djava.library.path=/opt/cassandra/lib/sigar-bin</li>
<li>-Djava.net.preferIPv4Stack=true</li>
<li>-Dlogback.configurationFile=logback.xml</li>
<li>-XX:GCLogFileSize=10M</li>
<li>-XX:OnOutOfMemoryError=kill</li>
<li>-XX:StringTableSize=1000003</li>
<li>/opt/java/openjdk/bin/java</li>
</ul>
<h2 id="cassandra-cqlsh">Cassandra cqlsh</h2>
<ul>
<li><p>Object names are in snake_case. Cassandra converts into lower_case by default, double quote to override</p></li>
<li><p>bin/cqlsh localhost 9042</p></li>
<li><p><code>sql       show version;       describe cluster;        create keyspace sample_ks with replication = {'class': 'SimpleStrategy', 'replication_factor': 1};       use sample_ks;       DESCRIBE KEYSPACES;       describe keyspace sample_ks;       describe keyspace system;       create table user ( first_name text, last_name text, title text, PRIMARY KEY(last_name, first_name) );       describe table user;       insert into user(first_name, last_name, title) values  ('Mohan', 'Narayanaswamy', 'Developer');       select * from user where first_name='Mohan' and last_name = 'Narayanaswamy';       select * from user where first_name='Mohan';       --* InvalidRequest: Error from server: code=2200 [Invalid query] message="Cannot execute this query as it might involve data filtering and hus may have unpredictable performance. If you want to execute this query despite the performance unpredictability, use ALLOW FILTERING"       select count(*) from user; --Aggregation query used without partition key       delete title from user where last_name='Narayanaswamy' and first_name='Mohan';  --one column alone       delete from user where last_name='Narayanaswamy' and first_name='Mohan';  --entire row deletion</code></p></li>
</ul>
<h2 id="how-to-run-apache-cassandra-using-docker">How to run apache Cassandra using docker</h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> pull cassandra</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> network create cass-network</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> run <span class="at">-d</span> <span class="at">--name</span> apc1 <span class="at">--network</span> cass-network cassandra</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> run <span class="at">-d</span> <span class="at">--name</span> apc2 <span class="at">--network</span> cass-network cassandra</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co">#docker run --name  my-cassandra -p 9042:9042 -p 7000:7000 --network host -d cassandra:latest</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> exec <span class="at">-it</span> apc2 cqlsh</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> stop apc2</span></code></pre></div>
<h2 id="datamodel-quick-checklist">Datamodel quick checklist</h2>
<ul>
<li>All the possible important query that needs to satisfied should be considered before design</li>
<li>Minimize the number of partitions that must be searched to satisfy a given query</li>
<li>Growing number of tombstones begins to degrade read performance. Data-model should account to minmize it</li>
<li>Partition-size = Nv=Nr(Nc−Npk−Ns)+Ns (hard-limit 2 billion, in-general 100K)</li>
<li>in Cassandra - everything is distributed hashmap despite they look like relational-model</li>
<li>Joins are not supported and should be discouraged in Cassandra</li>
<li>NO REFERENTIAL INTEGRITY - supported in Cassandra (or any nosql)</li>
</ul>
<h2 id="the-wide-partition-pattern">THE WIDE PARTITION PATTERN</h2>
<ul>
<li>group multiple related rows in a partition in order to support fast access to multiple rows within the partition in a single query.</li>
<li>Cassandra can put tremendous pressure on the java heap and garbage collector, impact read latencies, and can cause issues ranging from load shedding and dropped messages to crashed and downed nodes.</li>
</ul>
<h2 id="cassandra-architecture---logical-components-24341">Cassandra Architecture - logical components (2+4+3+4+1)</h2>
<ul>
<li>Network topology, Peer-to-peer</li>
<li>Gossip, repair, hinted handoff, and lightweight transactions</li>
<li>Reading, writing, and deleting data</li>
<li>Data-structures of memtable, commit-logs, caches and SSTables</li>
<li>LWW-Element-Set (Last-Write-Wins-Element-Set) and no-reconciliation</li>
</ul>
<h2 id="cassandra-token-ring">Cassandra token ring</h2>
<ul>
<li>Tokens range from -2^63 to 2^63 - 1</li>
<li>Every node owns multiple token (and it’s token ranges)</li>
<li>TR - Token range of token t is - x &gt; TR &lt; t
<ul>
<li>x and t are two successive tokens</li>
<li>Range of values less than or equal to each token and greater than the last token of the previous node</li>
</ul></li>
<li>The node with the lowest token owns the range less than or equal to its token and the range greater than the highest token, which is also known as the wrapping range</li>
<li>Early version of Cassandra node has only one token (one TR), nowadays it has 256 token for each node (256 virutal nodes)</li>
<li>Larger machine can have more than 256 by modifying num_tokens@cassandra.yaml</li>
<li>Partitioner :: partition_key -&gt; token (clustering key is not used by partitioner)</li>
<li>Partitioner can’t be changed after initializing a cluster. Cassandra uses MurMurPartitioner since 1.2</li>
</ul>
<h2 id="hinted-handoff">Hinted Handoff</h2>
<ul>
<li>Acts like JMS MQ, till message is delivered</li>
<li>But message is deleted after 3 hours (should be consumed within that)</li>
</ul>
<h2 id="conflict-free-replicated-data-type">Conflict-free replicated data type</h2>
<ul>
<li>To resolve conflicts, system can use the Last-Writer-Wins Register</li>
<li>Which keeps only the last updated value when merging diverged data sets.</li>
<li>Cassandra uses this strategy to resolve conflicts.</li>
<li>We need to be very cautious when using this strategy because it drops changes that occurred in the meantime.</li>
</ul>
<h2 id="what-is-anti-entropy-repair">What is anti-entropy repair?</h2>
<ul>
<li>Replica synchronization mechanism for ensuring that data on different nodes is updated to the newest version.</li>
<li>Replica synchronization as well as hinted handoff.</li>
<li>Project Voldemort also uses read-repair similar to Cassandra (not anti-entropy repair)</li>
</ul>
<h2 id="merkle-tree-usage-in-cassandra">MERKLE TREE usage in Cassandra?</h2>
<ul>
<li>The advantage MERKLE TREE usage is that it reduces network I/O.</li>
<li>Used to ensure that the peer-to-peer network of nodes receives data blocks unaltered and unharmed.</li>
<li>Each table has its own Merkle tree; the tree is created as a snapshot during a validation compaction,</li>
<li>MerkleTree is kept only as long as is required to send it to the neighboring nodes on the ring.</li>
</ul>
<h2 id="commit-log">Commit Log</h2>
<ul>
<li>Only one commit log for entire server</li>
<li>Commit log shares across multiple table</li>
<li>All writes to all tables will go into the same commit log</li>
<li>Ther is a bit for flush_bit for each table in commit log (1 - flush_required, 0 - flush-not-required)</li>
<li>Throw more memory to reduce false-positives</li>
</ul>
<h2 id="comapaction-stragies-in-cassandra">Comapaction stragies in Cassandra</h2>
<ul>
<li>SizeTieredCompactionStrategy (STCS) is the default compaction strategy and is recommended for write-intensive tables.</li>
<li>LeveledCompactionStrategy (LCS) is recommended for read-intensive tables.</li>
<li>TimeWindowCompactionStrategy (TWCS) is intended for time series or otherwise date-based data.</li>
<li>Anticompaction - Split SSTable with one containing repaied data and other containing unrepaired data</li>
</ul>
<h2 id="cassandra-under-the-hood">Cassandra under the hood</h2>
<ul>
<li><a href="https://issues.apache.org/jira/browse/CASSANDRA-8099">Refactor and modernize the storage engine</a></li>
<li><a href="https://issues.apache.org/jira/browse/CASSANDRA-6477">Materialized Views (was: Global Indexes)</a></li>
<li><a href="https://issues.apache.org/jira/browse/CASSANDRA-13474">Cassandra pluggable storage engine</a></li>
</ul>
<h2 id="deletion-and-tombstones">Deletion and Tombstones</h2>
<ul>
<li>Nodes that was down when records deleted should have mechanism, hence tombstones</li>
<li>Tombstones can be configured using gc_grace_seconds (garbage collection grace seconds)</li>
<li>gc_grace_seconds = 864000 seconds ( 10 days)</li>
</ul>
<h2 id="bloom-filter">Bloom Filter</h2>
<ul>
<li>SSTable is not good when key that is not available in a table is queried</li>
<li>Without bloomfilter, Cassandra read-path would query multiple files (sgements) to confirm a key is absent. It queries latest to oldest before confirming lack of key.</li>
<li>Used to reduce disk access</li>
<li>Used in Hadoop, Bigtable, Squid Proxy Cache (and many big-data systems)</li>
<li>False-negative is not possible, but falst-positive is possible</li>
<li>if bloom-filter conveys data is not available, if it is not avialble. But it might return ‘may be available’, it may not be available.</li>
</ul>
<h2 id="cluster-topology-of-cassandra">cluster topology of Cassandra</h2>
<ul>
<li>Cassandra cluster topology is the arrangement of the nodes (dcs, racs, etc.) and communication network between them.</li>
<li>Snitch teaches Cassandra enough about your network topology</li>
<li>cassandra-topology.properties can be used to configure topology details</li>
</ul>
<h2 id="cql---primary-key-and-clustering-key">CQL - Primary key and Clustering key</h2>
<pre><code>PRIMARY KEY ((&quot;k1&quot;, &quot;k2&quot;), &quot;c1&quot;, &quot;c2&quot;), ) WITH CLUSTERING ORDER BY (&quot;c1&quot; DESC, &quot;c2&quot; DESC);</code></pre>
<h2 id="cqlsh---useful">CQLSH - useful</h2>
<ul>
<li><p>CQL would use Murmur3 partitioner</p></li>
<li><p>Minimum token is -9223372036854775808 (and maximum token is 9223372036854775808).</p></li>
<li><p><code>sql          cassandra@cqlsh:system_schema&gt;          DESCRIBE CLUSTER;          DESCRIBE KEYSPACES;          DESCRIBE TABLES;          SELECT * FROM system_schema.keyspaces;          desc KEYSPACE Keyspace_Name;          select token(key), key, my_column from mytable where token(key) &gt;= %s limit 10000;</code></p></li>
</ul>
<h2 id="how-to-remove-node-using-nodetool">How to remove node using nodetool</h2>
<ul>
<li>Decommission - Streams data from the leaving node (prefered and guaranteed consistency as if it started)</li>
<li>Removenode - Streams data from any available node that owns the range</li>
<li>assassinate - Forcefully remove a dead node without re-replicating any data. Use as a last resort if you cannot removenode</li>
</ul>
<h2 id="cassandra-linux-limits">Cassandra linux limits</h2>
<ul>
<li>if cassandra has 30 sstables, it would use 30 * 6 - 180 file handles</li>
<li>XX:MaxDirectMemorySize - we can set off-heap memory (outside JVM on OS)</li>
</ul>
<h2 id="cassandra-troubleshoot-linux-commands">Cassandra troubleshoot linux commands</h2>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> /proc/cass_proc_id/limits <span class="kw">|</span> <span class="fu">grep</span> files</span></code></pre></div>
<h2 id="how-does-cassandra-topolgoy.properties-look-alike">How does cassandra-topolgoy.properties look alike</h2>
<div class="sourceCode" id="cb4"><pre class="sourceCode txt"><code class="sourceCode default"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a># datacenter One</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>175.56.12.105=DC1:RAC1</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>175.50.13.200=DC1:RAC1</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>175.54.35.197=DC1:RAC1</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>120.53.24.101=DC1:RAC2</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>120.55.16.200=DC1:RAC2</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>120.57.102.103=DC1:RAC2</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a># datacenter Two</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>110.56.12.120=DC2:RAC1</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>110.50.13.201=DC2:RAC1</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>110.54.35.184=DC2:RAC1</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>50.33.23.120=DC2:RAC2</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>50.45.14.220=DC2:RAC2</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>50.17.10.203=DC2:RAC2</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a># Analytics Replication Group</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>172.106.12.120=DC3:RAC1</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>172.106.12.121=DC3:RAC1</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>172.106.12.122=DC3:RAC1</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a># default for unknown nodes </span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>default=DC3:RAC1</span></code></pre></div>
<h2 id="cassandra-client---features-datastax-driver-4.9.0">Cassandra Client - features (Datastax Driver 4.9.0)</h2>
<ul>
<li><code>xml          &lt;groupId&gt;com.datastax.oss&lt;/groupId&gt;         &lt;artifactId&gt;java-driver-query-builder&lt;/artifactId&gt;         &lt;artifactId&gt;java-driver-core&lt;/artifactId&gt;         &lt;artifactId&gt;java-driver-mapper-processor&lt;/artifactId&gt;         &lt;artifactId&gt;java-driver-mapper-runtime&lt;/artifactId&gt;</code></li>
<li>CqlSession maintains TCP connections to multiple nodes, it is a heavyweight object. Reuse it</li>
<li>Prefer file based client side driver configuration</li>
<li>PreparedStatements also improve security by separating the query logic of CQL from the data.</li>
<li>Prepared statements were stored in a cache, but beginning with the 3.10 release, each Cassandra node stores prepared statements in a local table so that they are present if the node goes down and comes back up.</li>
<li>Client side loadbalancing can be configured
<ul>
<li>RoundRobin/Token awareness/Data center awareness</li>
</ul></li>
<li>Driver should deal with node failures, hence we can also configure retry mechnism<br />
</li>
<li>CQL native protocol is asynchronous</li>
<li>Compression can be enabled between client and server</li>
<li>Security can be configured between client and server</li>
<li>Deifferent profiles can be configured between invocation by the same client</li>
</ul>
<h2 id="cassandra-client---retry-failied-queries-if-node-failed">Cassandra Client - Retry Failied Queries (if node failed)</h2>
<ul>
<li>ExponentialReconnectionPolicy vs ConstantReconnectionPolicy</li>
<li>onReadTimeout(), onWriteTimeout(), and onUnavailable()</li>
<li>The RetryPolicy operations return a RetryDecision</li>
</ul>
<h2 id="cassandra-client-side---speculative-execution">Cassandra Client side - SPECULATIVE EXECUTION</h2>
<ul>
<li>The driver can preemptively start an additional execution of the query against a different coordinator node.</li>
<li>When one of the queries returns, the driver provides that response and cancels any other outstanding queries.</li>
<li>ConstantSpeculativeExecutionPolicy</li>
</ul>
<h2 id="cassandra-client-side---connection-pooling">Cassandra Client side - CONNECTION POOLING</h2>
<ul>
<li>Default single connection per node</li>
<li>128 simultaneous requests in protocol - v2</li>
<li>32768 simultaneous requests in protocol - v3</li>
<li>1024 - Default maximum number of simultaneous requests per connection.</li>
</ul>
<h2 id="cassandra-client-side-driver-configuration">Cassandra Client side driver configuration</h2>
<div class="sourceCode" id="cb5"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="er">datastax-java-driver</span> <span class="fu">{</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="er">basic</span> <span class="er">{</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="er">contact-points</span> <span class="er">=</span> <span class="er">[</span> <span class="dt">&quot;127.0.0.1:9042&quot;</span><span class="fu">,</span> <span class="dt">&quot;127.0.0.2:9042&quot;</span> <span class="er">]</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="er">session-keyspace</span> <span class="er">=</span> <span class="er">reservation</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<h2 id="cassandra-client-datastax-driver-4.9.0---java-api">Cassandra Client (Datastax Driver 4.9.0) - Java API</h2>
<div class="sourceCode" id="cb6"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>CqlSession cqlSession <span class="op">=</span> CqlSession<span class="op">.</span><span class="fu">builder</span><span class="op">()</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">addContactPoint</span><span class="op">(</span><span class="kw">new</span> <span class="bu">InetSocketAddress</span><span class="op">(</span><span class="st">&quot;127.0.0.1&quot;</span><span class="op">,</span> <span class="dv">9042</span><span class="op">))</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">withKeyspace</span><span class="op">(</span><span class="st">&quot;reservation&quot;</span><span class="op">)</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">withLocalDatacenter</span><span class="op">(</span><span class="st">&quot;&lt;data center name&gt;&quot;</span><span class="op">)</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">build</span><span class="op">()</span></span></code></pre></div>
<h2 id="cassandra-client-mapperentity-annotations">Cassandra Client Mapper/Entity Annotations</h2>
<ul>
<li><span class="citation" data-cites="Mapper">@Mapper</span></li>
<li><span class="citation" data-cites="Select">@Select</span></li>
<li><span class="citation" data-cites="Insert">@Insert</span></li>
<li><span class="citation" data-cites="Delete">@Delete</span></li>
<li><span class="citation" data-cites="Query">@Query</span></li>
</ul>
<h2 id="cassandra-client-datastax-driver-5.0---querybuilder-api-api">Cassandra Client (Datastax Driver 5.0) - QueryBuilder API API</h2>
<div class="sourceCode" id="cb7"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>Select reservationSelect <span class="op">=</span>  <span class="fu">selectFrom</span><span class="op">(</span><span class="st">&quot;reservation&quot;</span><span class="op">,</span> <span class="st">&quot;reservations_by_confirmation&quot;</span><span class="op">)</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">all</span><span class="op">()</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">whereColumn</span><span class="op">(</span><span class="st">&quot;confirm_number&quot;</span><span class="op">).</span><span class="fu">isEqualTo</span><span class="op">(</span><span class="st">&quot;RS2G0Z&quot;</span><span class="op">);</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>SimpleStatement reseravationSelectStatement <span class="op">=</span> reservationSelect<span class="op">.</span><span class="fu">build</span><span class="op">()</span></span></code></pre></div>
<h2 id="cassandra-client-datastax-driver-5.0---async-api">Cassandra Client (Datastax Driver 5.0) - Async API</h2>
<ul>
<li>CQL native protocol is asynchronous</li>
<li></li>
</ul>
<div class="sourceCode" id="cb8"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>      CompletionStage<span class="op">&lt;</span>AsyncResultSet<span class="op">&gt;</span> resultStage <span class="op">=</span>  cqlSession<span class="op">.</span><span class="fu">executeAsync</span><span class="op">(</span>statement<span class="op">);</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Load the reservation by confirmation number</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>      CompletionStage<span class="op">&lt;</span>AsyncResultSet<span class="op">&gt;</span> selectStage <span class="op">=</span> session<span class="op">.</span><span class="fu">executeAsync</span><span class="op">(</span><span class="st">&quot;SELECT * FROM reservations_by_confirmation WHERE confirm_number=RS2G0Z&quot;</span><span class="op">);</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Use fields of the reservation to delete from other table</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>      CompletionStage<span class="op">&lt;</span>AsyncResultSet<span class="op">&gt;</span> deleteStage <span class="op">=</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>        selectStage<span class="op">.</span><span class="fu">thenCompose</span><span class="op">(</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>          resultSet <span class="op">-&gt;</span> <span class="op">{</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>            Row reservationRow <span class="op">=</span> resultSet<span class="op">.</span><span class="fu">one</span><span class="op">();</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> session<span class="op">.</span><span class="fu">executeAsync</span><span class="op">(</span>SimpleStatement<span class="op">.</span><span class="fu">newInstance</span><span class="op">(</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>              <span class="st">&quot;DELETE FROM reservations_by_hotel_date WHERE hotel_id = ? AND</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>                start_date <span class="op">=</span> <span class="op">?</span> AND room_number <span class="op">=</span> <span class="op">?</span><span class="st">&quot;,</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>              reservationRow<span class="op">.</span><span class="fu">getString</span><span class="op">(</span><span class="st">&quot;confirm_number&quot;</span><span class="op">),</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>              reservationRow<span class="op">.</span><span class="fu">getLocalDate</span><span class="op">(</span><span class="st">&quot;start_date&quot;</span><span class="op">),</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>              reservationRow<span class="op">.</span><span class="fu">getInt</span><span class="op">(</span><span class="st">&quot;room_number&quot;</span><span class="op">));</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>          <span class="op">});</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Check results for success</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>      deleteStage<span class="op">.</span><span class="fu">whenComplete</span><span class="op">(</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>          <span class="op">(</span>resultSet<span class="op">,</span> error<span class="op">)</span> <span class="op">-&gt;</span> <span class="op">{</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>error <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>              <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">printf</span><span class="op">(</span><span class="st">&quot;Failed to delete: </span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> error<span class="op">.</span><span class="fu">getMessage</span><span class="op">());</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>              <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;Delete successful&quot;</span><span class="op">);</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span>      </span></code></pre></div>
<h2 id="jdk-9---reactive-style-api">JDK 9 - Reactive style API</h2>
<ul>
<li><p>The CqlSession interface extends a new ReactiveSession interface. Which adds methods such as executeReactive() to process queries expressed as reactive streams.</p></li>
<li><div class="sourceCode" id="cb9"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>          <span class="cf">try</span> <span class="op">(</span>CqlSession session <span class="op">=</span> <span class="kw">...</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>                Flux<span class="op">.</span><span class="fu">from</span><span class="op">(</span>session<span class="op">.</span><span class="fu">executeReactive</span><span class="op">(</span><span class="st">&quot;SELECT ...&quot;</span><span class="op">))</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span><span class="fu">doOnNext</span><span class="op">(</span><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">::</span>println<span class="op">)</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span><span class="fu">blockLast</span><span class="op">();</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>          <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span>DriverException e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>            e<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>          <span class="op">}</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>          <span class="cf">try</span> <span class="op">(</span>CqlSession session <span class="op">=</span> <span class="kw">...</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>            Flux<span class="op">.</span><span class="fu">just</span><span class="op">(</span><span class="st">&quot;INSERT ...&quot;</span><span class="op">,</span> <span class="st">&quot;INSERT ...&quot;</span><span class="op">,</span> <span class="st">&quot;INSERT ...&quot;</span><span class="op">,</span> <span class="kw">...</span><span class="op">)</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">doOnNext</span><span class="op">(</span><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">::</span>println<span class="op">)</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">flatMap</span><span class="op">(</span>session<span class="op">::</span>executeReactive<span class="op">)</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">blockLast</span><span class="op">();</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>          <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span>DriverException e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>            e<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>          <span class="op">}</span></span></code></pre></div></li>
</ul>
<h2 id="cassandra-write-path">Cassandra write path</h2>
<ul>
<li>Performance optimzied for write using append only</li>
<li>Database commit log and hinted handoff design, the database is always writable, and within a row, writes are always atomic.</li>
<li>Consistency Level - ANY/ONE/TWO/THREE/LOCAL_ONE/QUORUM/LOCAL_QUORUM/EACH_QUORUM/ALL
<ul>
<li>ANY - Hinted hand-off is counted</li>
<li>ONE (Atleast one commit-log + sstable) is counted as one</li>
</ul></li>
<li>Write-Path
<ul>
<li>Client &gt; Cassandra Cordinator Node &gt; Nodes (replicas)</li>
<li>If client uses token-aware cordinator itself replica, if not key is used by partitioner to find node</li>
<li>Co-ordinator selects remote co-ordinator for X-DC replications</li>
</ul></li>
<li>Node that was down will have data using one of the following
<ul>
<li>hinted handoff</li>
<li>read repair</li>
<li>Anti-entropy repair.</li>
</ul></li>
<li>Existing Row-Cache is invalidated during write</li>
<li>Flush and Compaction might be peformed if necessary</li>
<li>Memtables are stored as SS-Table to disk</li>
</ul>
<h2 id="cassandra-write-path---materialized-view">Cassandra write path - Materialized view</h2>
<ul>
<li>Partition must be locked while consensus negotiated between replicas</li>
<li>Logged batches are used to maintain materialized views</li>
<li>The Cassandra database performs an additional read-before-write operation to update each materialized view</li>
<li>If a delete on the source table affects two or more contiguous rows, this delete is tagged with one tombstone.</li>
<li>But one delete in a source table might create multiple tombstones in the materialized view</li>
</ul>
<h2 id="cassandra-writeread---consistency-cqls">Cassandra write/read - consistency CQLS</h2>
<ul>
<li><code>bash           cqlsh&gt; CONSISTENCY;           ## Current consistency level is ONE.           cqlsh&gt; CONSISTENCY LOCAL_ONE;           ## Consistency level set to LOCAL_ONE.           ## statement.setConsistencyLevel(ConsistencyLevel.LOCAL_QUORUM);</code></li>
</ul>
<h2 id="cassandra-failures-and-solutions">Cassandra failures and solutions</h2>
<ul>
<li>java.lang.OutOfMemoryError: Map failed` - Almost always incorrect user limits - check ulimit -a
<ul>
<li>Check the values of max memory size and virtual memory</li>
</ul></li>
</ul>
<h2 id="scaling-quotes">Scaling Quotes</h2>
<ul>
<li>If you can’t split it, you can’t scale it. “Randy Shoup, Distinguished Architect, eBay”</li>
<li><a href="http://db.cs.berkeley.edu/papers/hpts85-nothing.pdf">“The Case for Shared Nothing” - Michael Stonebreaker</a></li>
<li>No sane pilot would take off in an airplane without the ability to land, and no sane engineer would roll code that they could not pull back off in an emergency</li>
<li>Management means measurement, and a failure to measure is a failure to manage.</li>
</ul>
<h2 id="performance-quotes">Performance Quotes</h2>
<ol type="1">
<li>“The recommendation for speeding up …. is to add cache and more cache. And after that add a little more cache just in case.”</li>
<li>“When something becomes slow it’s a candidate for caching.”</li>
<li>“LRU policy is perhaps the most popular due to its simplicity, good runtime performance, and a decent hit rate in common workloads.”</li>
<li>“Rather than dealing with the uncertainty of the correctness of an answer, the data is made unavailable until it is absolutely certain that it is correct.” (pitfall of strong consistency)</li>
</ol>
<h2 id="nodetool">Nodetool</h2>
<ul>
<li>Adminstration tool uses JMX to interact with Cassandra</li>
<li>TPstats (threadpoolstatus) and Tablestats are subcommands in nodetool</li>
<li>nodetool help tpstats</li>
<li>nodetool tpstats –</li>
</ul>
<h2 id="building-cassandra">Building Cassandra</h2>
<ul>
<li>Cassandra is built using Ant &amp; Maven (Ant in-turn uses Maven)</li>
<li><a href="https://builds.apache.org/">Apache Builds</a></li>
<li><a href="https://ci-cassandra.apache.org/view/Cassandra%204.0/job/Cassandra-trunk/lastBuild/">Apache Cassandra Build</a></li>
<li><a href="https://gitbox.apache.org/repos/asf/cassandra.git">Cassandra source</a></li>
<li>‘jdk8; ant -f build.xml clean generate-idea-files’</li>
<li>‘jdk8; ant -f build.xml test cqltest’</li>
<li>To test one class in intelli-idea
<ul>
<li>java -Dcassandra.config=file:\:.yaml -Dlogback.configurationFile=file:\:-test.xml -Dcassandra.logdir=D:/git/cassandra4/build/test/logs -Djava.library.path=D:/git/cassandra4/lib/sigar-bin -ea org.apache.cassandra.db.compaction.LeveledCompactionStrategyTest</li>
</ul></li>
<li>Ant default target would produce apache-cassandra-x.x.x.jar</li>
</ul>
<h2 id="resources">Resources</h2>
<ul>
<li>https://community.datastax.com/</li>
<li>user@cassandra.apache.org - provides a general discussion list for users and is frequently used by new users or those needing assistance.</li>
<li>dev@cassandra.apache.org - is used by developers to discuss changes, prioritize work, and approve releases.</li>
<li>client-dev@cassandra.apache.org - is used for discussion specific to development of Cassandra clients for various programming languages.</li>
<li>commits@cassandra.apache.org - tracks Cassandra code commits. This is a fairly high-volume list and is primarily of interest to committers.</li>
<li>cassandra and cassandra-dev slack channels</li>
<li>Cassandra blogs
<ul>
<li><a href="https://thelastpickle.com/blog/" class="uri">https://thelastpickle.com/blog/</a></li>
<li><a href="https://cassandra.apache.org/blog/" class="uri">https://cassandra.apache.org/blog/</a></li>
<li><a href="https://www.instaclustr.com/category/technical/cassandra/" class="uri">https://www.instaclustr.com/category/technical/cassandra/</a></li>
<li><a href="https://www.datastax.com/blog" class="uri">https://www.datastax.com/blog</a></li>
</ul></li>
</ul>
<h2 id="follow-up-questions-for-cassandra">Follow-up questions for Cassandra</h2>
<ul>
<li>What are the other peer-to-peer databases?
<ul>
<li>How clients are connecting to them?<br />
</li>
</ul></li>
<li>Does mongo-db/kafka supports Cassandra-toplogy/cross-dc kind of configurations?</li>
<li>How to find node using token in Cassandra?</li>
<li>Where else “PHI THRESHOLD AND ACCRUAL FAILURE DETECTORS” being used?</li>
<li>MerkleTree (surprise usage in Cassandra)</li>
<li>PHI THRESHOLD AND ACCRUAL FAILURE DETECTORS (Surprise)</li>
</ul>
<h2 id="definitive-guide-references">Definitive Guide References</h2>
<ul>
<li><a href="https://github.com/jeffreyscarpenter/cassandra-guide">Cassandra Guide</a></li>
<li><a href="http://www.cs.cornell.edu/projects/ladis2009/papers/lakshman-ladis2009.pdf">Cassandra Paper</a></li>
<li><a href="https://www.youtube.com/watch?time_continue=33&amp;v=HaEPXoXVf2k">AWS re:Invent 2018: Amazon DynamoDB Deep Dive: Advanced Design Patterns for DynamoDB (DAT401)</a></li>
<li><a href="https://www.slideshare.net/AmazonWebServices/amazon-dynamodb-deep-dive-advanced-design-patterns-for-dynamodb-dat401-aws-reinvent-2018pdf">amazon-dynamodb-deep-dive-advanced-design-patterns-for-dynamodb</a></li>
<li><a href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/best-practices.html">Best Practices NOSql</a></li>
<li><a href="https://www.seas.upenn.edu/~zives/03f/cis550/codd.pdf">E.F Codd paper</a></li>
<li><a href="https://dsf.berkeley.edu/papers/hpts85-nothing.pdf">The Case for Shared Nothing - Michael Stonebraker</a></li>
<li><a href="http://www.julianbrowne.com/article/brewers-cap-theorem">CAP Theorem</a></li>
<li><a href="https://www.infoq.com/articles/cap-twelve-years-later-how-the-rules-have-changed/">CAP Twelve Years Later: How the “Rules” Have Changed</a></li>
<li><a href="https://www.cs.cornell.edu/projects/ladis2009/papers/lakshman-ladis2009.pdf">Cassandra - A Decentralized Structured Storage System</a></li>
<li><a href="https://docs.datastax.com/en/articles/cassandra/cassandrathenandnow.html">Cassandra - A Decentralized Structured Storage System-Updated-Commentry by Johnathan Ellis</a></li>
<li><a href="https://github.com/Anant/awesome-cassandra">Awesome Cassandra</a></li>
<li><a href="http://marketing.dice.com/pdf/Dice_TechSalarySurvey_2015.pdf">Cassandra pay-2015</a></li>
<li><a href="http://marketing.dice.com/pdf/Dice_TechSalarySurvey_2019.pdf">Cassandra pay-2019</a></li>
<li><a href="https://computing.nova.edu/documents/dice_techsalarysurvey_2020.pdf">Dice pay 2020</a></li>
<li><a href="https://gist.github.com/jeffreyscarpenter/761ddcd1c125dfb194dc02d753d31733">CQLSH Introduction</a></li>
<li><a href="https://thelastpickle.com/blog/2019/01/11/wide-partitions-cassandra-3-11.html">Wide Partitions in Apache Cassandra 3.11</a></li>
<li><a href="https://www.cs.utexas.edu/users/lorenzo/corsi/cs380d/past/03F/notes/paxos-simple.pdf">Paxos made simple</a></li>
<li><a href="https://github.com/datastax/java-driver/">Datastax driver reference</a></li>
<li><a href="https://thelastpickle.com/blog/2018/09/10/incremental-repair-improvements-in-cassandra-4.html">Incremental Repair Improvements in Cassandra 4</a></li>
<li>CassandraSummit</li>
</ul>
<h2 id="code">Code</h2>
<ul>
<li><a href="https://github.com/jeffreyscarpenter/reservation-service">jeffreyscarpenter/reservation-service</a></li>
<li><a href="https://killrvideo.github.io/docs/languages/java/">Datastax KillrVideo sample java application</a></li>
<li><a href="https://github.com/DataStax-Examples/spring-petclinic-reactive#prerequisites">Datastax spring pet-clinic</a></li>
</ul>
<h2 id="how-to-create-anki-from-this-markdown-file">How to create anki from this markdown file</h2>
<pre><code>mdanki Cassandra_Definitive_Guide_Anki.md Cassandra_Definitive_Guide.apkg --deck &quot;Mohan::Cassandra::DefinitiveGuide&quot;</code></pre>
<h2 id="pre-requisite-for-this-tutorial-is-docker">Pre-requisite for this tutorial is docker</h2>
<ul>
<li><a href="https://github.com/mohanmca/MohanLearningGround/blob/master/src/main/md/Tools/docker.md">Docker cheatsheet</a></li>
<li><a href="https://github.com/docker-library/cassandra/blob/master/3.11/Dockerfile">Dockerfile-3.11.10</a></li>
</ul>
<h2 id="use-os-boxes-as-virtual-machine-to-install-cassandra">Use Os-boxes as virtual machine to install cassandra</h2>
<ul>
<li>Base installation location - /home/osboxes/node</li>
<li>Base location for lab - /home/osboxes/Downloads/labwork/data-files</li>
<li>/home/osboxes/Downloads/labwork/data-files/videos-by-tag.csv</li>
</ul>
<h3 id="to-start-cassandra">To start Cassandra</h3>
<div class="sourceCode" id="cb11"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /home/osboxes/node/</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">nohup</span> ./bin/dse cassandra </span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co">### Find status Cassandra</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="ex">osboxes@osboxes:~/node/bin$</span> ./dsetool status</span></code></pre></div>
<pre class="pre"><code>C: Cassandra       Workload: Cassandra       Graph: no     
======================================================
Status=Up/Down
|/ State=Normal/Leaving/Joining/Moving
--   Address          Load             Effective-Ownership  Token                                        Rack         Health [0,1] 
UN   127.0.0.1        180.95 KiB       100.00%              0                                            rack1        0.70         </code></pre>
<h2 id="cassandra-cluster-using-apache-cassandra-wait-at-least-1-minute-between-successive-container-spin-off">Cassandra cluster using apache cassandra (Wait at-least 1 minute between successive container spin-off)</h2>
<div class="sourceCode" id="cb13"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> pull cassandra:3.11.10</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> network create cassnet</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> run <span class="at">--name</span> cass1 <span class="at">--network</span> cassnet <span class="at">-d</span> cassandra:3.11.10</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> run <span class="at">--name</span> cass2 <span class="at">--network</span> cassnet <span class="at">-e</span> CASSANDRA_SEEDS=cass1 <span class="at">-d</span> cassandra:3.11.10</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> run <span class="at">--name</span> cass3 <span class="at">--network</span> cassnet <span class="at">-e</span> CASSANDRA_SEEDS=cass1,cass2 <span class="at">-d</span> cassandra:3.11.10</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="co">#docker run --name  my-cassandra -p 9042:9042 -p 7000:7000 --network host -d cassandra:latest </span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> exec <span class="at">-it</span> cass2 cqlsh</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> exec <span class="at">-it</span> cass2 nodetool stopdaemon</span></code></pre></div>
<h2 id="connect-to-cassandra-docker-cluster">Connect to cassandra docker cluster</h2>
<div class="sourceCode" id="cb14"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> inspect cass2 <span class="kw">|</span> <span class="fu">grep</span> IPAddress</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> exec <span class="at">-it</span> cass2 bash</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="ex">cqlsh</span> 172.18.0.3 9042</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="ex">use</span> cycling<span class="kw">;</span></span></code></pre></div>
<h2 id="run-commands-into-cassandra-docker-node">Run commands into cassandra docker node</h2>
<div class="sourceCode" id="cb15"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> exec <span class="at">-it</span> cass2 bash</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> exec <span class="at">-it</span> cass2 cqlsh</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> exec <span class="at">-it</span> cass2 nodetool tpstats</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> exec <span class="at">-it</span> cass2 nodetool repair</span></code></pre></div>
<h2 id="via-docker-for-dse-server"><a href="https://docs.datastax.com/en/landing_page/doc/landing_page/compatibility.html">Via docker for DSE server</a></h2>
<div class="sourceCode" id="cb16"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">## Find Cassandra tag to practice -- choose ops-center and later dse server -- 6.0.16-1</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> pull datastax/dse-server:6.0.16-1</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> network create cassnet <span class="co"># docker network create --driver=bridge cassnet</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="co">## OPS Center can manage cluser, it should run first</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> run <span class="at">-e</span> DS_LICENSE=accept <span class="at">-d</span> <span class="at">-p</span> 8888:8888 <span class="at">-p</span> 61620:61620 <span class="at">--name</span> my-opscenter <span class="at">--network</span> cassnet datastax/dse-opscenter:6.1.10</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> run <span class="at">-e</span> DS_LICENSE=accept <span class="at">-p</span> 9042:9042 <span class="at">-p</span> 7000:7000 <span class="at">-d</span> <span class="at">--name</span> my-cassandra <span class="at">--network</span> cassnet datastax/dse-server:6.0.16-1</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> run <span class="at">-e</span> DS_LICENSE=accept <span class="at">-p</span> 9042:9042 <span class="at">-p</span> 7000:7000 <span class="at">-d</span> <span class="at">--name</span> my-cassandra-2 <span class="at">--network</span> <span class="at">-e</span> CASSANDRA_SEEDS=my-cassandra cassnet datastax/dse-server:6.0.16-1</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="co">## Running dse-studio</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> run <span class="at">-e</span> DS_LICENSE=accept <span class="at">--network</span> cassnet  <span class="at">--link</span> some-cassandra <span class="at">--name</span> my-studio <span class="at">-d</span> datastax/dse-studio</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> exec <span class="at">-it</span> my-cassandra cqlsh</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> exec <span class="at">-it</span> my-cassandra nodetool status</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a><span class="co">## #172.19.0.2 #172.19.0.3</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> exec <span class="at">-it</span> my-studio cqlsh ip_address</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> exec <span class="at">-it</span> my-cassandra sh <span class="at">-c</span> <span class="st">&quot;/opt/dse/bin/cqlsh.sh&quot;</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;within container&quot;</span> <span class="op">&gt;&gt;</span> cd /opt/dse/bin/cqlsh.sh</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> cp  D:/git/cassandra_playground/labwork/data-files/videos.csv some-cassandra:/videos.csv</span></code></pre></div>
<h2 id="setting-up-application-using-dse-image--running-cassandra-in-docker"><a href="https://www.datastax.com/learn/apache-cassandra-operations-in-kubernetes/running-a-cassandra-application-in-docker#skill-building">Setting up application using DSE image -Running Cassandra in Docker</a></h2>
<ul>
<li><p><code>bash     docker pull cassandra     docker run -d --name nodeA --network cassnet cassandra     docker logs -f nodeA     docker pull datastaxdevs/petclinic-backend     docker run -d \         --name backend \         --network cass-cluster-network \         -p 9966:9966 \         -e CASSANDRA_USE_ASTRA=false \         -e CASSANDRA_USER=cassandra \         -e CASSANDRA_PASSWORD=cassandra \         -e CASSANDRA_LOCAL_DC=datacenter1 \         -e CASSANDRA_CONTACT_POINTS=nodeA:9042 \         -e CASSANDRA_KEYSPACE_CQL="CREATE KEYSPACE spring_petclinic WITH REPLICATION = {'class':'SimpleStrategy','replication_factor':1};" \         datastaxdevs/petclinic-backend     curl -X GET "http://localhost:9966/petclinic/api/pettypes" -H "accept: application/json" | jq     curl -X POST \     "http://localhost:9966/petclinic/api/pettypes" \     -H "accept: application/json" \     -H "Content-Type: application/json" \     -d "{ \"id\": \"unicorn\", \"name\": \"unicorn\"}" | jq     docker exec -it nodeA cqlsh;     USE spring_petclinic;     SELECT * FROM petclinic_reference_lists WHERE list_name='pet_type';     QUIT;     docker pull datastaxdevs/petclinic-frontend-nodejs     docker run -d --name frontend -p 8080:8080 -e URL=https://2886795274-9966-jago04.environments.katacoda.com datastaxdevs/petclinic-frontend-nodejs     clear     docker ps --format '{{.ID}}\t{{.Names}}\t{{.Image}}'     docker stop $(docker ps -aq)     docker rm $(docker ps -aq)     docker ps --format '{{.ID}}\t{{.Names}}\t{{.Image}}'     ## Via docker compose     docker-compose up --scale db=3</code></p></li>
<li><p><a href="http://localhost:9966/swagger-ui/">Swagger-API</a></p></li>
</ul>
<h2 id="copy-files-into-and-out-of-containers">Copy files into and out-of containers</h2>
<div class="sourceCode" id="cb17"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> cp cass1:/etc/cassandra/cassandra.yaml /tmp</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> cp cass1:/var/log/cassandra/<span class="pp">*</span> D:/git/cassandra_playground/log</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> cp cass1:/var/log/cassandra/system.log D:/git/cassandra_playground/log</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> cp cass1:/var/log/cassandra/debug.log D:/git/cassandra_playground/log</span></code></pre></div>
<h2 id="some-cassandra-commands">Some Cassandra commands</h2>
<div class="sourceCode" id="cb18"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="ex">nodetool</span> status</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="ex">nodetool</span> info</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="ex">nodetool</span> describecluster</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="ex">nodetool</span> getlogginglevels</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="ex">nodetool</span> setlogginglevel org.apache.cassandra TRACE</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="ex">nodetool</span> settraceprobability 0.1</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="ex">nodetool</span> drain</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="ex">nodetool</span> stopdaemon</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="ex">nodtool</span> flush</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="ex">cassandra-stress</span> write n=50000 no-warmup <span class="at">-rate</span> threads=1</span></code></pre></div>
<h2 id="cassandra-directory-apache-cassandra">Cassandra directory (Apache Cassandra)</h2>
<ul>
<li>/etc/cassandra</li>
<li>-Dcom.sun.management.jmxremote.password.file=/etc/cassandra/jmxremote.password</li>
<li>-Dcassandra.logdir=/var/log/cassandra</li>
<li>-Dcassandra.storagedir=/var/lib/cassandra</li>
<li>/usr/share/cassandra/lib/HdrHistogram-2.1.9.jar</li>
</ul>
<h2 id="cassandra-stress-tool">Cassandra stress-tool</h2>
<ul>
<li>Creates keyspace1</li>
<li>Reports maximum possible io-ops, partition-rate and latency mean</li>
</ul>
<h2 id="to-start-cqlsh">To start CQLSH</h2>
<div class="sourceCode" id="cb19"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="bu">set</span> PATH=D:<span class="dt">\A</span>pps<span class="dt">\P</span>ython<span class="dt">\P</span>ython27<span class="kw">;</span><span class="ex">%PATH%</span><span class="kw">;</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="co">#via Docker</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> exec <span class="at">-it</span> my-cassandra cqlsh</span></code></pre></div>
<div class="sourceCode" id="cb20"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> KEYSPACE <span class="ot">&quot;KillrVideo&quot;</span> <span class="kw">WITH</span> REPLICATION <span class="op">=</span> { </span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a> <span class="st">&#39;class&#39;</span> : <span class="st">&#39;SimpleStrategy&#39;</span>, </span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a> <span class="st">&#39;replication_factor&#39;</span> : <span class="dv">1</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>};</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="kw">USE</span> KillrVideo;</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> KillrVideo.videos(</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    video_id timeuuid <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    added_date <span class="dt">timestamp</span>,</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>    Title Text</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a><span class="kw">insert</span> <span class="kw">into</span> videos (video_id, added_date, Title) <span class="kw">values</span> (1645ea59<span class="op">-</span>14bd<span class="op">-</span><span class="fl">11e5</span><span class="op">-</span>a993<span class="op">-</span>8138354b7e31, <span class="st">&#39;2014-01-29&#39;</span>, <span class="st">&#39;Cassandra History&#39;</span>);</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> videos <span class="kw">where</span> video_id<span class="op">=</span>1645ea59<span class="op">-</span>14bd<span class="op">-</span><span class="fl">11e5</span><span class="op">-</span>a993<span class="op">-</span>8138354b7e31;</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a><span class="kw">insert</span> <span class="kw">into</span> videos (video_id, added_date, Title) <span class="kw">values</span> (<span class="fl">245e8024</span><span class="op">-</span>14bd<span class="op">-</span><span class="fl">11e5</span><span class="op">-</span><span class="dv">9743</span><span class="op">-</span>8238356b7e32, <span class="st">&#39;2012-04-03&#39;</span>, <span class="st">&#39;Cassandra &amp; SSDs&#39;</span>);</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> videos;</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a><span class="kw">TRUNCATE</span> videos;</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> videos(video_id, added_date, title) <span class="kw">FROM</span> <span class="st">&#39;/home/osboxes/Downloads/labwork/data-files/videos.csv&#39;</span> <span class="kw">WITH</span> <span class="kw">HEADER</span><span class="op">=</span><span class="kw">TRUE</span>;</span></code></pre></div>
<h2 id="references">References</h2>
<ul>
<li><p><a href="https://github.com/docker-library/cassandra/blob/master/3.11/Dockerfile">Dockerfile-3.11.10</a></p></li>
<li><p><a href="https://docs.datastax.com/en/docker/doc/docker/docker67/dockerDSE.html">Docker DSE</a></p></li>
<li><p><a href="https://docs.datastax.com/en/docker/doc/docker/docker68/dockerReadme.html">Docker Setup</a></p></li>
<li><p><a href="https://www.datastax.com/blog/running-dse-microsoft-windows-using-docker">DSE Docker setup on windows</a></p></li>
<li><p><a href="https://academy.datastax.com/units/2012-quick-wins-dse-foundations-apache-cassandra?resource=ds201-datastax-enterprise-6-foundations-of-apache-cassandra">Cassandra Acadamy</a></p></li>
<li><p><a href="https://s3.amazonaws.com/datastaxtraining/VM/DS201-VM-6.0.ova">Datastax VM</a></p></li>
<li><p><a href="https://academy.datastax.com/resources/ds201-datastax-enterprise-6-foundations-of-apache-cassandra">Assets for course</a></p></li>
<li><p><a href="https://academy.datastax.com/#/online-courses/6167eee3-0575-4d88-9f80-f2270587ce23">C:</a> ## Cassandra node</p></li>
<li><p>Cassandra designed for JBOD (just a bunch of disk) setup</p></li>
<li><p>If disk is attached to ethernet, it is wrong choice, hence Cassandra not tuned to work with SAN/NAS</p></li>
<li><p>A node can work with</p>
<ul>
<li>6K to 12K transaction</li>
<li>2-4TB of data on ssd</li>
</ul></li>
<li><p>Cassandra can lineraly scale with new nodes</p></li>
<li></li>
</ul>
<h3 id="nodetool-1">nodetool</h3>
<ul>
<li>help - help</li>
<li>info - jvm statistics</li>
<li>status - all the nodes status (how this node see other nodes in cluster)</li>
</ul>
<h2 id="ring">Ring</h2>
<ul>
<li>Apache cassandra cluster - Collection of nodes</li>
<li>Node that we connect is co-ordinator node</li>
<li>Each node is responsible for range of data
<ul>
<li>Token range</li>
</ul></li>
<li>Every node can deduce which node owns the range of token (range of data)</li>
<li>Co-ordinate sends to acknowledge to client
<ul>
<li>co-ordinator-node !12== data-node</li>
</ul></li>
<li>Range
<ul>
<li>(2^63)-1 to -(2^63)</li>
</ul></li>
<li>Partitioner - Decides how to distribute data within nodes</li>
<li>Right partitioner would place the data widely
<ul>
<li>Murmur3 as a partitioner</li>
<li>MD5 partitioner (random and even)</li>
</ul></li>
</ul>
<h2 id="when-a-new-node-joins-the-ring">When a new node joins the ring</h2>
<ul>
<li>Gossips out to seed-node (seed-nodes are configured in cassandra.yaml)</li>
<li>Other node finds where could new node could fit (could be manual or automatic)</li>
<li>Seed nodes communicate cluster topology to the joining new-node</li>
<li>State of the nodes
<ul>
<li>Joining, Leaving, UP and Down</li>
</ul></li>
</ul>
<h2 id="driver">Driver</h2>
<ul>
<li>Client could intelligently use node status and clutser</li>
<li>Client would use different policies
<ul>
<li>TokenAwarePolicy</li>
<li>RoundRobinPolicy</li>
<li>DCAwareRoundRobinPolicy</li>
</ul></li>
<li>Driver knowing token range would make it intelligent, It would directly talk to data node when data is required</li>
<li>Driver can use the TokenAwarePolicy and directly deal with the node that is responsbile for the data, internally it would avoid one more hop (co-ordinator-node === data-node)</li>
</ul>
<h2 id="peer-to-peer">Peer-to-Peer</h2>
<ul>
<li>We should understand the reason by behind peer-to-peer</li>
<li>Relation databases scales in one of the following way
<ul>
<li>Leader-follower
<ul>
<li>Data is not replicated realtime (hence not consistent)</li>
</ul></li>
<li>Sharding
<ul>
<li>We need routing if we shard the data</li>
<li>No Aggregation support</li>
<li>No-joins or group-by</li>
</ul></li>
</ul></li>
<li>In peer-to-peer
<ul>
<li>No node is special</li>
<li>Everyone is peer</li>
<li>Any node can act as co-ordinator (router)</li>
<li>No-split-brain Problem
<ul>
<li>Any node that is visible to client might accept the write request</li>
<li>Last write wins</li>
</ul></li>
</ul></li>
</ul>
<h2 id="vnode">VNode</h2>
<ul>
<li>If token is distributed in contiguous-range to a physical node, it won’t help when new-node joins
<ul>
<li>Hence every node will not get contiguous token range for its capcity</li>
</ul></li>
<li>Bootstraping new node is complex in peer-to-peer without vnodes</li>
<li>Adding/Removing nodes in distributed system is complex, it can’t just rely on the number of physical node</li>
<li>Vnodes eases the use of heterogeneous machines in a cluster. Better machine can have more vnodes than older.</li>
<li>We can’t move all the data of one-physical node to other node when new-node joins
<ul>
<li>It put strain on the node that transfers the data</li>
<li>It won’t happen in parallel way</li>
</ul></li>
<li>Each node has 128 VNode (default)</li>
<li>Vnode automate token range assignment</li>
<li>num_tokens@cassandra.yaml &gt; 1, enables the vnode (1 means disable vnode)</li>
<li>If all nodes have equal hardware capability, each node should have the same num_tokens value.</li>
</ul>
<h3 id="why-vnode">Why Vnode?</h3>
<ul>
<li>If we have 30 node (with RF=3), effectively we have 10 nodes of original data, 20 nodes of replicated. If every node holds data for 3 ranges of token, and when a node goes down, logically we have RF=2 for set of data, and we can stream from 6 nodes of data</li>
<li>If you started your older machines with 64 vnodes per node and the new machines are twice as powerful, simply give them 128 vnodes each and the cluster remains balanced even during transition.</li>
<li>When using vnodes, Cassandra automatically assigns the token ranges for you. Without vnode, manual assignment is required.</li>
</ul>
<h2 id="gossip-protocol">Gossip protocol</h2>
<ul>
<li>Gossip is a peer-to-peer communication protocol in which nodes periodically exchange state information about themselves and about other nodes they know about.</li>
<li>if a first gossips with second node, and later 1st node gossips with 3 other nodes and second nodes gossips with 3 other node, and each node successively gossips with randomly with other node.. information is quickly spread
<ul>
<li>Node information spreads out in polynomial fashion</li>
</ul></li>
</ul>
<ol type="1">
<li>Each node initiates a gossip round every second</li>
<li>Picks one to three nodes to gossip with</li>
<li>Nodes can gossip with ANY other node in the cluster</li>
<li>Probabilistically (slightly favor) seed and downed nodes</li>
<li>Nodes do not track which nodes they gossiped with prior</li>
<li>Reliably and efficiently spreads node metadata through the cluster</li>
<li>Fault tolerant—​continues to spread when nodes fail</li>
</ol>
<h3 id="what-is-gossiped">What is gossiped?</h3>
<ul>
<li>SYN, ACK, ACK2
<ul>
<li>SYN - sender node details</li>
<li>ACK - reciever node details + packs additional details that receiver knows extra than sender (not just digest)</li>
<li>ACK2 - packs additional details that initiator knows extra then receiver (not just digest)</li>
</ul></li>
<li>Gossip message is tiny, won’t cause significant impact to network bandwidth (network spikes won’t be caused)</li>
<li>JSON is only for analogy</li>
</ul>
<div class="sourceCode" id="cb21"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="er">##</span> <span class="er">Json</span> <span class="er">analogy</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;endPointState&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;endPoint&quot;</span><span class="fu">:</span> <span class="st">&quot;192.168.0.1&quot;</span><span class="fu">,</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;heartBeatState&quot;</span><span class="fu">:</span> <span class="dv">515</span><span class="fu">,</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;version&quot;</span><span class="fu">:</span> <span class="dv">28</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">},</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;applicationState&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;STATUS&quot;</span><span class="fu">:</span> <span class="st">&quot;NORMAL&quot;</span><span class="fu">,</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;DC&quot;</span><span class="fu">:</span> <span class="st">&quot;west&quot;</span><span class="fu">,</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;RACK&quot;</span><span class="fu">:</span> <span class="st">&quot;rack1&quot;</span><span class="fu">,</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;SCHEMA&quot;</span><span class="fu">:</span> <span class="st">&quot;c2b9ksc&quot;</span><span class="fu">,</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;LOAD&quot;</span><span class="fu">:</span> <span class="fl">100.0</span><span class="fu">,</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;SEVERITY&quot;</span><span class="fu">:</span> <span class="fl">0.75</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<h2 id="snitch">Snitch</h2>
<ul>
<li>Snitch - means informer (with criminal background or approver)</li>
<li>Rerports DC, Rack information to each other</li>
<li>Types of snitch
<ul>
<li>SimpleSnitch hardcodes DC1, RACK1 (useless)</li>
<li>PropertyFileSnitch - Every node has to keep, and manualy maintenance</li>
<li>GossipingPropertyFileSnitch</li>
<li>RackInferingSnitch - Infers from IP address - unreliable (not recommended to use)</li>
<li>Cassandra.yaml
<ul>
<li>endpoint_snitch : {“SmpleSnitch” | “PropertyFileSnitch” | “GossipingPropertyFileSnitch” | “DynamicSnitch” }</li>
<li>Ec2Snitch, GoogleCloudSnitch, CloudStackSnitch</li>
</ul></li>
<li>DynamicSnitch - can work on top of snitch that was configured, and in addition knows the high performing node. When node needs to replicate, it can find high-peforming node using DynamicSnitch</li>
</ul></li>
<li>If we need to change the snitch
<ul>
<li>After changing, need to restart all the nodes and run the sequential repair and clean-up on each node.</li>
</ul></li>
<li>All node must use same snitch</li>
</ul>
<h3 id="property-file-snitch">Property File Snitch</h3>
<ul>
<li>Reads datacenter and rack information for all nodes from a file You must keep files in sync with all nodes in the cluster</li>
</ul>
<pre class="pre"><code>cassandra-topology.properties file
175.56.12.105=DC1:RAC1
175.50.13.200=DC1:RAC1
175.54.35.197=DC1:RAC2
175.54.35.152=DC1:RAC2

120.53.24.101=DC2:RAC1
120.55.16.200=DC2:RAC1
120.57.18.103=DC2:RAC2
120.57.18.177=DC2:RAC2</code></pre>
<h3 id="gossiping-property-file-snitch">Gossiping Property File Snitch</h3>
<ul>
<li>Relieves the pain of the property file snitch</li>
<li>Declare the current node’s DC/rack information in a file</li>
<li>You must set each individual node’s settings</li>
<li>But you don’t have to copy settings as with property file snitch</li>
<li>Gossip spreads the setting through the cluster</li>
</ul>
<pre class="pre"><code>cassandra-rackdc.properties file
dc=DC1
rack=RAC</code></pre>
<h2 id="cassandra-replication">Cassandra replication</h2>
<ul>
<li>When co-ordinator responsible for token range 15-25 receives data to save, it finds its token range and copies data to target node</li>
<li>Co-ordinator needs to write data to the node where hash-range belongs
<ul>
<li>if RF=2, every node has its data, and it also gets data from its prior node as part of replication</li>
<li>if RF=3, every node has its data, and it also gets replicated copies of data from prior node-range (as part of replication)</li>
</ul></li>
<li>We can configure multi-datacenter replication for each keyspace
<ul>
<li>Replication factor could be different for each datacenter</li>
<li>When Co-ordinator needs to write data to target-node + 2 other node, where one-of-them belongs to other data-center</li>
<li>Data recieved in that target-node of the different data-center takes responsibility to replicate in its data-center</li>
</ul></li>
<li>A replication factor greater than one…
<ul>
<li>Widens the range of token values a single node is responsible for.</li>
<li>Causes overlap in the token ranges amongst nodes.</li>
<li>Requires more storage in your cluster.</li>
</ul></li>
</ul>
<h2 id="consistency">Consistency</h2>
<ul>
<li>Cassandra fits into AP system (CAP), Csonsistency is tunable parameter in Cassandra.</li>
<li>Cassandra by default optimized for Availablity and Partiton, But can be tuned little to accomadate consistency</li>
<li>Client writes data into Cassandra, it can choose any of the below
<ul>
<li>CL = ONE === Fastest</li>
<li>CL = Quorum</li>
<li>CL = ALL (every replica has to write and acknowledge the read) === Slowest</li>
</ul></li>
<li>Client read data into Cassandra, it can choose any of the below
<ul>
<li>CL = ONE (Write CF = All)</li>
<li>CL = Quorum (Recommeneded if data was written using CF = Quorum)</li>
<li>CL = ALL (Write CF = Quorum)</li>
</ul></li>
<li>Read (CF=ONE) and Write (CF=ONE), When is it useful
<ul>
<li>IOT</li>
<li>Log-data</li>
<li>IOT Timeseries data (where consistency is not that important)</li>
</ul></li>
<li>Consistency across data-center
<ul>
<li>Replica to remote DC could be part of quorum, but it makes write/read slower</li>
<li>Choose for local-quorum</li>
</ul></li>
<li>Higher consistency === higher latency (higher latency – poor)</li>
</ul>
<h3 id="consistency-level-in-cassandra">Consistency level in Cassandra</h3>
<p><strong>Consistency Settings In order of weakest to strongest</strong> 1. ANY - Storing a hint at minimum is satisfactory 1. ALL - Every node must participate 1. ONE,TWO,THREE - Checks closest node(s) to coordinator 1. QUORUM - Majority vote, (sum_of_replication_factors / 2) + 1 1. LOCAL_ONE - Closest node to coordinator in same data center 1. LOCAL_QUORUM - Closest quorum of nodes in same data center 1. EACH_QUORUM - Quorum of nodes in each data center, applies to writes only</p>
<h4 id="with-a-replication-factor-of-three-which-of-the-following-options-guarantee-strong-consistency">With a replication factor of three, which of the following options guarantee strong consistency?</h4>
<ul>
<li><input type="checkbox" disabled="" checked="" />
- write all, read one</li>
<li><input type="checkbox" disabled="" checked="" />
- write all, read quorum</li>
<li><input type="checkbox" disabled="" checked="" />
- write quorum, read all</li>
<li><input type="checkbox" disabled="" checked="" />
- write quorum, read quorum</li>
<li>[-] - <del>write one, read all</del></li>
</ul>
<h2 id="hinted-hand-off">Hinted hand-off</h2>
<ul>
<li>Write request can be served, even when nodes are down. Co-ordinator caches using hints file, later handoever the data to target node</li>
<li>Hints file will be deleted after expiry (default 3 hours), hence data write is not guarantee to the node it was down</li>
<li>If actual node comes while co-ordinator was down, data won’t reach the target node</li>
<li>When node comes back-online, it receives copy from co-ordinator (not from other 2-replicas when RF=3)</li>
<li>Hinted-hand-off + Consistency-level-Any means potential data-loss.
<ul>
<li>Even when RF=3 and if three targe nodes for data is down, CONSISTENCY_LEVEL_ANY would successfully return to client</li>
</ul></li>
<li>Consistency-level-Any is not practical due to hinted-hand-off</li>
<li>We can disable hinted-hand-off</li>
</ul>
<h2 id="read-repair-assume-rf3">Read repair (Assume RF=3)</h2>
<ul>
<li>Nodes goes out-of-sync for many reasons
<ul>
<li>Network partition, node failures, storage failure</li>
</ul></li>
<li>Co-ordinator sometime can answer best available anster (instead of correct answer)</li>
<li>for read request of CL=ALL, Co-ordinator asks data from fastest node (finds using snitch), and checksum-digest from other two nodes, if they are all consistent, it would reply to client-read</li>
<li>if checksum-digest doesn’t matches
<ol type="1">
<li>Co-ordinator requests replicated data from other two nodes</li>
<li>Compares the timestamp for the 3 copies</li>
<li>Sends the latest data to client</li>
<li>Replicates the latest data to the nodes that has stale copy</li>
</ol></li>
</ul>
<h3 id="read-repair-chance">Read Repair Chance</h3>
<ul>
<li>Performed when read is at a consistency level less than ALL</li>
<li>Request reads only a subset of the replicas</li>
<li>We can’t be sure replicas are in sync</li>
<li>Generally you are safe, but no guarantees</li>
<li>Response sent immediately when consistency level is met</li>
<li>Read repair done asynchronously in the background</li>
<li>10% by default</li>
</ul>
<h2 id="node-repai">Node-repai</h2>
<h3 id="nodetool-has-a-repair-tool-that-can-repair-entire-cluster---quite-expensive-operation">Nodetool has a repair tool that can repair entire cluster - Quite expensive operation</h3>
<ul>
<li>nodetool repair –full</li>
<li>Extra load on the network, IO also might spike</li>
</ul>
<h2 id="datastax-node-sync">Datastax Node-sync</h2>
<ul>
<li>It uses the same mechnism what read-repair mechnism does</li>
<li>Datastax Node-sync (should be enabled on per-table-basis)</li>
<li>Datastax Node-sync - runs in background, continously repairing data
<ul>
<li>Should be enabled per table</li>
<li>Create table myTable(…) WITH nodesync = {‘enabled’: ‘true’ };</li>
<li>Local token ranges as segments, and every segrment progress is saved in data-structure save-points</li>
<li>gc_grace_seconds for node-sync is 10 days, it tries to achieve this target.</li>
<li>Each segment is about 200MB, can be configured using segment_size_target_bytes</li>
<li>Segment is automic, system_distributed.nodesync_status table has segment status</li>
<li>Segment outcomes
<ul>
<li>full_in_sync - All replicas were in sync</li>
<li>full_repaired - Some repair necessary</li>
<li>partial_in_sync</li>
<li>partial_repaired</li>
<li>uncompleted</li>
<li>failed</li>
</ul></li>
</ul></li>
</ul>
<h2 id="write-path">Write path</h2>
<ol type="1">
<li>Data reaches to node to write</li>
<li>Cassandra writes data to mem-table &amp; commit-log
<ul>
<li>In mem-table, it is sorted under partion-key (used for read operation)</li>
<li>Commit-log is append-only log (it is like WAL - write ahead log) (used for recovery operation to reconstruct the mem-table)</li>
</ul></li>
<li>Upon mem-table is full, Cassandra stores the mem-table to disk as SS-Table
<ul>
<li>Disk format is called ss-table (strig sorted table)</li>
<li>SS-Table is of similar format to the mem-table</li>
</ul></li>
<li>Cassandra drops the commit-log (upon successful SS_TABLE) and destroys old mem-table</li>
<li>New mem-table (and commit log) is created</li>
<li>Read-path would take care to read data between mem-table and SS-Table</li>
<li><strong>Always ensure commit-log and ss-table are stored in different drive for performance reason</strong>
<ul>
<li>If they are stored in same disk, append only log and read (seek operation), both would slow-down</li>
</ul></li>
</ol>
<ul>
<li>When does a client acknowledge a write?
<ul>
<li>Ans: After the commit log and MemTable are written</li>
</ul></li>
<li>SSTable and MemTable are stored sorted by clustering columns</li>
</ul>
<h2 id="read-path">Read path</h2>
<ul>
<li>Data could be spread across multiple SS-Table (and in-memory), Hence read is bit more complex than write</li>
<li>Data is partioned and partion-token is found, if partion-token is available in mem-table then data is returned (Simple)</li>
<li>SS-Table is sorted and stored based on partion-token</li>
<li>SS-Table partion-index is stored in a separate file called partition-index</li>
<li>Partition-index (itself might grow big)
<ul>
<li>Example : If partition index file has 100 partition keys in it: pk001 to pk100. The partition keys are stored in sorted order, so we know that pk027 comes after pk025.</li>
<li>pk001: 0 (index offset)</li>
<li>pk002: 1170</li>
<li>pk…: 999999</li>
<li>pk099: 3431170</li>
</ul></li>
<li>Partition-summary (index about partition-index)
<ul>
<li>Incomplete partition index data-structure in-memory</li>
<li>Increases the speed to scan the partition-index-file
<ul>
<li>pk001-pk020: 0 (index offset of parition-index)</li>
<li>pk021-pk055: 45</li>
<li>pk056-pk700: 160</li>
</ul></li>
</ul></li>
<li>Key-cache
<ul>
<li>If data was already read, then it directly stores the partition-token-offset of SS-Table in key-cache (cache)</li>
</ul></li>
<li>Bloom-filter
<ul>
<li>Key - possibly there (possible falst positive)</li>
<li>It is definitely not there</li>
</ul></li>
<li>Read &gt; Bloom-Filter &gt; Key-Cache &gt; Partition Summary &gt; Partition Index &gt; SSTable</li>
</ul>
<h2 id="data-stax">Data-stax</h2>
<ul>
<li>No partition-index, instead trie based data-structure used as index
<ul>
<li>SS-Table lookup is much faster than OSS version</li>
</ul></li>
<li>Data-stax can read OSS-Cassandra and migrate to latest format of SS-Table
<ul>
<li>If we know pk0020 location inside the partition-index, it is easier to find the parition-index offset for pk0024 (https://stackoverflow.com/questions/26244456/internals-of-partition-summary-in-cassandra)</li>
</ul></li>
</ul>
<h2 id="compaction">Compaction</h2>
<h3 id="compacting-partition">Compacting partition</h3>
<ul>
<li>Two SS-Table paritions can be merged using merge-sort
<ul>
<li>If keys are matching, take one with latest timestamp</li>
<li>Mostly latest paritions will have latest records</li>
<li>If two keys are matching, but if there is tombstone, and gc-grace-seconds are elapsed deleted records evicted, not written to new SS-TABLE</li>
<li>Despite there could be tombstore, but if gc_grace_seconds not breached, tombstone stored in new partition (for data-resurrection during repair)</li>
</ul></li>
<li>Not all tombstones are discarded during compaction.</li>
<li>A new partition on disk be larger than either of its input partition segments after a compaction, if later partition segments are made up of mostly INSERT operations.</li>
<li>Benefits from compactions are
<ul>
<li>More optimal disk usage</li>
<li>Faster reads</li>
<li>Less memory pressure</li>
</ul></li>
</ul>
<h3 id="compacting-sstables">Compacting SSTables</h3>
<ul>
<li>Two SS-Table merged using merge-sorted</li>
<li>Merge might reduce the partition as all the stale values inside the parition are evicted</li>
<li>Once new SS-Table is created, old SS-Table is dropped</li>
</ul>
<h3 id="types-of-compaction">Types of compaction</h3>
<ul>
<li><p>SizeTiered Compaction (default for write heavy-load)</p></li>
<li><p>Leveled Compaction (read optimized compaction)</p></li>
<li><p>TimeWindow Compaction (for timeseries data)</p></li>
<li><p>Alter table ks.myTable WITH compaction = { ‘class’: ‘LeveledCompactionStrategy’}</p></li>
</ul>
<h2 id="datastax-es6">Datastax ES6</h2>
<ul>
<li>Only one core per CPU and Non-blocking-IO
<ul>
<li>Claims to be more performant than OSS version</li>
<li>These threads are never block</li>
<li>Writes and Reads, both are asynchronous</li>
<li>Each thread has its own mem-table</li>
<li>Separate management thread for Mem-table-flush, Compaction, Hints, Streaming</li>
</ul></li>
<li>OSS - Executor thread-pool</li>
</ul>
<h2 id="reference">Reference</h2>
<ul>
<li><p><a href="https://www.datastax.com/blog/2012/12/virtual-nodes-cassandra-12">Vnodes</a> ## Partition</p></li>
<li><p>The most important concept in Cassandra is patition.</p></li>
<li><p>Primary Key (state, (id))</p>
<ul>
<li>First part of the primary is always partition keys, in the above primary key state is used as partition key</li>
<li>In 1000 node ring, state is used to find the ring-number using consistent hashing algorithm</li>
<li>It’s complexity is - o(1)</li>
</ul></li>
<li><p>Partition key should be analogus to “GROUP BY” related column in typical rdbms table, Here we pre-compute whereas in RDBMS it might do full-table-scan</p></li>
<li><p>Group rows physically together on disk based on the partition key.</p></li>
<li><p>It hashes the partition key values to create a partition token.</p></li>
<li><p>We can choose partition after table were constructed and data inserted</p></li>
</ul>
<h2 id="clustering-columns">Clustering Columns</h2>
<ul>
<li>This constitutes part of Primary Key along with partition key</li>
<li>We can have one or more clustering column</li>
<li>Rows are sorted within the partition based on clustering column</li>
<li>PRIMARY KEY ((state), city, name)
<ul>
<li>By default they are sorted in Ascending order</li>
</ul></li>
<li>A table always has a partition key, and that if the table has no clustering columns
<ul>
<li>Every partition of that table is only comprised of a single row</li>
</ul></li>
<li>Example
<ul>
<li>(PRIMARY KEY((state), city, name, id) WITH CLUSTERING ORDER BY (city DESC, name ASC))<br />
</li>
<li>“CREATE TABLE videos_by_tag ( tag text, video_id uuid, added_date timestamp, title text, PRIMARY KEY(tag, added_date) ) WITH CLUSTERING ORDER BY (added_date DESC);”</li>
</ul></li>
</ul>
<h2 id="primary-key">Primary Key</h2>
<ul>
<li>Primary Key = Partition Key + Clustering Column</li>
<li>Decides uniqueness and date order (sorted and stored)</li>
<li>Some example of primary key definition are:
<ul>
<li>PRIMARY KEY (a): a is the partition key and there is no clustering columns.</li>
<li>PRIMARY KEY (a, b, c) : a is the partition key and b and c are the clustering columns.</li>
<li>PRIMARY KEY ((a, b), c) : a and b compose the partition key (this is often called a composite partition key) and c is the clustering column.</li>
</ul></li>
</ul>
<h2 id="impact-of-partition-key-on-query-cql">Impact of partition key on query (CQL)</h2>
<ul>
<li>All equality comparision comes before inequality (&lt;, &gt;)</li>
<li>Inequality comparision or range queries on clustering columns are allowed (provided partition-key precedes)</li>
<li>Since data is already sorted on disk
<ul>
<li>Range queries are binary search and followed by a linear read</li>
</ul></li>
<li>If we use datetime or timeuuid and stored them in descending order, later record always contains most recent one.</li>
<li>ALLOW FILTERING
<ul>
<li><em>Scans all partitions in the table</em></li>
<li>Relaxes querying on parition key constraint</li>
<li>allows query on just clustering columns without knowing partition key</li>
<li>Don’t use it</li>
</ul></li>
</ul>
<h2 id="querying">Querying</h2>
<ul>
<li>Always provide partition key</li>
<li>Follow the equality similar to the way it is defined
<ul>
<li>Remember that the storage order is based on Clustering key within partition</li>
<li>If CQL has more than one equality within clustering column, follow the order of table definition</li>
</ul></li>
<li></li>
</ul>
<h2 id="cql">CQL</h2>
<div class="sourceCode" id="cb24"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="ex">cqlsh:killrvideo</span><span class="op">&gt;</span> desc table video<span class="kw">;</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="ex">CREATE</span> TABLE killrvideo.videos <span class="er">(</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    <span class="ex">video_id</span> timeuuid PRIMARY KEY,</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    <span class="ex">added_date</span> timestamp,</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    <span class="ex">title</span> text</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="kw">)</span> <span class="ex">WITH</span> bloom_filter_fp_chance = 0.01</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    <span class="ex">AND</span> caching = {<span class="st">&#39;keys&#39;</span>: <span class="st">&#39;ALL&#39;</span>, <span class="st">&#39;rows_per_partition&#39;</span>: <span class="st">&#39;NONE&#39;</span>}</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    <span class="ex">AND</span> comment = <span class="st">&#39;&#39;</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>    <span class="ex">AND</span> compaction = {<span class="st">&#39;class&#39;</span>: <span class="st">&#39;org.apache.cassandra.db.compaction.SizeTieredCompactionStrategy&#39;</span>, <span class="st">&#39;max_threshold&#39;</span>: <span class="st">&#39;32&#39;</span>, <span class="st">&#39;min_threshold&#39;</span>: <span class="st">&#39;4&#39;</span>}</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>    <span class="ex">AND</span> compression = {<span class="st">&#39;chunk_length_in_kb&#39;</span>: <span class="st">&#39;64&#39;</span>, <span class="st">&#39;class&#39;</span>: <span class="st">&#39;org.apache.cassandra.io.compress.LZ4Compressor&#39;</span>}</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>    <span class="ex">AND</span> crc_check_chance = 1.0</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>    <span class="ex">AND</span> default_time_to_live = 0</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>    <span class="ex">AND</span> gc_grace_seconds = 864000</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>    <span class="ex">AND</span> max_index_interval = 2048</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>    <span class="ex">AND</span> memtable_flush_period_in_ms = 0</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>    <span class="ex">AND</span> min_index_interval = 128</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>    <span class="ex">AND</span> speculative_retry = <span class="st">&#39;99PERCENTILE&#39;</span><span class="kw">;</span></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a><span class="ex">COPY</span> video<span class="er">(</span><span class="ex">video_id,</span> added_date, title<span class="kw">)</span> <span class="ex">TO</span> <span class="st">&#39;/home/osboxes/node/labwork/video.csv&#39;</span> WITH HEADER=TRUE<span class="kw">;</span></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a><span class="ex">cqlsh:killrvideo</span><span class="op">&gt;</span> COPY video<span class="er">(</span><span class="ex">video_id,</span> added_date, title<span class="kw">)</span> <span class="ex">TO</span> <span class="st">&#39;/home/osboxes/node/labwork/video.csv&#39;</span> WITH HEADER=TRUE<span class="kw">;</span></span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a><span class="ex">Using</span> 1 child processes</span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a><span class="ex">Starting</span> copy of killrvideo.video with columns [video_id, added_date, title].</span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a><span class="ex">Processed:</span> 5 rows<span class="kw">;</span> <span class="ex">Rate:</span>      21 rows/s<span class="kw">;</span> <span class="ex">Avg.</span> rate:      21 rows/s</span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a><span class="ex">5</span> rows exported to 1 files in 0.234 seconds.</span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a><span class="ex">create</span> table KillrVideo.videos<span class="er">(</span></span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a>    <span class="ex">video_id</span> timeuuid PRIMARY KEY,</span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>    <span class="ex">added_date</span> timestamp,</span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a>    <span class="ex">Title</span> Text</span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a><span class="kw">);</span></span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a><span class="ex">COPY</span> videos<span class="er">(</span><span class="ex">video_id,</span> added_date, title<span class="kw">)</span> <span class="ex">FROM</span> <span class="st">&#39;/home/osboxes/node/labwork/video.csv&#39;</span> WITH HEADER=TRUE<span class="kw">;</span></span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a><span class="ex">drop</span> table video<span class="kw">;</span></span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a><span class="ex">create</span> table KillrVideo.videos_by_tag<span class="er">(</span></span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a>    <span class="ex">tag</span> Text,</span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a>    <span class="ex">video_id</span> timeuuid,</span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a>    <span class="ex">added_date</span> timestamp,</span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a>    <span class="ex">Title</span> Text,</span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a>    <span class="ex">PRIMARY</span> KEY <span class="er">(</span><span class="ex">tag,</span> video_id<span class="kw">)</span></span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a><span class="kw">);</span></span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a><span class="ex">COPY</span> videos_by_tag<span class="er">(</span><span class="ex">tag,</span> video_id, added_date, title<span class="kw">)</span> <span class="ex">FROM</span> <span class="st">&#39;/home/osboxes/Downloads/labwork/data-files/videos-by-tag.csv&#39;</span> WITH HEADER=TRUE<span class="kw">;</span></span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a><span class="cf">select</span> token<span class="kw">(</span><span class="ex">video_id</span><span class="kw">)</span><span class="ex">,</span> video_id from videos_by_tag where tag=<span class="st">&#39;cassandra&#39;</span><span class="kw">;</span></span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a><span class="cf">select</span> token<span class="kw">(</span><span class="ex">video_id</span><span class="kw">)</span><span class="ex">,</span> video_id from videos_by_tag where title=<span class="st">&#39;Cassandra Intro&#39;</span> allow FILTERING<span class="kw">;</span></span>
<span id="cb24-46"><a href="#cb24-46" aria-hidden="true" tabindex="-1"></a><span class="cf">select</span> <span class="ex">*</span> from videos_by_tag where tag=<span class="st">&#39;cassandra&#39;</span> and added_date <span class="op">&gt;</span> <span class="st">&#39;2013-03-17&#39;</span><span class="kw">;</span></span>
<span id="cb24-47"><a href="#cb24-47" aria-hidden="true" tabindex="-1"></a><span class="ex">drop</span> table videos_by_tag<span class="kw">;</span></span>
<span id="cb24-48"><a href="#cb24-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-49"><a href="#cb24-49" aria-hidden="true" tabindex="-1"></a><span class="ex">CREATE</span> TABLE videos_by_tag <span class="er">(</span></span>
<span id="cb24-50"><a href="#cb24-50" aria-hidden="true" tabindex="-1"></a>     <span class="ex">tag</span> text,</span>
<span id="cb24-51"><a href="#cb24-51" aria-hidden="true" tabindex="-1"></a>     <span class="ex">video_id</span> uuid,</span>
<span id="cb24-52"><a href="#cb24-52" aria-hidden="true" tabindex="-1"></a>     <span class="ex">added_date</span> timestamp,</span>
<span id="cb24-53"><a href="#cb24-53" aria-hidden="true" tabindex="-1"></a>     <span class="ex">title</span> text,</span>
<span id="cb24-54"><a href="#cb24-54" aria-hidden="true" tabindex="-1"></a>     <span class="ex">PRIMARY</span> KEY<span class="er">(</span><span class="ex">tag,</span> added_date<span class="kw">)</span> </span>
<span id="cb24-55"><a href="#cb24-55" aria-hidden="true" tabindex="-1"></a> <span class="kw">)</span> <span class="ex">WITH</span> CLUSTERING ORDER BY <span class="er">(</span><span class="ex">added_date</span> DESC<span class="kw">);</span> </span>
<span id="cb24-56"><a href="#cb24-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-57"><a href="#cb24-57" aria-hidden="true" tabindex="-1"></a><span class="ex">COPY</span> videos_by_tag<span class="er">(</span><span class="ex">tag,</span> video_id, added_date, title<span class="kw">)</span> <span class="ex">FROM</span> <span class="st">&#39;/home/videos-by-tag.csv&#39;</span> WITH HEADER = TRUE<span class="kw">;</span> </span>
<span id="cb24-58"><a href="#cb24-58" aria-hidden="true" tabindex="-1"></a><span class="cf">select</span> <span class="ex">*</span> from videos_by_tag where tag=<span class="st">&#39;cassandra&#39;</span> and added_date <span class="op">&gt;</span> <span class="st">&#39;2013-03-17&#39;</span><span class="kw">;</span></span></code></pre></div>
<h2 id="datastax-slides">Datastax slides</h2>
<ul>
<li><p>(https://www.slideshare.net/planetcassandra/datastax-a-deep-look-at-the-cql-where-clause)[DataStax: A deep look at the CQL WHERE clause ] ## Reference</p></li>
<li><p><a href="https://cassandra.apache.org/doc/latest/cql/ddl.html#the-partition-key">Primary Key, Partition Key and Data Definition</a></p></li>
<li><p><a href="https://academy.datastax.com/units/2012-quick-wins-dse-foundations-apache-cassandra?resource=ds201-datastax-enterprise-6-foundations-of-apache-cassandra">Cassandra Acadamy</a> ## CAP Theorem (Consistency)</p></li>
<li><p>CAP Theory and Consistency</p></li>
<li><p>Cassandra fits into AP system, doesn’t promise Consistency</p>
<ul>
<li>Cassandra supports partition tolerance and availability</li>
<li>Cassandra promises tunable Consistency</li>
<li>Consistency can be controlled for each and every read/request independently</li>
</ul></li>
<li><p>Consistency is harder in distributed systems</p></li>
<li><p>CL = Consistency-Number (Number of replication count for current transaction)</p>
<ul>
<li>CL=1 = A node that stored data in commit-log and memtable</li>
<li>CL=ANY = Data is note is not stored in any node, but just handed over to co-ordinator node.</li>
<li>CL=Quorum = 51% of the nodes acknowledged that it wrote</li>
<li>CL=ALL, Highest consistency and reduce the availability</li>
</ul></li>
<li><p>CL=Quorum (both read and write) - is considered strongly consistent</p></li>
<li><p>CL=ANY, used only for write (not for read)</p></li>
<li><p>CL=ONE (Quite useful)</p>
<ul>
<li>Log-data</li>
<li>TimeSeries data</li>
<li>IOT</li>
</ul></li>
<li><p>CL=ALL</p>
<ul>
<li>Most useless (Entire cluster might stop… should use only after quite thoughtful conversation)</li>
</ul></li>
<li><p>Cross DC Consistency</p>
<ul>
<li>Strong replication with consistency</li>
<li>Remote Coordinator</li>
<li>Quorum is heavy (for Cross-DC), It has to consider all the nodes across all the DC’s<br />
</li>
<li>Local-Quorum (Remote coordinator would not consider for remote Quorum)
<ul>
<li>Not considered remote DC Quorum in Local Quorum</li>
</ul></li>
</ul></li>
<li><p>Any &lt; One/Two/Three &lt; Quorum &lt; Local_One &lt; Local_Quorum &lt; Each_Quorum &lt; ALL (from weak to strong consistency)</p></li>
<li><p>Each_Quorum - Quorum of nodes in each data-center, applies to write only</p></li>
</ul>
<h2 id="what-is-each_quorum">What is Each_Quorum</h2>
<ul>
<li>Quorum of nodes in each data-center, applies to write only</li>
<li>Not many application uses it</li>
</ul>
<div class="sourceCode" id="cb25"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># nodetool status</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Datacenter:</span> datacenter1</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="ex">=======================</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="va">Status</span><span class="op">=</span>Up/Down</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span><span class="ex">/</span> State=Normal/Leaving/Joining/Moving</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="ex">--</span>  Address     Load       Tokens       Owns <span class="er">(</span><span class="ex">effective</span><span class="kw">)</span>  <span class="ex">Host</span> ID                               Rack</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="ex">UN</span>  172.19.0.3  5.85 MiB   256          46.7%             2b3576cd-3f5d-4b9c-80bf-9c5a5fce7dc5  rack1</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="ex">UN</span>  172.19.0.2  6.65 MiB   256          53.3%             4936c442-00c7-4242-87cb-4cf265c5ae78  rack1</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a><span class="co"># nodetool ring | grep &quot;172.19.0.3&quot; | wc -l</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a><span class="ex">256</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a><span class="co"># nodetool ring</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a><span class="ex">Datacenter:</span> datacenter1</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a><span class="ex">==========</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a><span class="ex">Address</span>     Rack        Status State   Load            Owns                Token</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>                                                                           <span class="ex">9126432156340756354</span></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a><span class="ex">172.19.0.2</span>  rack1       Up     Normal  6.65 MiB        53.31%              <span class="at">-9163250791483814686</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a><span class="ex">172.19.0.3</span>  rack1       Up     Normal  5.85 MiB        46.69%              <span class="at">-9137673090615533091</span></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a><span class="ex">172.19.0.2</span>  rack1       Up     Normal  6.65 MiB        53.31%              <span class="at">-9083337207055421835</span></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a><span class="ex">172.19.0.2</span>  rack1       Up     Normal  6.65 MiB        53.31%              <span class="at">-8994933303427082675</span></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a><span class="ex">172.19.0.3</span>  rack1       Up     Normal  5.85 MiB        46.69%              <span class="at">-8931107877434468662</span></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a><span class="ex">172.19.0.3</span>  rack1       Up     Normal  5.85 MiB        46.69%              <span class="at">-8862098302720005632</span></span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a><span class="ex">172.19.0.2</span>  rack1       Up     Normal  6.65 MiB        53.31%              <span class="at">-8835701033996281573</span></span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a><span class="ex">172.19.0.3</span>  rack1       Up     Normal  5.85 MiB        46.69%              <span class="at">-8779311204712756082</span></span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a><span class="co"># nodetool gossipinfo</span></span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a><span class="ex">/172.19.0.3</span></span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>  <span class="ex">generation:1573517338</span></span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>  <span class="ex">heartbeat:1729</span></span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>  <span class="ex">STATUS:15:NORMAL,-104443974761627325</span></span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a>  <span class="ex">LOAD:1694:6131589.0</span></span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a>  <span class="ex">SCHEMA:11:3e2505d7-5286-3090-bc68-d01d101c68db</span></span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a>  <span class="ex">DC:7:datacenter1</span></span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a>  <span class="ex">RACK:9:rack1</span></span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a>  <span class="ex">RELEASE_VERSION:5:3.11.5</span></span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a>  <span class="ex">RPC_ADDRESS:4:172.19.0.3</span></span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a>  <span class="ex">NET_VERSION:2:11</span></span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a>  <span class="ex">HOST_ID:3:2b3576cd-3f5d-4b9c-80bf-9c5a5fce7dc5</span></span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a>  <span class="ex">RPC_READY:27:true</span></span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a>  <span class="ex">TOKENS:14:</span><span class="op">&lt;</span>hidden<span class="op">&gt;</span></span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a><span class="ex">/172.19.0.2</span></span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true" tabindex="-1"></a>  <span class="ex">generation:1573517338</span></span>
<span id="cb25-45"><a href="#cb25-45" aria-hidden="true" tabindex="-1"></a>  <span class="ex">heartbeat:1728</span></span>
<span id="cb25-46"><a href="#cb25-46" aria-hidden="true" tabindex="-1"></a>  <span class="ex">STATUS:15:NORMAL,-103897790007775916</span></span>
<span id="cb25-47"><a href="#cb25-47" aria-hidden="true" tabindex="-1"></a>  <span class="ex">LOAD:1694:6974127.0</span></span>
<span id="cb25-48"><a href="#cb25-48" aria-hidden="true" tabindex="-1"></a>  <span class="ex">SCHEMA:11:3e2505d7-5286-3090-bc68-d01d101c68db</span></span>
<span id="cb25-49"><a href="#cb25-49" aria-hidden="true" tabindex="-1"></a>  <span class="ex">DC:7:datacenter1</span></span>
<span id="cb25-50"><a href="#cb25-50" aria-hidden="true" tabindex="-1"></a>  <span class="ex">RACK:9:rack1</span></span>
<span id="cb25-51"><a href="#cb25-51" aria-hidden="true" tabindex="-1"></a>  <span class="ex">RELEASE_VERSION:5:3.11.5</span></span>
<span id="cb25-52"><a href="#cb25-52" aria-hidden="true" tabindex="-1"></a>  <span class="ex">RPC_ADDRESS:4:172.19.0.2</span></span>
<span id="cb25-53"><a href="#cb25-53" aria-hidden="true" tabindex="-1"></a>  <span class="ex">NET_VERSION:2:11</span></span>
<span id="cb25-54"><a href="#cb25-54" aria-hidden="true" tabindex="-1"></a>  <span class="ex">HOST_ID:3:4936c442-00c7-4242-87cb-4cf265c5ae78</span></span>
<span id="cb25-55"><a href="#cb25-55" aria-hidden="true" tabindex="-1"></a>  <span class="ex">RPC_READY:27:true</span></span>
<span id="cb25-56"><a href="#cb25-56" aria-hidden="true" tabindex="-1"></a>  <span class="ex">TOKENS:14:</span><span class="op">&lt;</span>hidden<span class="op">&gt;</span></span>
<span id="cb25-57"><a href="#cb25-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-58"><a href="#cb25-58" aria-hidden="true" tabindex="-1"></a><span class="co">#  nodetool gossipinfo</span></span>
<span id="cb25-59"><a href="#cb25-59" aria-hidden="true" tabindex="-1"></a><span class="ex">/172.19.0.3</span></span>
<span id="cb25-60"><a href="#cb25-60" aria-hidden="true" tabindex="-1"></a>  <span class="ex">generation:1573519222</span></span>
<span id="cb25-61"><a href="#cb25-61" aria-hidden="true" tabindex="-1"></a>  <span class="ex">heartbeat:17</span></span>
<span id="cb25-62"><a href="#cb25-62" aria-hidden="true" tabindex="-1"></a>  <span class="ex">STATUS:15:NORMAL,-104443974761627325</span></span>
<span id="cb25-63"><a href="#cb25-63" aria-hidden="true" tabindex="-1"></a>  <span class="ex">LOAD:19:6396507.0</span></span>
<span id="cb25-64"><a href="#cb25-64" aria-hidden="true" tabindex="-1"></a>  <span class="ex">SCHEMA:11:3e2505d7-5286-3090-bc68-d01d101c68db</span></span>
<span id="cb25-65"><a href="#cb25-65" aria-hidden="true" tabindex="-1"></a>  <span class="ex">DC:7:datacenter1</span></span>
<span id="cb25-66"><a href="#cb25-66" aria-hidden="true" tabindex="-1"></a>  <span class="ex">RACK:9:rack1</span></span>
<span id="cb25-67"><a href="#cb25-67" aria-hidden="true" tabindex="-1"></a>  <span class="ex">RELEASE_VERSION:5:3.11.5</span></span>
<span id="cb25-68"><a href="#cb25-68" aria-hidden="true" tabindex="-1"></a>  <span class="ex">RPC_ADDRESS:4:172.19.0.3</span></span>
<span id="cb25-69"><a href="#cb25-69" aria-hidden="true" tabindex="-1"></a>  <span class="ex">NET_VERSION:2:11</span></span>
<span id="cb25-70"><a href="#cb25-70" aria-hidden="true" tabindex="-1"></a>  <span class="ex">HOST_ID:3:2b3576cd-3f5d-4b9c-80bf-9c5a5fce7dc5</span></span>
<span id="cb25-71"><a href="#cb25-71" aria-hidden="true" tabindex="-1"></a>  <span class="ex">TOKENS:14:</span><span class="op">&lt;</span>hidden<span class="op">&gt;</span></span>
<span id="cb25-72"><a href="#cb25-72" aria-hidden="true" tabindex="-1"></a><span class="ex">/172.19.0.2</span></span>
<span id="cb25-73"><a href="#cb25-73" aria-hidden="true" tabindex="-1"></a>  <span class="ex">generation:1573517338</span></span>
<span id="cb25-74"><a href="#cb25-74" aria-hidden="true" tabindex="-1"></a>  <span class="ex">heartbeat:1971</span></span>
<span id="cb25-75"><a href="#cb25-75" aria-hidden="true" tabindex="-1"></a>  <span class="ex">STATUS:15:NORMAL,-103897790007775916</span></span>
<span id="cb25-76"><a href="#cb25-76" aria-hidden="true" tabindex="-1"></a>  <span class="ex">LOAD:1946:6974127.0</span></span>
<span id="cb25-77"><a href="#cb25-77" aria-hidden="true" tabindex="-1"></a>  <span class="ex">SCHEMA:11:3e2505d7-5286-3090-bc68-d01d101c68db</span></span>
<span id="cb25-78"><a href="#cb25-78" aria-hidden="true" tabindex="-1"></a>  <span class="ex">DC:7:datacenter1</span></span>
<span id="cb25-79"><a href="#cb25-79" aria-hidden="true" tabindex="-1"></a>  <span class="ex">RACK:9:rack1</span></span>
<span id="cb25-80"><a href="#cb25-80" aria-hidden="true" tabindex="-1"></a>  <span class="ex">RELEASE_VERSION:5:3.11.5</span></span>
<span id="cb25-81"><a href="#cb25-81" aria-hidden="true" tabindex="-1"></a>  <span class="ex">RPC_ADDRESS:4:172.19.0.2</span></span>
<span id="cb25-82"><a href="#cb25-82" aria-hidden="true" tabindex="-1"></a>  <span class="ex">NET_VERSION:2:11</span></span>
<span id="cb25-83"><a href="#cb25-83" aria-hidden="true" tabindex="-1"></a>  <span class="ex">HOST_ID:3:4936c442-00c7-4242-87cb-4cf265c5ae78</span></span>
<span id="cb25-84"><a href="#cb25-84" aria-hidden="true" tabindex="-1"></a>  <span class="ex">RPC_READY:27:true</span></span>
<span id="cb25-85"><a href="#cb25-85" aria-hidden="true" tabindex="-1"></a>  <span class="ex">TOKENS:14:</span><span class="op">&lt;</span>hidden<span class="op">&gt;</span></span>
<span id="cb25-86"><a href="#cb25-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-87"><a href="#cb25-87" aria-hidden="true" tabindex="-1"></a><span class="co">#  nodetool gossipinfo</span></span>
<span id="cb25-88"><a href="#cb25-88" aria-hidden="true" tabindex="-1"></a><span class="ex">/172.19.0.3</span></span>
<span id="cb25-89"><a href="#cb25-89" aria-hidden="true" tabindex="-1"></a>  <span class="ex">generation:1573519222</span></span>
<span id="cb25-90"><a href="#cb25-90" aria-hidden="true" tabindex="-1"></a>  <span class="ex">heartbeat:32</span></span>
<span id="cb25-91"><a href="#cb25-91" aria-hidden="true" tabindex="-1"></a>  <span class="ex">STATUS:15:NORMAL,-104443974761627325</span></span>
<span id="cb25-92"><a href="#cb25-92" aria-hidden="true" tabindex="-1"></a>  <span class="ex">LOAD:19:6396507.0</span></span>
<span id="cb25-93"><a href="#cb25-93" aria-hidden="true" tabindex="-1"></a>  <span class="ex">SCHEMA:11:3e2505d7-5286-3090-bc68-d01d101c68db</span></span>
<span id="cb25-94"><a href="#cb25-94" aria-hidden="true" tabindex="-1"></a>  <span class="ex">DC:7:datacenter1</span></span>
<span id="cb25-95"><a href="#cb25-95" aria-hidden="true" tabindex="-1"></a>  <span class="ex">RACK:9:rack1</span></span>
<span id="cb25-96"><a href="#cb25-96" aria-hidden="true" tabindex="-1"></a>  <span class="ex">RELEASE_VERSION:5:3.11.5</span></span>
<span id="cb25-97"><a href="#cb25-97" aria-hidden="true" tabindex="-1"></a>  <span class="ex">RPC_ADDRESS:4:172.19.0.3</span></span>
<span id="cb25-98"><a href="#cb25-98" aria-hidden="true" tabindex="-1"></a>  <span class="ex">NET_VERSION:2:11</span></span>
<span id="cb25-99"><a href="#cb25-99" aria-hidden="true" tabindex="-1"></a>  <span class="ex">HOST_ID:3:2b3576cd-3f5d-4b9c-80bf-9c5a5fce7dc5</span></span>
<span id="cb25-100"><a href="#cb25-100" aria-hidden="true" tabindex="-1"></a>  <span class="ex">RPC_READY:27:true</span></span>
<span id="cb25-101"><a href="#cb25-101" aria-hidden="true" tabindex="-1"></a>  <span class="ex">TOKENS:14:</span><span class="op">&lt;</span>hidden<span class="op">&gt;</span></span>
<span id="cb25-102"><a href="#cb25-102" aria-hidden="true" tabindex="-1"></a><span class="ex">/172.19.0.2</span></span>
<span id="cb25-103"><a href="#cb25-103" aria-hidden="true" tabindex="-1"></a>  <span class="ex">generation:1573517338</span></span>
<span id="cb25-104"><a href="#cb25-104" aria-hidden="true" tabindex="-1"></a>  <span class="ex">heartbeat:1982</span></span>
<span id="cb25-105"><a href="#cb25-105" aria-hidden="true" tabindex="-1"></a>  <span class="ex">STATUS:15:NORMAL,-103897790007775916</span></span>
<span id="cb25-106"><a href="#cb25-106" aria-hidden="true" tabindex="-1"></a>  <span class="ex">LOAD:1946:6974127.0</span></span>
<span id="cb25-107"><a href="#cb25-107" aria-hidden="true" tabindex="-1"></a>  <span class="ex">SCHEMA:11:3e2505d7-5286-3090-bc68-d01d101c68db</span></span>
<span id="cb25-108"><a href="#cb25-108" aria-hidden="true" tabindex="-1"></a>  <span class="ex">DC:7:datacenter1</span></span>
<span id="cb25-109"><a href="#cb25-109" aria-hidden="true" tabindex="-1"></a>  <span class="ex">RACK:9:rack1</span></span>
<span id="cb25-110"><a href="#cb25-110" aria-hidden="true" tabindex="-1"></a>  <span class="ex">RELEASE_VERSION:5:3.11.5</span></span>
<span id="cb25-111"><a href="#cb25-111" aria-hidden="true" tabindex="-1"></a>  <span class="ex">RPC_ADDRESS:4:172.19.0.2</span></span>
<span id="cb25-112"><a href="#cb25-112" aria-hidden="true" tabindex="-1"></a>  <span class="ex">NET_VERSION:2:11</span></span>
<span id="cb25-113"><a href="#cb25-113" aria-hidden="true" tabindex="-1"></a>  <span class="ex">HOST_ID:3:4936c442-00c7-4242-87cb-4cf265c5ae78</span></span>
<span id="cb25-114"><a href="#cb25-114" aria-hidden="true" tabindex="-1"></a>  <span class="ex">RPC_READY:27:true</span></span>
<span id="cb25-115"><a href="#cb25-115" aria-hidden="true" tabindex="-1"></a>  <span class="ex">TOKENS:14:</span><span class="op">&lt;</span>hidden<span class="op">&gt;</span>  </span>
<span id="cb25-116"><a href="#cb25-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-117"><a href="#cb25-117" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span></code></pre></div>
<h2 id="peformance-could-be-degraded-for-many-reasons">Peformance could be degraded for many reasons</h2>
<ul>
<li>nodetool status - check all nodes are up</li>
<li>nodetool tpstats - for dropped messages
<ul>
<li>Usage statistics of thread-pool</li>
</ul></li>
</ul>
<h3 id="dropped-mutataions">Dropped Mutataions</h3>
<ul>
<li>Cassandra uses SEDA architecture
<ul>
<li>If messages inside the are not processed with certain timeout under heavy load, they are dropped</li>
<li>If cross node is slow, it doesn’t receive message fast enough, would be another cause for dropping of messages.</li>
</ul></li>
<li>High number of dropped mutation would cause query timeout
<ul>
<li>This indicates data writes may be lost</li>
</ul></li>
<li>Dropped mutations are automatically recovered by repair/read_repair</li>
<li>Mutation Drop could happen within same node or cross nodes.
<ul>
<li>INFO [ScheduledTasks:1] 2019-07-21 11:44:46,150 MessagingService.java:1281 - MUTATION messages were dropped in last 5000 ms: 0 internal and 65 cross node. Mean internal dropped latency: 0 ms and Mean cross-node dropped latency: 4966 ms</li>
</ul></li>
<li></li>
</ul>
<h3 id="configuration-that-affects-dropped-mutations">Configuration that affects dropped mutations</h3>
<ul>
<li><p>write_request_timeout_in_ms - How long the coordinator waits for write requests to complete with at least one node in the local datacenter. Lowest acceptable value is 10 ms.</p></li>
<li><p>it is milli-seconds, hence every 1000 ms - should be considered as 1 second</p></li>
<li><p>cross_dc_rtt_in_ms - How much to increase the cross-datacenter timeout (write_request_timeout_in_ms + cross_dc_rtt_in_ms) for requests that involve only nodes in a remote datacenter. This setting is intended to reduce hint pressure.</p></li>
</ul>
<h2 id="when-does-cassandra-end-up-having-useless-data">When does Cassandra end up having useless data</h2>
<ul>
<li>If we reduce the replication factor, additional un-necessary data may be sitting till the actual compaction happens</li>
<li>Once we add new node to reduce the token range, Cassandray may contain data from portions of token ranges it no longer owns</li>
</ul>
<h2 id="usage-statistics-of-thread-pool---output">Usage statistics of thread-pool - output</h2>
<div class="sourceCode" id="cb26"><pre class="sourceCode txt"><code class="sourceCode default"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>root@15a092649e23:/# nodetool tpstats</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>Pool Name                         Active   Pending      Completed   Blocked  All time blocked</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>ReadStage                              0         0              3         0                 0</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>MiscStage                              0         0              0         0                 0</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>CompactionExecutor                     0         0             44         0                 0</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>MutationStage                          0         0              1         0                 0</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>MemtableReclaimMemory                  0         0             20         0                 0</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>PendingRangeCalculator                 0         0              1         0                 0</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>GossipStage                            0         0              0         0                 0</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>SecondaryIndexManagement               0         0              0         0                 0</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>HintsDispatcher                        0         0              0         0                 0</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>RequestResponseStage                   0         0              0         0                 0</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>ReadRepairStage                        0         0              0         0                 0</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>CounterMutationStage                   0         0              0         0                 0</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>MigrationStage                         0         0              1         0                 0</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>MemtablePostFlush                      0         0             20         0                 0</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>PerDiskMemtableFlushWriter_0           0         0             20         0                 0</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>ValidationExecutor                     0         0              0         0                 0</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>Sampler                                0         0              0         0                 0</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>MemtableFlushWriter                    0         0             20         0                 0</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>InternalResponseStage                  0         0              0         0                 0</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>ViewMutationStage                      0         0              0         0                 0</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>AntiEntropyStage                       0         0              0         0                 0</span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>CacheCleanupExecutor                   0         0              0         0                 0</span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>Message type           Dropped</span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>READ                         0</span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>RANGE_SLICE                  0</span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a>_TRACE                       0</span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a>HINT                         0</span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a>MUTATION                     0</span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a>COUNTER_MUTATION             0</span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a>BATCH_STORE                  0</span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a>BATCH_REMOVE                 0</span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a>REQUEST_RESPONSE             0</span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a>PAGED_RANGE                  0</span>
<span id="cb26-37"><a href="#cb26-37" aria-hidden="true" tabindex="-1"></a>READ_REPAIR                  0</span></code></pre></div>
<h2 id="what-is-d210-course-about">What is D210 Course about</h2>
<ul>
<li>Operations for Apache Cassandra™ and DataStax Enterprise</li>
<li>Installation
<ul>
<li>echo “deb https://debian.datastax.com/enterprise stable main” | sudo tee -a /etc/apt/sources.list.d/datastax.sources.list</li>
<li>curl -L https://debian.datastax.com/debian/repo_key | sudo apt-key add -</li>
<li>sudo apt-get update</li>
<li>sudo apt-get install dse-full</li>
</ul></li>
</ul>
<h2 id="what-are-basic-parameter-required-for-cassandra-quickstart">What are basic parameter required for Cassandra quickstart</h2>
<ul>
<li>Four parameters
<ul>
<li>cluster-name</li>
<li>listen-address (for peer Cassandra nodes to connect to)</li>
<li>native-transport-address (for clients)</li>
<li>seeds
<ul>
<li>Seeds should be comma seperated inside double quote - “ip1,ip2,ip3”</li>
</ul></li>
</ul></li>
</ul>
<h2 id="what-is-the-location-of-default-cassandra.yaml">What is the location of default Cassandra.yaml?</h2>
<ul>
<li>/etc/dse/cassandra.yaml (package installer)</li>
<li>/cassandra-home/resources/cassandra/conf/cassandra.yaml</li>
</ul>
<h2 id="what-are-directories-related-settings-and-level-2-settings-right">What are directories related settings, and level-2 settings (right</h2>
<p>after quickstart)</p>
<default>
<ul>
<li>initial_token: &lt;128&gt;</li>
<li>commitlog_directory
<ul>
<li>/var/lib/cassandra/commitlog</li>
</ul></li>
<li>data_file_directories
<ul>
<li>/var/lib/cassandra/data</li>
</ul></li>
<li>hints_directory
<ul>
<li>/var/lib/cassandra/hints</li>
</ul></li>
<li>saved_caches_directory</li>
<li>endpoint_snitch</li>
</ul>
<h2 id="what-are-two-file-systedm-that-should-be-separated">What are two file-systedm that should be separated</h2>
<ul>
<li>/var/lib/cassandra/data and /var/lib/cassandra/commitlog</li>
</ul>
<h2 id="cluster-sizing">Cluster Sizing</h2>
<ul>
<li>Figure out cluster size parameters
<ol type="1">
<li>(Write)-Throughput - How much data per second?</li>
<li>Growth Rate - How fast does capacity increase?</li>
<li>Latency (Read) - How quickly must the cluster respond?</li>
</ol></li>
</ul>
<h2 id="cluster-sizing---writethrough-put-example">Cluster Sizing - Writethrough put example</h2>
<ul>
<li><p>2m user commenting 5 comments a day, where a comment is 1000 byte</p></li>
<li><h1 id="comments-per-second-2m-5246060-10m86400-100-comments-per-second">comments per second = (2m * 5)/(24<em>60</em>60) = 10m/86400 = 100 comments per second</h1></li>
<li><p>100 * 1000 bytes = 100KB per-second (multiply into number of replication-factor)</p></li>
</ul>
<h2 id="cluster-sizing---read-throughput-example">Cluster Sizing - Read throughput example</h2>
<ul>
<li><p>2m user viewing 10 video summaries a day, where a video has 4 comments</p></li>
<li><h1 id="comments-per-second-2m-10-4246060-80m86400-925-comments-per-second">comments per second = (2m * 10 * 4)/(24<em>60</em>60) = 80m/86400 = 925 comments per second</h1></li>
<li><p>925 * 1000 bytes = 1MB per-second (should multiply into number of replication-factor?)</p></li>
</ul>
<h2 id="cluster-sizing---monthly-calculate">Cluster-sizing - Monthly calculate</h2>
<ul>
<li>Data should cover only 50% of disk space at any-time to allow repair and compaction to work</li>
<li>Few they estimate just by doubling the need for 60-seconds and extra-polate to 30 days</li>
<li>per-second-data-volume * 30*86400</li>
<li>1MB per second into monthly need
<ul>
<li>1MB * 86400 * 30 = 2.531 TB (here 1MB inclusive of anti-entropy)</li>
</ul></li>
</ul>
<h2 id="cluster-sizing---latency-calculate">Cluster-sizing - Latency calculate</h2>
<ul>
<li>Relevant Factors
<ul>
<li>IO Rate</li>
<li>Workload shape</li>
<li>Access Patterns</li>
<li>Table width</li>
<li>Node profile (memory/cpu/network)</li>
</ul></li>
<li>What is required SLA</li>
<li>Do the benchmarking initially before launching</li>
</ul>
<h2 id="cluster-sizing---probing-questions">Cluster Sizing - Probing Questions</h2>
<ol type="1">
<li>What is the new/update ratio?</li>
<li>What is the replication factor?</li>
<li>Additional headroom for operations - Anti-entropy repair?</li>
</ol>
<h2 id="cassandra-stress-tool-1"><a href="https://cassandra.apache.org/doc/latest/tools/cassandra_stress.html">Cassandra stress tool</a></h2>
<ul>
<li>Define your shcema, and schema performance</li>
<li>Understand how your database scales</li>
<li>It could generate graphical output</li>
<li>Specify any compaction strategy</li>
<li>Optmize your datamodel and setttings</li>
<li>Determine production capacity</li>
<li>Yaml for Schema, Column, Batch and Query descriptions</li>
<li>columnspec:</li>
</ul>
<div class="sourceCode" id="cb27"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> name</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">size</span><span class="kw">:</span><span class="at"> uniform(5..10)</span><span class="co"> # The names of the staff members are between 5-10 characters</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">population</span><span class="kw">:</span><span class="at"> uniform(1..10)</span><span class="co"> # 10 possible staff members to pick from</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> when</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">cluster</span><span class="kw">:</span><span class="at"> uniform(20..500)</span><span class="co"> # Staff members do between 20 and 500 events</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> what</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">size</span><span class="kw">:</span><span class="at"> normal(10..100,50)</span></span></code></pre></div>
<ul>
<li>Distribution can be any among fom, EXTREME, EXP, GAUSS, UNIFORM, FIXED</li>
<li>cassandra-stress user profile=/home/cassandra/TestProfile.yaml ops(insert=10000, user_by_email=100000) -node node-ds210-node1</li>
<li>cassandra-stress user profile=TestProfile.yml ops(insert=2,user_by_email=2) no-warmup -rate threads&lt;=54</li>
<li>cassandra-stress user profile=TestProfile.yml ops(insert=2000,user_by_email=2) no-warmup -rate threads’&lt;=32’</li>
</ul>
<p>ubuntu@ds210-node1:~/labwork$ cassandra-stress user profile=TestProfile.yaml ops(insert=100000,user_by_email=100000) -node ds210-node1 There was a problem parsing the table cql: line 0:-1 mismatched input ‘<EOF>’ expecting ‘)’</p>
<h2 id="linux-top-command">Linux top command</h2>
<ul>
<li>Comes with every linux distribution - (How much Cassandra is using)</li>
<li>Brief summary of Linux system resources + Per process details</li>
<li>Summary
<ul>
<li>CPU Average
<ul>
<li>1,5,15 (minute) average</li>
<li>Spike - will show up in 5 or 15</li>
<li>CPU - Wait
<ul>
<li>Too much of wait is problem for Cassandra (should be zero)</li>
<li>si/hi (sofwatre/hardware - interrupt) might give clue about waiting</li>
</ul></li>
</ul></li>
</ul></li>
<li>Memory
<ul>
<li>Res - Physical Memory</li>
<li>SHR - Shared Memory</li>
<li>VIRT - Virtual memory</li>
<li>Buffers are important
<ul>
<li>High read might cause SSTable in buffer</li>
</ul></li>
</ul></li>
<li>Process State
<ul>
<li>Zombie, Sleeping, Running</li>
</ul></li>
</ul>
<h2 id="linux-top-command---cassandra">Linux top command - Cassandra</h2>
<ul>
<li>Swap should be zero (Cassandra discourages swap)
<ul>
<li>Disable the swap, zero should be allocated</li>
</ul></li>
<li>Zombie should be zero</li>
</ul>
<h2 id="linux-dstat-command-alternative-to-top">Linux dstat command (alternative to top)</h2>
<ul>
<li><p>dstat = cpustat + iostat + vmstat + ifstat (cpy/io/network)</p></li>
<li><p>cpu-core specific information can be listed</p></li>
<li><p>dstate - by defult won’t include memory (dstate -am to add memory details output)</p></li>
<li><p>print stat for every 2 seconds, and measure 7 iteration</p>
<pre><code>ubuntu@ds210-node1:~$ dstat -am 2 7
--total-cpu-usage-- -dsk/total- -net/total- ---paging-- ---system-- ------memory-usage-----
usr sys idl wai stl| read  writ| recv  send|  in   out | int   csw | used  free  buff  cach
  3   6  89   2   0|3412k  112k|   0     0 |   0     0 | 505  1443 | 587M 6286M  100M  935M
  1   1  98   0   0|   0     0 |  66B  722B|   0     0 | 506  1261 | 587M 6286M  100M  935M
  0   0 100   0   0|   0     0 |  66B  418B|   0     0 | 147   403 | 587M 6286M  100M  935M
  0   0 100   0   0|   0     0 |  66B  418B|   0     0 | 161   376 | 587M 6286M  100M  935M
  0   1  99   0   0|   0     0 |  66B  418B|   0     0 | 596  1900 | 587M 6286M  100M  935M
  0   1  98   0   0|   0     0 |  66B  418B|   0     0 | 760  2137 | 587M 6286M  100M  935M
  0   0 100   0   0|   0  8192B|  66B  418B|   0     0 | 111   366 | 587M 6286M  100M  935M
ubuntu@ds210-node1:~$ </code></pre></li>
<li><p>sys is higher - something costly happenning in system space (above 0 is not good)</p></li>
<li><p>disk is weakest link in most system. if wait numbers are higher in user/system space, check disk</p></li>
<li><p>hiq/siq = h/w and s/w interrupt</p></li>
<li><p>HDD can transfer 10s of MBS, while SSDs can transfer hundreds of MBS</p></li>
<li><p>Gigabit is 100MBS usually</p></li>
<li><p>Paging should be usually be near zero (lots of paging is bad to performance)</p></li>
<li><p>System stats can be an indication of process contention (CSW - context switch)</p></li>
</ul>
<h2 id="nodetool-performance-analysis-inside-cluster-node">Nodetool (Performance Analysis inside cluster node)</h2>
<ul>
<li>dstat, top - can investigate inside linux</li>
<li>nodetool - can investigate inside Cassandra JVM</li>
<li>Every Cache size hit ratio should be higher (should be above 80%)</li>
<li>Load - How much data is stored inside node</li>
</ul>
<!-- -->
<pre><code>cqlsh:killr_video&gt; exit
root@c1bf4c2d5378:/# nodetool info
ID                     : 020b9ef3-ae33-4c9f-902a-33eb7f9a753d
Gossip active          : true
Thrift active          : false
Native Transport active: true
Load                   : 571.88 KiB
Generation No          : 1625291106
Uptime (seconds)       : 35986
Heap Memory (MB)       : 209.83 / 998.44
Off Heap Memory (MB)   : 0.01
Data Center            : datacenter1
Rack                   : rack1
Exceptions             : 0
Key Cache              : entries 3721, size 323.3 KiB, capacity 49 MiB, 6138479 hits, 6142208 requests, 0.999 recent hit rate, 14400 save period in seconds
Row Cache              : entries 0, size 0 bytes, capacity 0 bytes, 0 hits, 0 requests, NaN recent hit rate, 0 save period in seconds
Counter Cache          : entries 0, size 0 bytes, capacity 24 MiB, 0 hits, 0 requests, NaN recent hit rate, 7200 save period in seconds
Chunk Cache            : entries 27, size 1.69 MiB, capacity 217 MiB, 120 misses, 6150101 requests, 1.000 recent hit rate, NaN microseconds miss latency
Percent Repaired       : 100.0%
Token                  : (invoke with -T/--tokens to see all 256 tokens)</code></pre>
<h2 id="nodetool-compaction-history---what-are-all-the-fields-and-output">Nodetool compaction-history - what are all the fields and output?</h2>
<pre><code>root@c1bf4c2d5378:/# nodetool compactionhistory
Compaction History:
id                                   keyspace_name columnfamily_name compacted_at            bytes_in bytes_out rows_merged
e01933a0-dc04-11eb-bef5-537733e6a124 system        size_estimates    2021-07-03T13:45:06.266 169066   41854     {4:4}
e0175ee0-dc04-11eb-bef5-537733e6a124 system        sstable_activity  2021-07-03T13:45:06.254 1102     224       {1:12, 4:4}
bacb1140-dbeb-11eb-bef5-537733e6a124 system        size_estimates    2021-07-03T10:45:06.260 169604   41922     {4:4}
bac8ee60-dbeb-11eb-bef5-537733e6a124 system        sstable_activity  2021-07-03T10:45:06.246 968      224       {1:8, 3:1, 4:3}</code></pre>
<h2 id="to-figure-out-the-name-of-a-nodes-datacenter-and-rack-which-nodetool-sub-command-should-you-use">To figure out the name of a node’s datacenter and rack, which nodetool sub-command should you use?</h2>
<ul>
<li>Nodetool info</li>
</ul>
<h2 id="nodetool-gcstats">Nodetool gcstats</h2>
<ul>
<li>Higher the GC Elapsed time is worst performance of the cluster</li>
<li>Higher StdDev, cluster performance would be erratic</li>
</ul>
<div class="sourceCode" id="cb31"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="ex">root@c1bf4c2d5378:/#</span> nodetool gcstats</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>       <span class="ex">Interval</span> <span class="er">(</span><span class="ex">ms</span><span class="kw">)</span> <span class="ex">Max</span> GC Elapsed <span class="er">(</span><span class="ex">ms</span><span class="kw">)</span><span class="ex">Total</span> GC Elapsed <span class="er">(</span><span class="ex">ms</span><span class="kw">)</span><span class="ex">Stdev</span> GC Elapsed <span class="er">(</span><span class="ex">ms</span><span class="kw">)</span>   <span class="ex">GC</span> Reclaimed <span class="er">(</span><span class="ex">MB</span><span class="kw">)</span>         <span class="ex">Collections</span>      Direct Memory Bytes</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>                 <span class="ex">334</span>                   0                   0                 NaN                   0                   0                       <span class="at">-1</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="ex">root@c1bf4c2d5378:/#</span> nodetool gcstats</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>       <span class="ex">Interval</span> <span class="er">(</span><span class="ex">ms</span><span class="kw">)</span> <span class="ex">Max</span> GC Elapsed <span class="er">(</span><span class="ex">ms</span><span class="kw">)</span><span class="ex">Total</span> GC Elapsed <span class="er">(</span><span class="ex">ms</span><span class="kw">)</span><span class="ex">Stdev</span> GC Elapsed <span class="er">(</span><span class="ex">ms</span><span class="kw">)</span>   <span class="ex">GC</span> Reclaimed <span class="er">(</span><span class="ex">MB</span><span class="kw">)</span>         <span class="ex">Collections</span>      Direct Memory Bytes</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>                <span class="ex">2057</span>                   0                   0                 NaN                   0                   0                       <span class="at">-1</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="ex">root@c1bf4c2d5378:/#</span> nodetool gcstats</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>       <span class="ex">Interval</span> <span class="er">(</span><span class="ex">ms</span><span class="kw">)</span> <span class="ex">Max</span> GC Elapsed <span class="er">(</span><span class="ex">ms</span><span class="kw">)</span><span class="ex">Total</span> GC Elapsed <span class="er">(</span><span class="ex">ms</span><span class="kw">)</span><span class="ex">Stdev</span> GC Elapsed <span class="er">(</span><span class="ex">ms</span><span class="kw">)</span>   <span class="ex">GC</span> Reclaimed <span class="er">(</span><span class="ex">MB</span><span class="kw">)</span>         <span class="ex">Collections</span>      Direct Memory Bytes</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>                <span class="ex">1307</span>                   0                   0                 NaN                   0                   0                       <span class="at">-1</span></span></code></pre></div>
<h2 id="nodetool-gossipinfo">Nodetool Gossipinfo</h2>
<ul>
<li>What is the status of the node according its peer node</li>
<li>Peer node knows the detaila about another node using ‘gossipe-info’</li>
<li>Schema-Version mismatch can be noted from this output. Rare but crucial information.</li>
</ul>
<h2 id="nodetool-ring-command">Nodetool Ring command</h2>
<ul>
<li><p>“nodetool ring” is used to output all the tokens of a node.</p></li>
<li><p>nodetool ring – ks_killr_vide – for specific keyspace</p></li>
<li><div class="sourceCode" id="cb32"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="ex">root@c1bf4c2d5378:/#</span> nodetool ring <span class="at">--</span> killr_video <span class="kw">|</span> <span class="fu">head</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Datacenter:</span> datacenter1</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="ex">==========</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="ex">Address</span>     Rack        Status State   Load            Owns                Token</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>                                                                          <span class="ex">9187745666723249887</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="ex">172.19.0.3</span>  rack1       Up     Normal  624.25 KiB      100.00%             <span class="at">-9143401694522716388</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="ex">172.19.0.3</span>  rack1       Up     Normal  624.25 KiB      100.00%             <span class="at">-9002139349711660790</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="ex">172.19.0.3</span>  rack1       Up     Normal  624.25 KiB      100.00%             <span class="at">-8851720287326751527</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="ex">172.19.0.3</span>  rack1       Up     Normal  624.25 KiB      100.00%             <span class="at">-8617136159627124213</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a><span class="ex">172.19.0.3</span>  rack1       Up     Normal  624.25 KiB      100.00%             <span class="at">-8578864381590385349</span></span></code></pre></div></li>
<li></li>
</ul>
<h2 id="nodetool-tableinfo-tablestats---quite-useful-for-data-modelling-information">Nodetool Tableinfo (tablestats) - Quite useful for data-modelling information</h2>
<ul>
<li>nodetool tablestats – ks_killr_video</li>
<li>nodetool tablestats – ks_killr_video user_by_email</li>
<li><code>bash     root@c1bf4c2d5378:/# nodetool tablestats -- killr_video     Total number of tables: 37     ----------------     Keyspace : killr_video             Read Count: 3952653             Read Latency: 2.332187202873614 ms             Write Count: 12577242             Write Latency: 0.026214161419490855 ms             Pending Flushes: 0                     Table: user_by_email                     SSTable count: 3                     Space used (live): 321599                     Space used (total): 321599                     Space used by snapshots (total): 0                     Off heap memory used (total): 5745                     SSTable Compression Ratio: 0.6803828095486517                     Number of partitions (estimate): 2468                     Memtable cell count: 1809586                     Memtable data size: 103656                     Memtable off heap memory used: 0                     Memtable switch count: 3                     Local read count: 3952653                     Local read latency: 0.030 ms                     Local write count: 12577242                     Local write latency: 0.003 ms                     Pending flushes: 0                     Percent repaired: 0.0                     Bloom filter false positives: 0                     Bloom filter false ratio: 0.00000                     Bloom filter space used: 4680                     Bloom filter off heap memory used: 4656                     Index summary off heap memory used: 1041                     Compression metadata off heap memory used: 48                     Compacted partition minimum bytes: 61                     Compacted partition maximum bytes: 86                     Compacted partition mean bytes: 84                     Average live cells per slice (last five minutes): 1.0                     Maximum live cells per slice (last five minutes): 1                     Average tombstones per slice (last five minutes): 1.0                     Maximum tombstones per slice (last five minutes): 1                     Dropped Mutations: 6</code></li>
<li>Table histogram helps to find how much time taken for read/vs/write</li>
</ul>
<div class="sourceCode" id="cb33"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="ex">killr_video/user_by_email</span> histograms</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Percentile</span>  SSTables     Write Latency      Read Latency    Partition Size        Cell Count</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>                              <span class="kw">(</span><span class="ex">micros</span><span class="kw">)</span>          <span class="kw">(</span><span class="ex">micros</span><span class="kw">)</span>           <span class="kw">(</span><span class="ex">bytes</span><span class="kw">)</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="ex">50%</span>             0.00              0.00              0.00                86                 2</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="ex">75%</span>             0.00              0.00              0.00                86                 2</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="ex">95%</span>             0.00              0.00              0.00                86                 2</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a><span class="ex">98%</span>             0.00              0.00              0.00                86                 2</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a><span class="ex">99%</span>             0.00              0.00              0.00                86                 2</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="ex">Min</span>             0.00              0.00              0.00                61                 2</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a><span class="ex">Max</span>             0.00              0.00              0.00                86                 2</span></code></pre></div>
<h2 id="how-to-find-large-partition">How to find large partition?</h2>
<ul>
<li>nodetool tablehistograms ks_killr_video table – would give multi-millions cell-count</li>
<li>nodetool tablehistograms ks_killr_video table – would give large partition-size</li>
</ul>
<h2 id="nodetool-threadpoolinfo-tpstats">Nodetool Threadpoolinfo (tpstats)</h2>
<ul>
<li>Early versions of Cassandra were designed using SEDA architectures (now it actually moved away from it)</li>
<li>If queue is blocked, the request is blocked</li>
<li>if MemtableFlushWriter is blocked, Cassandra unable to write to disk
<ul>
<li>If blocked, lots of data is sitting in memory, sooner Long-GC might kick-in</li>
</ul></li>
</ul>
<h2 id="cassandra-logging">Cassandra logging</h2>
<ul>
<li>It is ususally known as system.log (and debug.log only if enabled in logback.xml or using nodetool setlogginglevel )</li>
<li>java gc.log is also available to investigate gc (garbage collection)</li>
<li>/var/log/cassandra/system.log</li>
<li>syste.log (INFO and above)</li>
<li>logging location can be changed in /etc/dse/cassandra/jvm.options or -DCassandra.logdir=<LOG_DIR></li>
<li>default configurations are in /etc/cassandra/logback.xml</li>
<li>Change logging level for live systems
<ul>
<li>nodetool setlogginglevel org.apache.cassandra.service.StorageProxy DEBUG</li>
<li>nodetool getlogginglevel</li>
</ul></li>
</ul>
<h2 id="cassandra-jvm-gc-logging">Cassandra JVM GC logging</h2>
<ul>
<li>GC logging answeres 3 questions
<ul>
<li>When GC occured</li>
<li>How much memory reclaimed</li>
<li>What is the heap memory before an after reclaim (on the heap)</li>
</ul></li>
<li>GC logging details are configured /etc/cassandra/jvm.options</li>
<li>Cassandra doesn’t use G1 garbage collection</li>
</ul>
<h2 id="how-cassandra-jvm-gc-logging-can-be-configured">How Cassandra JVM GC logging can be configured</h2>
<ul>
<li>How it was turn it on
<ul>
<li>-Xloggc:/var/log/cassandra/gc.log (in the cassandra start script)</li>
</ul></li>
<li>-XX:+PrintGC (refer jvm.options for mroe documentation and options)</li>
<li>Dynamically alter JVM process GC.log
<ul>
<li>info -flag +PrintGC <process-id></li>
</ul></li>
</ul>
<h2 id="how-to-read-gc.log">How to read GC.log?</h2>
<ul>
<li>GC pause in a second or two is big trouble, it should have been in sub-milli-seconds</li>
<li>Ensure after GC, heap consumption is reduced (number should reduce)</li>
</ul>
<h2 id="adding-a-node">Adding a node</h2>
<ul>
<li>Why to add node?
<ul>
<li>To increase capacity for operational head-room</li>
<li>Reached maxmum h/w capcity</li>
<li>Reached maxmum traffic capcity
<ul>
<li>To decrease latency of the application</li>
</ul></li>
</ul></li>
<li>How to add nodes for single-token nodes?
<ul>
<li>Always double to capcity of your cluster</li>
<li>Token ranges has to bisect each of the existing clutser ranges</li>
</ul></li>
<li>How to add nodes for Vnodes cluster?
<ul>
<li>Add single node in incremental fashion</li>
</ul></li>
<li>Can we add multiple node at the same time?
<ul>
<li>Not recommended, but possible</li>
</ul></li>
<li>What is the impact of adding single node?
<ul>
<li>Lots of data movement into the new-node</li>
<li>We may need to remove excess copy for old nodes</li>
<li>Will have gradual impact on performance of the cluster</li>
<li>Will take longer to grow the cluster</li>
</ul></li>
<li>VNodes make it simple to add node</li>
<li>Seed - nodes, Any node that is running while adding other nodes. They are not special in any way</li>
</ul>
<h2 id="bootstrapping-adding-a-note">Bootstrapping (Adding a note)</h2>
<ul>
<li>We need any existing running nodes as seed-nodes (they are not special nodes)</li>
<li>(Adding cluster) Topology changes (adding/removing nodes) are not recommended when there is a repair process alive in your cluster</li>
<li>Cluster-name has to match to join existing cluster</li>
</ul>
<h2 id="what-are-the-steps-followed-by-a-boostrapping-node-when-joining">What are the steps followed by a boostrapping node when joining?</h2>
<ol type="1">
<li>Contact the seed nodes to learn about gossip state.</li>
<li>Transition to Up and Joining state (to indicate it is joining the cluster; represented by UJ in the nodetool status).</li>
<li>Contact the seed nodes to ensure schema agreement.</li>
<li>Calculate the tokens that it will become responsible for.</li>
<li>Stream replica data associated with the tokens it is responsible for from the former owners.</li>
<li>Transition to Up and Normal state once streaming is complete (to indicate it is now part of the cluster; represented by UN in the nodetool status).</li>
</ol>
<h2 id="what-are-the-help-rendered-by-a-existing-node-to-a-joining">What are the help rendered by a existing node to a joining?</h2>
<ul>
<li>Cluster nodes has to prepare to stream necessary SSTables</li>
<li>Existing Cluster nodes continue to satisfy read and write, but also forward write to joining node</li>
<li>Monitor the bootstrap process using ‘nodetool netstas’</li>
</ul>
<h2 id="issues-during-bootstrap">Issues during bootstrap</h2>
<ul>
<li>New node will certainly have a lot of compactions to deal with(especially if it is LCS).</li>
<li>New node should compact as much as before accepting read requests
<ul>
<li>nodetool disablebinary &amp;&amp; nodetool disablethrift &amp;&amp; nodetooldisablegossip*
<ul>
<li>Above will disconnect Cassandra from the cluster, but not stop Cassandra itself. At this point you can unthrottle compactions and let it compact away.</li>
</ul></li>
</ul></li>
<li>We should unthrottle during bootstrap as the node won’t receive read queries until it finishes streaming and joins the cluster.</li>
</ul>
<h2 id="if-bootstrap-fails">If Bootstrap fails</h2>
<ul>
<li>Read the log and find the reason</li>
<li>If it Up and failed with 50% data, try to restart.. mostly it would fix itself</li>
<li>if it further doesn’t work, investigate further</li>
</ul>
<h2 id="after-boostrap-cleanup">After Boostrap (Cleanup)</h2>
<ul>
<li>Nodetool cleanup should be peformed to the other cluster nodes (not to the node that joined)</li>
<li>Cleans up keyspaces and partition keys no longer belonging to a node. (bootstrapped node would have taken some keys and reduced burden on this node)</li>
<li>Cleanup just reads all ss-table and throws-away all the keys not belong to the node, worst-case it just copies the sstable as is</li>
<li>It is almost like Compaction</li>
<li>nodetool [options] cleanup – keyspace <code>{=html}     &lt;table&gt;</code></li>
</ul>
<h2 id="removing-node">Removing node</h2>
<ul>
<li>Why to remove a node?
<ul>
<li>For some event, we ramped-up, need to scale down for legitimate reason</li>
<li>Replacing h/w, or faulty node</li>
</ul></li>
<li>We can’t just shutdown and leave</li>
<li>3 ways to remove the node
<ol type="1">
<li>Inform the leaving node that, this node would be taken away, so it would redistribute its data to the rest of the cluster
<ul>
<li>nodetool decommission
<ul>
<li>It was properly redistributed</li>
<li>Shutting down the port and shutting down process</li>
<li>Data still on the disk, but should be deleted if we plan to bring the node back</li>
</ul></li>
</ul></li>
<li>Inform to the rest of the cluster nodes, that a node was removed/lost
<ul>
<li>nodetool removenode</li>
</ul></li>
<li>Inform the node to just leave immediately without replicating any of its data
<ul>
<li>nodetool assasinate (like kill -9) &amp;&amp; nodetool repair (on the rest of the ndoes to fix)</li>
<li>Try when it is not trying to go away</li>
</ul></li>
</ol></li>
</ul>
<h2 id="where-is-the-data-coming-from-when-a-node-is-removed">Where is the data coming from when a node is removed?</h2>
<ul>
<li>Decommision - Data comes from the node leaving</li>
<li>RemoveNode - Data comes from the rest of the cluster nodes</li>
</ul>
<h2 id="how-to-replace-a-down-node">How to replace a down-node</h2>
<ul>
<li>Replace vs Remove-and-Add</li>
<li>Backup for a node will work a replaced node, because same tokens are used to bring replaced node into cluster</li>
<li>Best option is replace instead of remove-and-add</li>
<li>-Dcassandra.replace_address=<IP_ADDRESS_OF_DEAD_NODE> // has to change in JVM.options
<ul>
<li>Above line informs cluster that node will have same range of tokens as existing dead node</li>
</ul></li>
<li>Once replaced, we should remove -Dcassandra.replace_address=<IP_ADDRESS_OF_DEAD_NODE></li>
<li>We should update seed-node (remove old node, and update with latest IP), to fix GossipInfo</li>
</ul>
<h2 id="why-replace-a-node-than-removing-and-adding">Why replace a node than removing-and-adding?</h2>
<ol type="1">
<li>Don’t need to move data twice</li>
<li>Backup would work for th replaced node (if the token range is same)</li>
<li>It is faster and lesser impact on the cluster</li>
</ol>
<h2 id="stcs---size-tieres-compaction-strategy">STCS - Size Tieres Compaction Strategy</h2>
<ul>
<li>STCS Organizes SSTables into Tiers based on sizes
<ul>
<li>On an exponential scale</li>
</ul></li>
<li>Multiple SSTables would become (larger or smaller)
<ul>
<li>Smaller - when plenty of deltes</li>
<li>Largers - Sum of size of smaller SSTables (when there is no delete in smaller sstable)</li>
</ul></li>
<li>Lower-tier means smaller SStables</li>
<li>Higher-tier means larger SStables</li>
<li>min_threshold and max_thrshold (number of files within the tier)</li>
</ul>
<h2 id="stcs-pros-and-disadvantage">STCS Pros and Disadvantage</h2>
<ul>
<li><p>STCS doesn’t compact 1 GB and 1MB file together</p>
<ul>
<li>Avoids write amplification</li>
<li>Handles write heavy system very well</li>
</ul></li>
<li><p>STCS requires of at least twice the data size (Space amplification)</p></li>
<li><p>How do we combine 4 * 128MB file, we require 512MB additional space to combine them (at-least 50%)</p></li>
<li><p>Stale records in Larger SSTables take unnecessary space (old file would take time to catchup)</p></li>
<li><p>Concurrent_Compactors - Failed more often than helping.</p></li>
<li><p>STCS - Major compaction was not recommended for producton (one big large compacted file) - Never do ‘nodetool compact’ ## STCS Hotness</p></li>
<li><p>STCS compaction chooses hottest tier first to compact</p></li>
<li><p>SSTable hotness determined by number of reads per second per partition key ## Wht STCS is slower for read</p></li>
<li><p>If new write is in lower tier, and old values are in higher tier, they can’t be compacted together (immediately)</p></li>
</ul>
<h2 id="what-triggers-a-stcs-compaction">What triggers a STCS Compaction</h2>
<ul>
<li>More write –&gt; More Compaction</li>
<li>Compaction starts every time a memtable flushes to an SSTable</li>
<li>MemTable too large, commit log too large or manual flush (Triggering events)</li>
<li>When the cluster streams SSTable segments to the node
<ul>
<li>Bootstrap, rebuild, repair</li>
</ul></li>
<li>Compaction continues until there are no more tiers with at least min_threshold tables in it</li>
</ul>
<h2 id="stcs---tombstones">STCS - Tombstones</h2>
<ul>
<li>If no eligible buckets, STCS compacts a single SSTable</li>
<li>tombstone_compaction_interval - At-least one day old before considered for Tombstone compaction</li>
<li>Compaction ensures that tombstones donot overlap old records in other SSTables</li>
<li>The number of expired tombstones must be above 20%</li>
</ul>
<h2 id="lcs---leveled-compaction-strategy">LCS - Leveled Compaction Strategy</h2>
<ul>
<li>sstable_size_in_mb - Max size of SSTable
<ul>
<li>‘Max SSTable Size’ - would be considered like unit size for compaction to trigger</li>
</ul></li>
<li>When there are more than 10 SSTables, they are combined and level is promoted</li>
<li>Every higher level would be 10times bigger than their lower levels</li>
<li>LCS - limits space amplification, but it ends in higher write amplification</li>
<li>L0 - is landing place</li>
</ul>
<h2 id="lcs-pros-and-cons">LCS Pros and Cons</h2>
<ul>
<li>LCS is best for reads
<ul>
<li>90% of the data resides in the lowest level</li>
<li>Each partition resides in only one table</li>
</ul></li>
<li>LCS is not suitable for more writes than reads, but suits occasional writes but high reads</li>
<li>Reads are handled only by few SSTable make it faster</li>
<li>LCS - doesn’t require 50% space, it wastes less disk space</li>
</ul>
<h2 id="lcs---lagging-behind">LCS - Lagging behind</h2>
<ul>
<li>If lower levels are two big, LCS falls back to STCS for L0 compaction</li>
<li>Falling to STCS would helps to create larger SSTable, and compacting two larger SSTable is optimum</li>
</ul>
<h2 id="leveledcompactionstrategy">LeveledCompactionStrategy</h2>
<ul>
<li><a href="https://issues.apache.org/jira/browse/CASSANDRA-14605?jql=labels%20%3D%20lcs%20AND%20project%20in%20(Cassandra)">LCS Cassandra</a></li>
</ul>
<h2 id="twcs---time-window-compaction-strategies">TWCS - Time-window compaction strategies</h2>
<ul>
<li>Best suited for Time-series data</li>
<li>Windowf of time can be chosen while creating Table</li>
<li>STCS is used within the timewindow</li>
<li>Any SSTable that spans two window will be considered for next window</li>
<li>Not suited for data that is being updated</li>
</ul>
<h2 id="nodesync-datastax-enterprise-6.0">Nodesync (Datastax Enterprise 6.0)</h2>
<ul>
<li><p>Continuous background repair</p>
<ul>
<li>only for DSE-6.0 and above</li>
<li>Repair - doesn’t mean something broken, rather preventing anti-entropy</li>
</ul></li>
<li><p>Low overhead, Consistency performance, Doesn’t use Merkel tree</p></li>
<li><p>Predicatable synchronization overhead, and easier than repair</p></li>
<li><p><code>sql       create table mytable (k int primary key) with nodesync = {'enabled': 'true', 'deadline_target_sec: 'true'};        nodetool nodesyncservice setrate &lt;value_in_kb_per_sec&gt;       nodetool nodesyncservice getrate</code></p></li>
<li><p>Parameters</p>
<ul>
<li>Rate – how much bandwidth could be used (between rate and target — rate always wins)</li>
<li>Target – (lesser than gc_grace_seconds)</li>
</ul></li>
<li><p>nodetool nodesync vs dse/bin/nodesync (second binary is cluster-wide tool)</p></li>
</ul>
<h2 id="what-are-all-the-possible-reason-for-large-sstable">What are all the possible reason for large SSTable</h2>
<ul>
<li><p>nodetool compact (somebody run it)</p>
<ul>
<li>Major compaction using STCS would create large SSTable</li>
</ul></li>
<li><p>LCS (over period of time created large SSTable)</p></li>
<li><p>We need to split the file sometime (anti-compaction)</p></li>
<li><p>Warning before using SSTablesplit (don’t run on live system)</p></li>
<li><p><code>bash     sudo service cassandra stop     sstablesplit -s 40 /user/share/data/cssandra/killr_video/users/*</code></p></li>
</ul>
<h2 id="multi-datacenter">Multi-Datacenter</h2>
<ul>
<li><p>We can add datacenter using <code>alter keyspace</code> even before datacenter is available</p></li>
<li><p>Cassandra allows to add datacenter to live system</p></li>
<li><p>conf/cassandra-rackdc.properties</p></li>
<li><p>Snitch is control where the data is.</p></li>
<li><p>NetworkTopologyStrategy - is the one that achieves the distribution (among DC, controlled by Snitch)</p></li>
<li><p>Replication values can be per-datacenter</p></li>
<li><p>DC level information are per keyspace level (not table level)</p></li>
<li><p><code>sql       alter keyspace killr_video with replication = {'class': 'NetworkTopologyStrategy', 'DC1': 2, 'DC2': 2}</code></p></li>
<li><p>nodetool reubuild – name-of-existing-datacenter</p></li>
<li><p>Run ‘nodetool rebuild’ specifying the existing datacenter on all the nodes in the new DC</p></li>
<li><p>Without above, request with LOCAL_ONE or ONE consistency level may fail if the existing DC are not completely in sync</p></li>
</ul>
<h2 id="multi-datacenter-consistency-level">Multi-Datacenter Consistency Level</h2>
<ul>
<li>Local_Quorum - TO reduce latency</li>
<li>Each - Very heavy operation</li>
<li>Snitch should be specified</li>
</ul>
<h2 id="what-if-one-datacenter-goes-down">What if one datacenter goes down?</h2>
<ul>
<li>Gossip will find that DC is down</li>
<li>Reocvery can be accomplished with a rolling repair to all nodes in failed datacenter</li>
<li>Hints would be piling up in other datacenters (that is receiving updates)</li>
<li>We should run-repair if we go beyond GC_Grace_seconds</li>
</ul>
<h2 id="why-we-need-additional-dc">Why we need additional DC?</h2>
<ul>
<li>Live Backup</li>
<li>Improved Performance</li>
<li>Analytics vs Transaction workload</li>
</ul>
<h2 id="sstabledump">SSTableDump</h2>
<ol type="1">
<li>Old tool, quite useful</li>
<li>Only way to dump SSTable into json (for investigation purpose)</li>
<li>Useful to diagnose SSTable ttl and tombostone</li>
<li>Usage
<ol type="1">
<li>tools/bin/sstable data/ks/table/sstable-data.db</li>
<li>-d to view as key-value (withtout JSON)</li>
</ol></li>
</ol>
<h2 id="sstableloader">SSTableloader</h2>
<ol type="1">
<li>sstableloader -d co-ordinator-ip /var/lib/cassandra/data/killrvideo/users/</li>
<li>Load existing data in SSTable format into another cluster (production to test)</li>
<li>Useful to upgrade data from one enviroment to another environment (migrating to new DC)</li>
<li>It adheres to replication factor of target cluster</li>
<li>Tables are repaired in target cluster after being loaded</li>
<li>Fastest way to load the data</li>
<li>Source should be a running node with proper Cassandra.yaml file</li>
<li>Atleast one node in the cluster is configured as SEED</li>
<li>sample dump <code>json     [       {         "partition" : {           "key" : [ "36111c91-4744-47ad-9874-79c2ecb36ea7" ],           "position" : 0         },         "rows" : [           {             "type" : "row",             "position" : 30,             "liveness_info" : { "tstamp" : "2021-07-06T03:38:20.642757Z" },             "cells" : [               { "name" : "v", "value" : 1 }             ]           }         ]       },       {         "partition" : {           "key" : [ "ec07b617-1348-42b8-afb1-913ff531a24c" ],           "position" : 43         },         "rows" : [           {             "type" : "row",             "position" : 73,             "cells" : [               { "name" : "v", "value" : 2, "tstamp" : "2021-07-06T03:39:12.173004Z" }             ]           }         ]       },       {         "partition" : {           "key" : [ "91d7d620-de0b-11eb-ad2f-537733e6a124" ],           "position" : 86         },         "rows" : [           {             "type" : "row",             "position" : 116,             "liveness_info" : { "tstamp" : "2021-07-06T03:38:03.777666Z" },             "cells" : [               { "name" : "v", "deletion_info" : { "local_delete_time" : "2021-07-06T09:06:57Z" },                 "tstamp" : "2021-07-06T09:06:57.504609Z"               }             ]           }         ]       },       {         "partition" : {           "key" : [ "7164f397-f1cb-4341-bc83-ac10088d5bfd" ],           "position" : 128         },         "rows" : [           {             "type" : "row",             "position" : 158,             "cells" : [               { "name" : "v", "value" : 2, "tstamp" : "2021-07-06T03:38:56.888661Z" }             ]           }         ]       }     ]</code></li>
</ol>
<h2 id="loading-different-formats-of-data-into-cassandra">Loading different formats of data into Cassandra</h2>
<ol type="1">
<li><p>Apache Spark for Dataloading</p></li>
<li><div class="sourceCode" id="cb34"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark <span class="im">import</span> SparkConf</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pyspark_cassandra</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark_cassandra <span class="im">import</span> CassandraSparkContext</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>conf <span class="op">=</span> SparkConf().<span class="bu">set</span>(<span class="st">&quot;spark.cassandra.connection.host&quot;</span>, <span class="op">&lt;</span>IP1<span class="op">&gt;</span>).<span class="bu">set</span>(<span class="st">&quot;spark.cassandra.connection.native.port&quot;</span>,<span class="op">&lt;</span>IP2<span class="op">&gt;</span>)</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>sparkContext <span class="op">=</span> CassandraSparkContext(conf <span class="op">=</span> conf)</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>rdd <span class="op">=</span> sparkContext.parallelize([{<span class="st">&quot;validated&quot;</span>:<span class="va">False</span>, <span class="st">&quot;sampleId&quot;</span>:<span class="st">&quot;323112121&quot;</span>, <span class="st">&quot;id&quot;</span>:<span class="st">&quot;121224235-11e5-9023-23789786ess&quot;</span> }])</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>rdd.saveToCassandra(<span class="st">&quot;ks&quot;</span>, <span class="st">&quot;test&quot;</span>, {<span class="st">&quot;validated&quot;</span>, <span class="st">&quot;sample_id&quot;</span>, <span class="st">&quot;id&quot;</span>} )</span></code></pre></div></li>
<li><p>Loading a CSV file into a Cassandra table with validation:</p></li>
</ol>
<div class="sourceCode" id="cb35"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> com<span class="op">.</span>datastax<span class="op">.</span>spark<span class="op">.</span>connector<span class="op">.</span>_</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> com<span class="op">.</span>datastax<span class="op">.</span>spark<span class="op">.</span>connector<span class="op">.</span>cql<span class="op">.</span>_</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> org<span class="op">.</span>apache<span class="op">.</span>spark<span class="op">.</span>SparkContext</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="co">//Preparing SparkContext to work with Cassandra</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> conf <span class="op">=</span> <span class="kw">new</span> <span class="fu">SparkConf</span><span class="op">(</span><span class="kw">true</span><span class="op">).</span><span class="fu">set</span><span class="op">(</span><span class="st">&quot;spark.cassandra.connection.host&quot;</span><span class="op">,</span> <span class="st">&quot;192.168.123.10&quot;</span><span class="op">)</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">set</span><span class="op">(</span><span class="st">&quot;spark.cassandra.auth.username&quot;</span><span class="op">,</span> <span class="st">&quot;cassandra&quot;</span><span class="op">)</span>            </span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">set</span><span class="op">(</span><span class="st">&quot;spark.cassandra.auth.password&quot;</span><span class="op">,</span> <span class="st">&quot;cassandra&quot;</span><span class="op">)</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> sc <span class="op">=</span> <span class="kw">new</span> <span class="fu">SparkContext</span><span class="op">(</span><span class="st">&quot;spark://192.168.123.10:7077&quot;</span><span class="op">,</span> <span class="st">&quot;test&quot;</span><span class="op">,</span> conf<span class="op">)</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> beforeCount <span class="op">=</span> sc<span class="op">.</span><span class="fu">cassandraTable</span><span class="op">(</span><span class="st">&quot;killrvideo&quot;</span><span class="op">,</span> <span class="st">&quot;users&quot;</span><span class="op">).</span>count</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> users <span class="op">=</span> sc<span class="op">.</span><span class="fu">textFile</span><span class="op">(</span><span class="st">&quot;file:///home/student/users.csv&quot;</span><span class="op">).</span><span class="fu">repartition</span><span class="op">(</span><span class="dv">2</span> <span class="op">*</span> sc<span class="op">.</span>defaultParallelism<span class="op">).</span>cache <span class="co">// The RDD is used in two actions</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> loadCount <span class="op">=</span> users<span class="op">.</span>count</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>users<span class="op">.</span><span class="fu">map</span><span class="op">(</span>line <span class="op">=&gt;</span> line<span class="op">.</span><span class="fu">split</span><span class="op">(</span><span class="st">&quot;,&quot;</span><span class="op">)</span> <span class="cf">match</span> <span class="op">{</span></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="bu">Array</span><span class="op">(</span>id<span class="op">,</span> firstname<span class="op">,</span> lastname<span class="op">,</span> email<span class="op">,</span> created_date<span class="op">)</span>    <span class="op">=&gt;</span> <span class="fu">User</span><span class="op">(</span>java<span class="op">.</span>util<span class="op">.</span>UUID<span class="op">.</span><span class="fu">fromString</span><span class="op">(</span>id<span class="op">),</span> firstname<span class="op">,</span> lastname<span class="op">,</span> email<span class="op">,</span> <span class="kw">new</span> java<span class="op">.</span>text<span class="op">.</span><span class="fu">SimpleDateFormat</span><span class="op">(</span><span class="st">&quot;yyyy-mm-dd&quot;</span><span class="op">).</span><span class="fu">parse</span><span class="op">(</span>created_date<span class="op">))</span></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a><span class="op">).</span><span class="fu">saveToCassandra</span><span class="op">(</span><span class="st">&quot;killrvideo&quot;</span><span class="op">,</span> <span class="st">&quot;users&quot;</span><span class="op">)</span></span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> afterCount <span class="op">=</span> sc<span class="op">.</span><span class="fu">cassandraTable</span><span class="op">(</span><span class="st">&quot;killrvideo&quot;</span><span class="op">,</span> <span class="st">&quot;users&quot;</span><span class="op">).</span>count</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>loadCount <span class="op">-</span> <span class="op">(</span>afterCount <span class="op">-</span> beforeCount<span class="op">)</span> <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">println</span> <span class="op">(</span><span class="st">&quot;Errors or upserts - further validation required&quot;</span><span class="op">)</span></span></code></pre></div>
<h2 id="datstax---dse-bulk-configuration-should-be-in-hocon-format">Datstax - DSE Bulk (configuration should be in HOCON format)</h2>
<ol type="1">
<li>CLI import tool (from csv or json)</li>
<li>Can move to and from files in the file-system</li>
<li>Why DSE Bulk?</li>
<li>Casandra-loader is not formally supported, SSTableLoader data should be in SSTable format</li>
<li>CQLSH Copy is not performant</li>
<li>Can be used as format for backup</li>
<li>Unload and reformat as different data-model</li>
<li>Usage: dsbulk -f dsbulk.conf -c csv/json -k keyspace -t tablename</li>
</ol>
<h2 id="backup-and-snapshots">Backup and Snapshots</h2>
<ol type="1">
<li>Why do we need your backup for distributed data?</li>
<li>Human error caused data wipe</li>
<li>Somebody thought they are dropping data in UAT, but it was production</li>
<li>Programmatic accidental deletion or overwriting data</li>
<li>Wrong procedure followed and lost data</li>
<li>SSTables are immutable, we can just copy them for backup purpose</li>
<li>usage - nodetool -h localhost -p 7199 snapshot mykeyspace</li>
</ol>
<h2 id="what-is-cassandra-snapshots">What is Cassandra snapshots?</h2>
<ol type="1">
<li>The DDL to create the table is stored as well.</li>
<li>A snapshot is a copy of a table’s SSTable files at a given time, created via hard links.</li>
<li>Hardlink snapshots are acting as Point-in-Time backup ## Why Snapshots are fast in Cassandra? How to snapshot at the same time?</li>
</ol>
<ul>
<li>It just creates hard-links to underlying SSTable (immutable files)</li>
<li>Actual files are not copied, hence less (zero) data-movement</li>
<li>A parallel SSH tool can be used to snapshot at the same time.</li>
</ul>
<h2 id="how-do-incrementa-backup-works">How do incrementa backup works</h2>
<ul>
<li>Every flush to disk should be added to snapshots
<ul>
<li>incremental_backup: true –##cassandra.yaml</li>
</ul></li>
<li>Snapshot is required (before incremental backups) in-order for incremental backup to work (pre-requisite)</li>
<li>Snapshot informations are stored under “snapshots/directory”</li>
<li>incremental backups are stored under “backups/directory”</li>
<li>incremental backups - are not automatically removed (warning would pile-up)
<ul>
<li>These should be manually removed before creating new snapshot</li>
</ul></li>
</ul>
<h2 id="where-to-store-snapshots">Where to store snapshots?</h2>
<ul>
<li>Snapshots and incremental backups are stored on each cassandra-node</li>
<li>Files should be copied to remote place (not on node)
<ul>
<li><a href="https://github.com/JeremyGrosser/tablesnap">tablesnap can store to AWS S3</a></li>
</ul></li>
</ul>
<h2 id="how-truncate-works">How Truncate works?</h2>
<ul>
<li>auto_snapshot is critical, don’t disable it</li>
<li>Helps to take Snapshots, just before table truncation.</li>
</ul>
<h2 id="how-to-snapshot">How to snapshot?</h2>
<ul>
<li>bin/nodetool snapshot -cf table - t <tag> – keyspace keyspace2</li>
<li><a href="https://docs.rackspace.com/blog/apache-casandra-backup-and-recovery/">How to snapshot and restore</a></li>
</ul>
<h2 id="restore-we-get-1-point-for-backup-99-point-for-restore">Restore (We get 1 point for backup, 99 point for restore)</h2>
<ul>
<li>Backup that doesn’t help to restore is useless</li>
<li>Restore should be tested many times and documented properly</li>
</ul>
<h2 id="steps-to-restore-from-snapshots"><a href="https://community.datastax.com/questions/2345/how-to-restore-cassandra-snapshot-to-a-different-k.html">Steps to restore from snapshots</a></h2>
<ol type="1">
<li>Delete the current data files</li>
<li>Copy the snapshot and incremental files to the appropriate data directories</li>
<li>The table schema must already be present in order to use this method</li>
<li>If using incremental backups
<ol type="1">
<li>Copy the contents of the backups/ directory to each table directory</li>
</ol></li>
<li>Restart and repair the node after the file copying is done Honorable mention – tablesnap and tablerestore • Used when backing up Cassandra to AWS S3 ## How to remove snapshots?</li>
</ol>
<ul>
<li>nodetool clearsnapshot <snapshot_name>
<ul>
<li>Not specifying a snapshot name removes all snapshots</li>
</ul></li>
<li>Remember to remove old snapshots before taking new ones, not automatic</li>
</ul>
<h2 id="jvm-settings">JVM settings</h2>
<ol type="1">
<li>jvm.options can be used to modify jvm settings</li>
<li>cassandra-env.sh is a shell that launches cassandra server, that uses jvm.options</li>
<li>MAX_HEAP_SIZE : -Xmx8G</li>
<li>HEAP_NEW_SIZE : -XX:NewSize=100m</li>
<li>Java 9 by default uses G1 Collector</li>
</ol>
<h2 id="garbage-collections-apache-cassandra">Garbage Collections (Apache Cassandra)</h2>
<ul>
<li>Cassandra on JDK-8 was using CMS</li>
<li>Decrease Pause-Time, But increase Through-Put</li>
<li>Eden, S-1, S-2 space</li>
<li>GC Process - Eden -&gt; Survivor -&gt; S2/S1 (Always one of the survivor space is empty)</li>
<li>GC Process - Step2 - Eden + Survivor -&gt; S2/S1 (Always one of the survivor space is empty)</li>
<li>After many young gc, S1/S2 -&gt; Old GC</li>
<li>CMS kicks in when OldGen is 75% full</li>
</ul>
<h2 id="why-does-full-gc-runs">Why does full GC runs?</h2>
<ul>
<li>If the old gen fills up before the CMS collector can finish</li>
<li>Full GC, stop the world collctor checks new-gen, old-gen and perm-gen</li>
</ul>
<h2 id="how-to-troubleshoot-outofmemoryerror-issues-in-casssandra">How to troubleshoot OutOfMemoryError issues in Casssandra?</h2>
<ul>
<li>-XX:+HeapDumpOnOutOfMemoryError - would dump the entire memory</li>
<li>Use Eclipse Memory Analyzer tool to analyze the content of memory</li>
<li>Cassandra puts the file in a subdirectory of the working, root directory when running as a service</li>
<li>Ensure Cassandra has access to the directory where dump directory was configured, disk should have space to hold this file</li>
</ul>
<h2 id="what-is-tsc">What is TSC?</h2>
<ul>
<li>It is a register inside CPU</li>
<li>Time Stamp Counter (counts the number of cycles), but won’t match between processors</li>
</ul>
<h2 id="tuning-the-linux-kernel">Tuning the Linux Kernel</h2>
<ul>
<li>NTP should be in place for Cassandra to agree time within the clusters
<ul>
<li>NTP would adjust from hierarchy of time servers every 1-20 minutes</li>
</ul></li>
<li>Cassandra service requires unfettered access to all resources</li>
<li>ulimit -a would display all the limits or limits.conf file</li>
<li>What are all the limits
<ol type="1">
<li>-t: cpu time (seconds) unlimited</li>
<li>-f: file size (blocks) unlimited</li>
<li>-d: data seg size (kbytes) unlimited</li>
<li>-s: stack size (kbytes) 8176</li>
<li>-c: core file size (blocks) 0</li>
<li>-v: address space (kbytes) unlimited</li>
<li>-l: locked-in-memory size (kbytes) unlimited</li>
<li>-u: processes 2666</li>
<li>-n: file descriptors 256</li>
<li>-msgqueue unlimited</li>
<li>-sigpending unlimited</li>
</ol></li>
</ul>
<h2 id="what-should-be-removeddisabled-from-linux-for-cassandra-to-work-how-to-remove">What should be removed/disabled from Linux for Cassandra to work? How to remove</h2>
<ul>
<li>swapping should be removed in linux from two places</li>
<li>swapoff -a (not permanently)</li>
<li>/etc/fstab should be edited to disable swapping</li>
<li>edit /etc/sysctl.conf and set vm.swappines=0
<ul>
<li>sysctl -p should reload /etc/sysctl.conf</li>
</ul></li>
<li>Refer datastax for other recommended linux settings</li>
</ul>
<h2 id="hardware-resources-to-consider">Hardware resources to consider</h2>
<ol type="1">
<li>Parameters</li>
</ol>
<ul>
<li>Peristent type</li>
<li>Memory (16GB to 32GB)</li>
<li>CPU (16 Core is best for value)</li>
<li>Network (OS should use separate NIC, shouldn’t share with Cassandra)
<ul>
<li>Cassandra.yaml supports different NIC for CQL and inter-node</li>
</ul></li>
<li>Number of nodes</li>
</ul>
<ol type="1">
<li>Don’t allow</li>
</ol>
<ul>
<li>SAN/NAS/NFS</li>
</ul>
<ol type="1">
<li>SSDs are prefered</li>
</ol>
<ul>
<li>0.50 USD/GB vs 0.05 USD/GB</li>
<li>TWCS - can use HDD</li>
<li>HDD should be backed with more memory</li>
</ul>
<h2 id="datastax-on-cloud">Datastax on Cloud</h2>
<ul>
<li>Templates and scripts to install DSE on cloud</li>
<li>OPSCenter LCM 6.0+ (Lifecycle manager)
<ol type="1">
<li>Provisioning (installation and config)</li>
<li>Configuration management</li>
<li>Chef, Ansible, Recipes playbook out there for DSE OPSCenter</li>
</ol></li>
<li>Always prefer locally attached SSD</li>
<li>If Elastic storage is the only option (on cloud)
<ol type="1">
<li>When ephemeral volume fails, terminate and get a fresh box</li>
</ol></li>
<li>AWS
<ol type="1">
<li>GP2 or IO2 EBS (if you can’t affort ephemerals)</li>
<li>Get big ones, IO latencies are better for larger disk volumes</li>
</ol></li>
<li>Google
<ol type="1">
<li>Elastic volume always have the same tight latencies</li>
<li>pd-ssd seems faster than local-ssd</li>
</ol></li>
</ul>
<h2 id="cassandra-on-cloud-challenges">Cassandra on Cloud Challenges</h2>
<ul>
<li>Hyeperthreads - you don’t get a real CPU</li>
<li>Noisy neighbors - if you see CPU steal, terminate your box and get a new one</li>
<li>Networking
<ul>
<li>AWS VPN - Setup cross region network
<ul>
<li>Prefer Enhanced networking, supported only for few instance</li>
</ul></li>
<li>Azure - Do not use VPN gateways, use public IPs, Vnet2Vnet is slow but works for small workloads</li>
<li>Google - Flat network - No config, it’s great</li>
</ul></li>
</ul>
<h2 id="cassandra-on-cloud-security">Cassandra on cloud security</h2>
<ul>
<li>AWS - volume encryption for EBS</li>
<li>Google - largely secure by default. Should go through multifactor auth</li>
</ul>
<h2 id="cassandra-security-considerations">Cassandra Security Considerations</h2>
<ul>
<li>Authentication and Authorization (Covered in DS410)</li>
<li>Authentication in disabled by default
<ul>
<li>Enable the authentication in dse.yaml</li>
<li>DSEAuthenticator (supports 3 schemes)
<ul>
<li>Kerberos</li>
<li>Ldap</li>
<li>Internal</li>
</ul></li>
<li>Default superuser comes with datastax - user-id and password (cassandra/cassandra)</li>
<li>ALTER change cassandra WITH PASSWORD ‘newpassword’</li>
</ul></li>
<li>Cassandra stores all the credentials in the sys_auth keyspace</li>
</ul>
<h2 id="what-is-the-default-security-configuration">What is the default security configuration</h2>
<div class="sourceCode" id="cb36"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">authentication_options</span><span class="kw">:</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">enabled</span><span class="kw">:</span><span class="at"> </span><span class="ch">false</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">default_scheme</span><span class="kw">:</span><span class="at"> internal</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">allow_digest_with_krb</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">plain_text_without_ssl</span><span class="kw">:</span><span class="at"> warn</span></span></code></pre></div>
<h2 id="where-is-roles-are-stored-in-internal-scheme-in-default-scheme">Where is roles are stored in internal-scheme? (in default scheme)</h2>
<ul>
<li>ALTER keyspace system_auth with replication {‘class’ : ‘NetworkTopologyStrategy’, ‘dc’: 1 , ‘dc’: 3}</li>
<li>All the roles are stored in system_auth.roles table</li>
</ul>
<h2 id="cassandra-authentication-table-system_auth.roles---in-default-scheme">Cassandra Authentication table (system_auth.roles - in default scheme)</h2>
<ul>
<li><p><code>sql       CREATE table system_auth.roles (role text primary key, can_login boolean, is_superuser boolean, number_of set&lt;text&gt;, salted_hash text)       CREATE ROLE fred with PASSWORD = 'Yababdadfdfd' and LOGIN = true;       if LOGIN=TRUE --- user       if LOGIN=FALSE --- role       LIST roles;       DROP role fred;</code></p></li>
<li><p>salted_hash is password</p></li>
</ul>
<h2 id="what-are-best-practices-for-cassandra-security">What are best practices for Cassandra security</h2>
<ol type="1">
<li>Create one more superuer_role and delete the default cassandra super-user</li>
<li>At least change the password for default super-user ‘cassandra’</li>
<li>ALTER USER cassandra WITH password ‘newpassword’</li>
<li>Ensure system_auth keyspace should be replicated to multiple datacenter</li>
</ol>
<h2 id="cassandra-roleauthorization-management">Cassandra Role/Authorization management</h2>
<div class="sourceCode" id="cb37"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>    <span class="kw">Grant</span> <span class="kw">Select</span> <span class="kw">ON</span> killr_video.user_by_email <span class="kw">TO</span> <span class="fu">user</span><span class="op">/</span><span class="kw">role</span>;</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">Grant</span> <span class="kw">Select</span> <span class="kw">ON</span> killr_video.user_by_email <span class="kw">TO</span> fred;</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">Create</span> <span class="kw">Role</span> DB_Accessors;</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">Grant</span> <span class="kw">Select</span> <span class="kw">ON</span> killr_video.user_by_email <span class="kw">to</span> db_accessors;</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">Grant</span> db_accessors <span class="kw">to</span> fred;</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">REVOKE</span> <span class="kw">SELECT</span> <span class="kw">FROM</span> db_accessors;</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>    Permissions </span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span> <span class="kw">Create</span> Keyspace, <span class="kw">Create</span> <span class="kw">Table</span>, </span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span> DDROP <span class="op">-</span> <span class="kw">Drop</span><span class="op">..</span></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span> <span class="kw">MODIFY</span> <span class="op">-</span> </span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span> <span class="kw">Alter</span> <span class="op">-</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span> Authorize <span class="op">-</span> </span></code></pre></div>
<h2 id="cassandra-encryption-ssl">Cassandra encryption SSL</h2>
<ul>
<li>node-to-node</li>
<li>client-to-node</li>
<li>SSL
<ul>
<li>client-symmeteric key would be used to communicate, client-key is encrypted by server public key (typical SSL)</li>
<li>Keystore - signed key-pair (private/public key pair)</li>
<li>Truststore - RCA (root certificate authority) for signed certificate validation</li>
</ul></li>
<li>Inter node communiation
<ul>
<li>Nodes present their certificate from keystore to other nodes</li>
<li>Other nodes validate the certicate using their trust-store RCA details</li>
</ul></li>
</ul>
<h2 id="what-are-two-artifacts-required-for-cassandra-to-enable-ssl">What are two artifacts required for Cassandra to enable SSL</h2>
<ol type="1">
<li>TrustStore (all the trusted certificate- ROOT CA)
<ol type="1">
<li>This is common among all the Cassandra nodes</li>
</ol></li>
<li>Keystore (key-pair, its own signed certificate)</li>
</ol>
<h2 id="steps-for-ssl-setup-node-to-node">8 Steps for SSL setup (node-to-node)</h2>
<ol type="1">
<li>Create Root Cert (Root of entire SSL communication)
<ol type="1">
<li>Root Cert = “CA_KEY” + “Root Cert”</li>
</ol></li>
<li>Create keyStore w/Key pair (for each node)
<ol type="1">
<li>KeyStore</li>
</ol></li>
<li>Export Signing Req (Each nodes certificate sign request)</li>
<li>Sign the certificate using Root-CA
<ol type="1">
<li>To Sign new certificate using root-CA, we need both CA-KEY + Root-Cert</li>
</ol></li>
<li>Import RootCert into keyStore</li>
<li>Import Singed Certificate into keyStore</li>
<li>Create Turst Store
<ol type="1">
<li>Use RootCA to authenticate incoming Connections.</li>
</ol></li>
</ol>
<ul>
<li>Credit-Datastax <img src="img/SSL_STEPS_Datastax.png" alt="SSL" /> “Credit-Datastax-SSL”</li>
<li><a href="./cassandra_security_configuration.pdf">Cassandra Security Configuration</a>
<ol type="1">
<li><a href="https://www.slideshare.net/BrajaDas/cassandra-security-configuration?from_action=save">Credit: SSL Configuration</a></li>
</ol></li>
</ul>
<h2 id="how-to-harden-cassandra-security">How to harden Cassandra security</h2>
<ol type="1">
<li>Secure the keystore - since this contains private key</li>
<li>Setup firewasll so that only nodes can talk to each other on the listen_port</li>
<li>Protect the root CA private key - this Not be disbuted to the nodes</li>
<li>Enable require_client_auth, otherwise program could spoof being a node</li>
</ol>
<h2 id="datastax-opscenter">Datastax OpsCenter</h2>
<ol type="1">
<li>Two Products</li>
<li>Configure and deploy cluster</li>
<li>Configure Security</li>
<li>Perform software upgrades</li>
<li>Load Certificate</li>
</ol>
<h2 id="datastax-opscenter-cluster-monitoringalert">Datastax OpsCenter (Cluster Monitoring/Alert)</h2>
<ol type="1">
<li>Monitoring and management (Operation)</li>
<li>Broswer -&gt; OpsCenter Service -&gt; Agent running inside DataStax Cassandra JVM (exposed via JMX)</li>
<li>UI features
<ol type="1">
<li>Dashboard</li>
<li>Metrics</li>
<li>Alerts</li>
<li>Trend/Capacity analysis</li>
<li>Performance service</li>
</ol></li>
<li>Comprehensive Grafana like dashboard</li>
</ol>
<h2 id="datastax-opscenter-management-service">Datastax OpsCenter (Management Service)</h2>
<ol type="1">
<li>Backup &amp; Restore Service</li>
<li>NodeSync Service</li>
<li>Repair Service</li>
<li>Best Practices Service</li>
<li>Capacity Service</li>
</ol>
<h2 id="datastax-opscenter-backup-and-restore-service">Datastax OpsCenter (Backup and restore Service)</h2>
<ol type="1">
<li>Visual backup management</li>
<li>Backup &amp; Restore on distributed system is hard</li>
<li>Support for multi-cloud backup and restore option</li>
<li>Enterprise-class visual backup service guards against data loss on managed database clusters</li>
<li>Backup Destination
<ol type="1">
<li>Local server</li>
<li>Amazon S3</li>
<li>Custom Location</li>
</ol></li>
<li>Compresses data</li>
<li>Configurable retention polcies</li>
<li>Includes alerts and reporting</li>
</ol>
<h2 id="datastax-opscenter-lifecycle-manager-provisioning">Datastax OpsCenter LifeCycle Manager (Provisioning)</h2>
<ol type="1">
<li>Configuration and deployment (Onboarding)</li>
<li>UI Menu has option for</li>
<li>SSH Credentials</li>
<li>Repositories (download software from datastax)</li>
<li>Config Profiles</li>
<li>Add DC/Nodes/Clusters</li>
<li>Point in time backup &amp; restore</li>
</ol>
<h2 id="datastax-opscenter-nodesync">Datastax OpsCenter NodeSync</h2>
<ol type="1">
<li>Prefered over repair service</li>
<li>Low intensity continuous repair</li>
</ol>
<h2 id="datastax-opscenter-other-features">Datastax OpsCenter other features</h2>
<ol type="1">
<li>Best Practice service - periodically audits, alerts and suggests solution</li>
<li>Capacity service - Used to forecast metrics, configurable for multiple parameters</li>
<li>Performance Service - Diagnose table performance, query performance, ThreadPool stats</li>
<li>Datastax DSE uses one thread per core (and tries to avoid ThreadPools)</li>
<li>Alerts - Integreated into Enterprise Monitoriing system
<ol type="1">
<li>Post request</li>
<li>Mail</li>
<li>SNMP - to an enterprise monitoring system</li>
</ol></li>
</ol>
<h2 id="follow-up-course">Follow-up course</h2>
<ol type="1">
<li>DS-220 - Practical application modelling with Apache Casssandra</li>
<li>DS-310 - DataStax Enterprise Search</li>
<li>DS-320 - DataStax Enterprise Apache Sparx</li>
<li>DS-330 - DataStax Enterprise Graph</li>
</ol>
<h2 id="lab-notes">Lab notes</h2>
<ul>
<li>172.18.0.2</li>
<li>/usr/share/dse/data</li>
<li>/var/lib/cassandra/data</li>
<li>DS-220</li>
</ul>
<h2 id="cassandra-people">Cassandra people</h2>
<ul>
<li><p><a href="https://twitter.com/mrcompscience">Jamie King</a></p></li>
<li><p><a href="https://twitter.com/spyced">Jonathan Ellis</a></p></li>
<li><p><a href="https://twitter.com/patrickmcfadin?lang=en">Patrick McFadin</a></p></li>
<li><h2 id="how-to-create-anki-from-this-markdown-file-1">How to create anki from this markdown file</h2></li>
</ul>
<!-- -->
<pre><code>mdanki Cassandra_Datastax_210_Anki.md Cassandra_Datastax_210_Anki.apkg --deck &quot;Mohan::Cassandra::DS210::Operations&quot;</code></pre>
<h2 id="cassandra-production-error">Cassandra production error</h2>
<ul>
<li>RANGE SLICE Messages were dropped</li>
<li>StorageProxy.readRegular(group, consistencyLevel, queryStartNanoTime);</li>
<li>SinglePartitionCommand.java[1176]/StorageProxy.read(this, consistency, clientState, queryStartNanoTime);</li>
</ul>
<h2 id="server-side---com.datastax.oss.driver.api.core.connection.connectionintiexception..-ssl-should-be-configured">(Server side) - com.datastax.oss.driver.api.core.connection.ConnectionIntiException.. ssl should be configured</h2>
<ul>
<li><p>Client side should enable ssl ; true (in spring-boot application.yaml)</p>
<ul>
<li>spring.data.cassandra.ssl: true ## (Client side) - [SSLL SSLV3_ALERT_HANDSHAKE_FAILURE]</li>
</ul></li>
<li><p>Ensure you configured SSL on cient side ## (Client side) - Since you provided explicit contact points, the local DC must be explicitly set (see basic.load-balancing-policy.local-datacenter)</p></li>
<li><p>spring.data.cassandra.local-datacenter: asiapac ## Cassandra read - query timedout out after PT2S</p></li>
<li><h2 id="data-types">Data types</h2></li>
<li><p>Text</p></li>
<li><p>timestamp – we can use in query like added_date &gt; ‘2013-03-17’;</p></li>
</ul>
<h2 id="how-to-connect-to-cassandra-from-api">How to connect to Cassandra from API</h2>
<ol type="1">
<li>Create Cluster object</li>
<li>Create Session object</li>
<li>Execute Query using session and retrieve the result</li>
</ol>
<div class="sourceCode" id="cb39"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>Cluster cluster <span class="op">=</span> Cluster<span class="op">.</span><span class="fu">builder</span><span class="op">().</span><span class="fu">addContactPoint</span><span class="op">(</span><span class="st">&quot;127.0.0.1&quot;</span><span class="op">).</span><span class="fu">build</span><span class="op">()</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>Session session <span class="op">=</span> cluster<span class="op">.</span><span class="fu">connect</span><span class="op">(</span><span class="st">&quot;KillrVideo&quot;</span><span class="op">)</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="bu">ResultSet</span> result <span class="op">=</span> session<span class="op">.</span><span class="fu">execute</span><span class="op">(</span><span class="st">&quot;select * from videos_by_tag where tag=&#39;cassandra&#39;&quot;</span><span class="op">);</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="dt">boolean</span> columnExists <span class="op">=</span> result<span class="op">.</span><span class="fu">getColumnDefinitions</span><span class="op">().</span><span class="fu">asList</span><span class="op">().</span><span class="fu">stream</span><span class="op">().</span><span class="fu">anyMatch</span><span class="op">(</span>cl <span class="op">-&gt;</span> cl<span class="op">.</span><span class="fu">getName</span><span class="op">().</span><span class="fu">equals</span><span class="op">(</span><span class="st">&quot;publisher&quot;</span><span class="op">));</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a><span class="bu">List</span><span class="op">&lt;</span><span class="bu">Book</span><span class="op">&gt;</span> books <span class="op">=</span> <span class="kw">new</span> <span class="bu">ArrayList</span><span class="op">&lt;</span><span class="bu">Book</span><span class="op">&gt;();</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>result<span class="op">.</span><span class="fu">forEach</span><span class="op">(</span>r <span class="op">-&gt;</span> <span class="op">{</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>   books<span class="op">.</span><span class="fu">add</span><span class="op">(</span><span class="kw">new</span> <span class="bu">Book</span><span class="op">(</span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>      r<span class="op">.</span><span class="fu">getUUID</span><span class="op">(</span><span class="st">&quot;id&quot;</span><span class="op">),</span> </span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>      r<span class="op">.</span><span class="fu">getString</span><span class="op">(</span><span class="st">&quot;title&quot;</span><span class="op">),</span>  </span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>      r<span class="op">.</span><span class="fu">getString</span><span class="op">(</span><span class="st">&quot;subject&quot;</span><span class="op">)));</span></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a><span class="op">});</span></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a><span class="cf">return</span> books<span class="op">;</span></span></code></pre></div>
<h2 id="to-setup-python">TO setup python</h2>
<div class="sourceCode" id="cb40"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> <span class="at">-m</span> pip install <span class="at">--upgrade</span> pip</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install cassandra-driver</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="kw">``</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="kw">```</span><span class="ex">python</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="ex">from</span> cassandra.cluster import Cluster</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="ex">cluster</span> = Cluster<span class="er">(</span><span class="ex">protocol_version</span> = 3<span class="kw">)</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a><span class="ex">session</span> = cluster.connect<span class="er">(</span><span class="st">&#39;Killrvideo&#39;</span><span class="kw">)</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a><span class="ex">result</span> = session.execute<span class="er">(</span><span class="st">&quot;select * from videos_by_tag where tag=&#39;cassandra&#39;&quot;</span><span class="kw">)</span><span class="ex">[0]</span><span class="kw">;</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a><span class="ex">print</span><span class="er">(</span><span class="st">&#39;{0:12} {1:40} {2:5}&#39;</span><span class="ex">.format</span><span class="er">(</span><span class="st">&#39;Tag&#39;</span><span class="ex">,</span> <span class="st">&#39;ID&#39;</span>, <span class="st">&#39;Title&#39;</span><span class="kw">))</span></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> val <span class="kw">in</span> session.execute<span class="er">(</span><span class="st">&quot;select * from videos_by_tag&quot;</span><span class="kw">)</span><span class="bu">:</span></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>   <span class="ex">print</span><span class="er">(</span><span class="st">&#39;{0:12} {1:40} {2:5}&#39;</span><span class="ex">.format</span><span class="er">(</span><span class="va">val</span><span class="op">[</span><span class="dv">0</span><span class="op">]</span><span class="ex">,</span> val[2], val[3]<span class="kw">))</span></span></code></pre></div>
<h2 id="cluster-level-monitoring">Cluster level monitoring</h2>
<ul>
<li>Current cluster availability</li>
<li>Current Storage Load</li>
<li>Average Cluster Availablity for Period</li>
<li>For Each datacenter
<ul>
<li><h1 id="of-client-requests">of client requests</h1></li>
</ul></li>
</ul>
<h2 id="top-worst-performing">Top worst performing</h2>
<ul>
<li>Top 5 worst performing nodes by client latency</li>
</ul>
<h2 id="list-monitoring-elements">List monitoring elements</h2>
<ol type="1">
<li>Node status</li>
<li>Disk Usage</li>
<li>Read Requests</li>
<li>Write Requests</li>
<li>Read Latency</li>
<li>Write Latency</li>
<li>Clients</li>
<li>Native Transport Requests</li>
<li>Compactions Pending</li>
<li>Dropped Mutations</li>
<li>Full GC Duration</li>
<li>Full GC Count</li>
<li>Heap memory usage</li>
<li>Off-Heap Memory Usage</li>
</ol>
<h2 id="list-table-level">List table level</h2>
<ol type="1">
<li>Read Latency</li>
<li>Write Latency</li>
<li>SSTable Count</li>
<li>SSTable Per Read</li>
<li>Table Disk Used</li>
<li>Table Row Size</li>
</ol>
<h2 id="node-status">Node Status</h2>
<h2 id="nodetool-usage">Nodetool usage</h2>
<ul>
<li></li>
</ul>
<div class="sourceCode" id="cb41"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>     <span class="ex">usage:</span> nodetool [<span class="er">(</span><span class="ex">-pwf</span> <span class="op">&lt;</span>passwordFilePath<span class="op">&gt;</span> <span class="kw">|</span> <span class="ex">--password-file</span> <span class="op">&lt;</span>passwordFilePath<span class="op">&gt;</span><span class="kw">)</span><span class="ex">]</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>          <span class="ex">[</span><span class="er">(</span><span class="ex">-u</span> <span class="op">&lt;</span>username<span class="op">&gt;</span> <span class="kw">|</span> <span class="ex">--username</span> <span class="op">&lt;</span>username<span class="op">&gt;</span><span class="kw">)</span><span class="ex">]</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>          <span class="ex">[</span><span class="er">(</span><span class="ex">-pw</span> <span class="op">&lt;</span>password<span class="op">&gt;</span> <span class="kw">|</span> <span class="ex">--password</span> <span class="op">&lt;</span>password<span class="op">&gt;</span><span class="kw">)</span><span class="ex">]</span> [<span class="er">(</span><span class="ex">-h</span> <span class="op">&lt;</span>host<span class="op">&gt;</span> <span class="kw">|</span> <span class="ex">--host</span> <span class="op">&lt;</span>host<span class="op">&gt;</span><span class="kw">)</span><span class="ex">]</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>          <span class="ex">[</span><span class="er">(</span><span class="ex">-p</span> <span class="op">&lt;</span>port<span class="op">&gt;</span> <span class="kw">|</span> <span class="ex">--port</span> <span class="op">&lt;</span>port<span class="op">&gt;</span><span class="kw">)</span><span class="ex">]</span> <span class="op">&lt;</span>command<span class="op">&gt;</span> [<span class="op">&lt;</span>args<span class="op">&gt;</span>]</span></code></pre></div>
<h2 id="nodetool-commands">Nodetool commands</h2>
<div class="sourceCode" id="cb42"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>     <span class="ex">The</span> most commonly used nodetool commands are:</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>     <span class="ex">assassinate</span>                  Forcefully remove a dead node without re-replicating any data.  Use as a last resort if you cannot removenode</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>     <span class="ex">bootstrap</span>                    Monitor/manage node-s bootstrap process</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>     <span class="ex">cleanup</span>                      Triggers the immediate cleanup of keys no longer belonging to a node. By default, clean all keyspaces</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>     <span class="ex">clearsnapshot</span>                Remove the snapshot with the given name from the given keyspaces. If no snapshotName is specified we will remove all snapshots</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>     <span class="ex">compact</span>                      Force a <span class="er">(</span><span class="ex">major</span><span class="kw">)</span> <span class="ex">compaction</span> on one or more tables or user-defined compaction on given SSTables</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>     <span class="ex">compactionhistory</span>            Print history of compaction</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>     <span class="ex">compactionstats</span>              Print statistics on compactions</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>     <span class="ex">decommission</span>                 Decommission the <span class="pp">*</span>node I am connecting to<span class="pp">*</span></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>     <span class="ex">describecluster</span>              Print the name, snitch, partitioner and schema version of a cluster</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>     <span class="ex">describering</span>                 Shows the token ranges info of a given keyspace</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>     <span class="ex">disableautocompaction</span>        Disable autocompaction for the given keyspace and table</span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>     <span class="ex">disablebackup</span>                Disable incremental backup</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>     <span class="ex">disablebinary</span>                Disable native transport <span class="er">(</span><span class="ex">binary</span> protocol<span class="kw">)</span></span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>     <span class="ex">disablegossip</span>                Disable gossip <span class="er">(</span><span class="ex">effectively</span> marking the node down<span class="kw">)</span></span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>     <span class="ex">disablehandoff</span>               Disable storing hinted handoffs</span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>     <span class="ex">disablehintsfordc</span>            Disable hints for a data center</span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a>     <span class="ex">disablethrift</span>                Disable thrift server</span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>     <span class="ex">drain</span>                        Drain the node <span class="er">(</span><span class="ex">stop</span> accepting writes and flush all tables<span class="kw">)</span></span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a>     <span class="ex">enableautocompaction</span>         Enable autocompaction for the given keyspace and table</span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a>     <span class="ex">enablebackup</span>                 Enable incremental backup</span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a>     <span class="ex">enablebinary</span>                 Reenable native transport <span class="er">(</span><span class="ex">binary</span> protocol<span class="kw">)</span></span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a>     <span class="ex">enablegossip</span>                 Reenable gossip</span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a>     <span class="ex">enablehandoff</span>                Reenable future hints storing on the current node</span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a>     <span class="ex">enablehintsfordc</span>             Enable hints for a data center that was previsouly disabled</span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a>     <span class="ex">enablethrift</span>                 Reenable thrift server</span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true" tabindex="-1"></a>     <span class="ex">failuredetector</span>              Shows the failure detector information for the cluster</span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true" tabindex="-1"></a>     <span class="ex">flush</span>                        Flush one or more tables</span>
<span id="cb42-29"><a href="#cb42-29" aria-hidden="true" tabindex="-1"></a>     <span class="ex">garbagecollect</span>               Remove deleted data from one or more tables</span>
<span id="cb42-30"><a href="#cb42-30" aria-hidden="true" tabindex="-1"></a>     <span class="ex">gcstats</span>                      Print GC Statistics</span>
<span id="cb42-31"><a href="#cb42-31" aria-hidden="true" tabindex="-1"></a>     <span class="ex">getcompactionthreshold</span>       Print min and max compaction thresholds for a given table</span>
<span id="cb42-32"><a href="#cb42-32" aria-hidden="true" tabindex="-1"></a>     <span class="ex">getcompactionthroughput</span>      Print the MB/s throughput cap for compaction in the system</span>
<span id="cb42-33"><a href="#cb42-33" aria-hidden="true" tabindex="-1"></a>     <span class="ex">getconcurrentcompactors</span>      Get the number of concurrent compactors in the system.</span>
<span id="cb42-34"><a href="#cb42-34" aria-hidden="true" tabindex="-1"></a>     <span class="ex">getendpoints</span>                 Print the end points that owns the key</span>
<span id="cb42-35"><a href="#cb42-35" aria-hidden="true" tabindex="-1"></a>     <span class="ex">getinterdcstreamthroughput</span>   Print the Mb/s throughput cap for inter-datacenter streaming in the system</span>
<span id="cb42-36"><a href="#cb42-36" aria-hidden="true" tabindex="-1"></a>     <span class="ex">getlogginglevels</span>             Get the runtime logging levels</span>
<span id="cb42-37"><a href="#cb42-37" aria-hidden="true" tabindex="-1"></a>     <span class="ex">getsstables</span>                  Print the sstable filenames that own the key</span>
<span id="cb42-38"><a href="#cb42-38" aria-hidden="true" tabindex="-1"></a>     <span class="ex">getstreamthroughput</span>          Print the Mb/s throughput cap for streaming in the system</span>
<span id="cb42-39"><a href="#cb42-39" aria-hidden="true" tabindex="-1"></a>     <span class="ex">gettimeout</span>                   Print the timeout of the given type in ms</span>
<span id="cb42-40"><a href="#cb42-40" aria-hidden="true" tabindex="-1"></a>     <span class="ex">gettraceprobability</span>          Print the current trace probability value</span>
<span id="cb42-41"><a href="#cb42-41" aria-hidden="true" tabindex="-1"></a>     <span class="ex">gossipinfo</span>                   Shows the gossip information for the cluster</span>
<span id="cb42-42"><a href="#cb42-42" aria-hidden="true" tabindex="-1"></a>     <span class="bu">help</span>                         Display help information</span>
<span id="cb42-43"><a href="#cb42-43" aria-hidden="true" tabindex="-1"></a>     <span class="ex">info</span>                         Print node information <span class="er">(</span><span class="fu">uptime</span>, load, ...<span class="kw">)</span></span>
<span id="cb42-44"><a href="#cb42-44" aria-hidden="true" tabindex="-1"></a>     <span class="ex">invalidatecountercache</span>       Invalidate the counter cache</span>
<span id="cb42-45"><a href="#cb42-45" aria-hidden="true" tabindex="-1"></a>     <span class="ex">invalidatekeycache</span>           Invalidate the key cache</span>
<span id="cb42-46"><a href="#cb42-46" aria-hidden="true" tabindex="-1"></a>     <span class="ex">invalidaterowcache</span>           Invalidate the row cache</span>
<span id="cb42-47"><a href="#cb42-47" aria-hidden="true" tabindex="-1"></a>     <span class="fu">join</span>                         Join the ring</span>
<span id="cb42-48"><a href="#cb42-48" aria-hidden="true" tabindex="-1"></a>     <span class="ex">listsnapshots</span>                Lists all the snapshots along with the size on disk and true size.</span>
<span id="cb42-49"><a href="#cb42-49" aria-hidden="true" tabindex="-1"></a>     <span class="ex">move</span>                         Move node on the token ring to a new token</span>
<span id="cb42-50"><a href="#cb42-50" aria-hidden="true" tabindex="-1"></a>     <span class="ex">netstats</span>                     Print network information on provided host <span class="er">(</span><span class="ex">connecting</span> node by default<span class="kw">)</span></span>
<span id="cb42-51"><a href="#cb42-51" aria-hidden="true" tabindex="-1"></a>     <span class="ex">pausehandoff</span>                 Pause hints delivery process</span>
<span id="cb42-52"><a href="#cb42-52" aria-hidden="true" tabindex="-1"></a>     <span class="ex">proxyhistograms</span>              Print statistic histograms for network operations</span>
<span id="cb42-53"><a href="#cb42-53" aria-hidden="true" tabindex="-1"></a>     <span class="ex">rangekeysample</span>               Shows the sampled keys held across all keyspaces</span>
<span id="cb42-54"><a href="#cb42-54" aria-hidden="true" tabindex="-1"></a>     <span class="ex">rebuild</span>                      Rebuild data by streaming from other nodes <span class="er">(</span><span class="ex">similarly</span> to bootstrap<span class="kw">)</span></span>
<span id="cb42-55"><a href="#cb42-55" aria-hidden="true" tabindex="-1"></a>     <span class="ex">rebuild_index</span>                A full rebuild of native secondary indexes for a given table</span>
<span id="cb42-56"><a href="#cb42-56" aria-hidden="true" tabindex="-1"></a>     <span class="ex">refresh</span>                      Load newly placed SSTables to the system without restart</span>
<span id="cb42-57"><a href="#cb42-57" aria-hidden="true" tabindex="-1"></a>     <span class="ex">refreshsizeestimates</span>         Refresh system.size_estimates</span>
<span id="cb42-58"><a href="#cb42-58" aria-hidden="true" tabindex="-1"></a>     <span class="ex">reloadlocalschema</span>            Reload local node schema from system tables</span>
<span id="cb42-59"><a href="#cb42-59" aria-hidden="true" tabindex="-1"></a>     <span class="ex">reloadtriggers</span>               Reload trigger classes</span>
<span id="cb42-60"><a href="#cb42-60" aria-hidden="true" tabindex="-1"></a>     <span class="ex">relocatesstables</span>             Relocates sstables to the correct disk</span>
<span id="cb42-61"><a href="#cb42-61" aria-hidden="true" tabindex="-1"></a>     <span class="ex">removenode</span>                   Show status of current node removal, force completion of pending removal or remove provided ID</span>
<span id="cb42-62"><a href="#cb42-62" aria-hidden="true" tabindex="-1"></a>     <span class="ex">repair</span>                       Repair one or more tables</span>
<span id="cb42-63"><a href="#cb42-63" aria-hidden="true" tabindex="-1"></a>     <span class="ex">replaybatchlog</span>               Kick off batchlog replay and wait for finish</span>
<span id="cb42-64"><a href="#cb42-64" aria-hidden="true" tabindex="-1"></a>     <span class="ex">resetlocalschema</span>             Reset node=s local schema and resync</span>
<span id="cb42-65"><a href="#cb42-65" aria-hidden="true" tabindex="-1"></a>     <span class="ex">resumehandoff</span>                Resume hints delivery process</span>
<span id="cb42-66"><a href="#cb42-66" aria-hidden="true" tabindex="-1"></a>     <span class="ex">ring</span>                         Print information about the token ring</span>
<span id="cb42-67"><a href="#cb42-67" aria-hidden="true" tabindex="-1"></a>     <span class="ex">scrub</span>                        Scrub <span class="er">(</span><span class="ex">rebuild</span> sstables for<span class="kw">)</span> <span class="ex">one</span> or more tables</span>
<span id="cb42-68"><a href="#cb42-68" aria-hidden="true" tabindex="-1"></a>     <span class="ex">setcachecapacity</span>             Set global key, row, and counter cache capacities <span class="er">(in</span> <span class="ex">MB</span> units<span class="kw">)</span></span>
<span id="cb42-69"><a href="#cb42-69" aria-hidden="true" tabindex="-1"></a>     <span class="ex">setcachekeystosave</span>           Set number of keys saved by each cache for faster post-restart warmup. 0 to disable</span>
<span id="cb42-70"><a href="#cb42-70" aria-hidden="true" tabindex="-1"></a>     <span class="ex">setcompactionthreshold</span>       Set min and max compaction thresholds for a given table</span>
<span id="cb42-71"><a href="#cb42-71" aria-hidden="true" tabindex="-1"></a>     <span class="ex">setcompactionthroughput</span>      Set the MB/s throughput cap for compaction in the system, or 0 to disable throttling</span>
<span id="cb42-72"><a href="#cb42-72" aria-hidden="true" tabindex="-1"></a>     <span class="ex">setconcurrentcompactors</span>      Set number of concurrent compactors in the system.</span>
<span id="cb42-73"><a href="#cb42-73" aria-hidden="true" tabindex="-1"></a>     <span class="ex">sethintedhandoffthrottlekb</span>   Set hinted handoff throttle in kb per second, per delivery thread.</span>
<span id="cb42-74"><a href="#cb42-74" aria-hidden="true" tabindex="-1"></a>     <span class="ex">setinterdcstreamthroughput</span>   Set the Mb/s throughput cap for inter-datacenter streaming in the system, or 0 to disable throttling</span>
<span id="cb42-75"><a href="#cb42-75" aria-hidden="true" tabindex="-1"></a>     <span class="ex">setlogginglevel</span>              Set the log level threshold for a given class. If both class and level are empty/null, it will reset to the initial configuration</span>
<span id="cb42-76"><a href="#cb42-76" aria-hidden="true" tabindex="-1"></a>     <span class="ex">setstreamthroughput</span>          Set the Mb/s throughput cap for streaming in the system, or 0 to disable throttling</span>
<span id="cb42-77"><a href="#cb42-77" aria-hidden="true" tabindex="-1"></a>     <span class="ex">settimeout</span>                   Set the specified timeout in ms, or 0 to disable timeout</span>
<span id="cb42-78"><a href="#cb42-78" aria-hidden="true" tabindex="-1"></a>     <span class="ex">settraceprobability</span>          Sets the probability for tracing any given request to value. 0 disables, 1 enables for all requests, 0 is the default</span>
<span id="cb42-79"><a href="#cb42-79" aria-hidden="true" tabindex="-1"></a>     <span class="ex">snapshot</span>                     Take a snapshot of specified keyspaces or a snapshot of the specified table</span>
<span id="cb42-80"><a href="#cb42-80" aria-hidden="true" tabindex="-1"></a>     <span class="ex">status</span>                       Print cluster information <span class="er">(</span><span class="ex">state,</span> load, IDs, ...<span class="kw">)</span></span>
<span id="cb42-81"><a href="#cb42-81" aria-hidden="true" tabindex="-1"></a>     <span class="ex">statusbackup</span>                 Status of incremental backup</span>
<span id="cb42-82"><a href="#cb42-82" aria-hidden="true" tabindex="-1"></a>     <span class="ex">statusbinary</span>                 Status of native transport <span class="er">(</span><span class="ex">binary</span> protocol<span class="kw">)</span></span>
<span id="cb42-83"><a href="#cb42-83" aria-hidden="true" tabindex="-1"></a>     <span class="ex">statusgossip</span>                 Status of gossip</span>
<span id="cb42-84"><a href="#cb42-84" aria-hidden="true" tabindex="-1"></a>     <span class="ex">statushandoff</span>                Status of storing future hints on the current node</span>
<span id="cb42-85"><a href="#cb42-85" aria-hidden="true" tabindex="-1"></a>     <span class="ex">statusthrift</span>                 Status of thrift server</span>
<span id="cb42-86"><a href="#cb42-86" aria-hidden="true" tabindex="-1"></a>     <span class="ex">stop</span>                         Stop compaction</span>
<span id="cb42-87"><a href="#cb42-87" aria-hidden="true" tabindex="-1"></a>     <span class="ex">stopdaemon</span>                   Stop cassandra daemon</span>
<span id="cb42-88"><a href="#cb42-88" aria-hidden="true" tabindex="-1"></a>     <span class="ex">tablehistograms</span>              Print statistic histograms for a given table</span>
<span id="cb42-89"><a href="#cb42-89" aria-hidden="true" tabindex="-1"></a>     <span class="ex">tablestats</span>                   Print statistics on tables</span>
<span id="cb42-90"><a href="#cb42-90" aria-hidden="true" tabindex="-1"></a>     <span class="ex">toppartitions</span>                Sample and print the most active partitions for a given column family</span>
<span id="cb42-91"><a href="#cb42-91" aria-hidden="true" tabindex="-1"></a>     <span class="ex">tpstats</span>                      Print usage statistics of thread pools</span>
<span id="cb42-92"><a href="#cb42-92" aria-hidden="true" tabindex="-1"></a>     <span class="ex">truncatehints</span>                Truncate all hints on the local node, or truncate hints for the endpoint<span class="er">(</span><span class="ex">s</span><span class="kw">)</span> <span class="ex">specified.</span></span>
<span id="cb42-93"><a href="#cb42-93" aria-hidden="true" tabindex="-1"></a>     <span class="ex">upgradesstables</span>              Rewrite sstables <span class="er">(</span><span class="cf">for</span> the <span class="ex">requested</span> tables<span class="kw">)</span> <span class="ex">that</span> are not on the current version <span class="er">(</span><span class="ex">thus</span> upgrading them to said current version<span class="kw">)</span></span>
<span id="cb42-94"><a href="#cb42-94" aria-hidden="true" tabindex="-1"></a>     <span class="ex">verify</span>                       Verify <span class="er">(</span><span class="ex">check</span> data checksum for<span class="kw">)</span> <span class="ex">one</span> or more tables</span>
<span id="cb42-95"><a href="#cb42-95" aria-hidden="true" tabindex="-1"></a>     <span class="ex">version</span>                      Print cassandra version</span>
<span id="cb42-96"><a href="#cb42-96" aria-hidden="true" tabindex="-1"></a>     <span class="ex">viewbuildstatus</span>              Show progress of a materialized view build</span>
<span id="cb42-97"><a href="#cb42-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-98"><a href="#cb42-98" aria-hidden="true" tabindex="-1"></a>     <span class="ex">See</span> <span class="st">&quot;nodetool help &lt;command&gt;&quot;</span> for more information on a specific command.</span></code></pre></div>
<ul>
<li><p><a href="https://www.youtube.com/watch?v=v1zkqHfSSUE">WORKSHOP: Opensource Tools for Apache Cassandra 24 Nov 20. Adam Zegelin SVP Engineering, Instaclustr</a></p></li>
<li><p><a href="https://www.youtube.com/watch?v=P6UkQJrEQyU">Best Practices of Cassandra in Production</a> ## What is repair?</p></li>
<li><p>Repair ensures that all replicas have identical copies of a given partition</p></li>
<li><p>Data won’t be in sync due to eventual consistency pattern, Merkel-Tree based reconciliation would help to fix the data.</p></li>
<li><p>It is also called anti-entropy repair.</p></li>
<li><p><a href="http://cassandra-reaper.io/">Cassandra reaper</a> is famous tool for scheduling repair</p></li>
<li><p>Reaper and nodetool repair works slightly different</p></li>
<li><p>Reaper repair mode</p>
<ul>
<li>sequential</li>
<li>requiresParallelism (Building merkle-tree or validation compaction would be parallel)</li>
<li>datacenter_aware
<ul>
<li>It is like sequential but one node per each DC</li>
</ul></li>
</ul></li>
</ul>
<h2 id="repair-service-on-opscenter">Repair Service (on OpsCenter)</h2>
<ol type="1">
<li>Runs in the background</li>
<li>Works on small chunks to limit performance impact</li>
<li>Continuously cycles within a specified time period</li>
<li>Can run in parallel</li>
<li>Can work on sub-ranges or incremental</li>
</ol>
<h2 id="repair-command">Repair command</h2>
<ul>
<li><code>bash     nodetool &lt;options&gt; repair     --dc &lt;dc_name&gt; identify data centers     --pr &lt;partitioner-range&gt; repair only primary range     --st &lt;start_token&gt; used when repairing a subrange     --et &lt;end_token&gt; used when repairing a subrange</code></li>
</ul>
<h2 id="why-repairs-are-necessary">Why repairs are necessary?</h2>
<ul>
<li>Nodes may go down for a period of time and miss writes
<ul>
<li>Especially if down for more than max_hint_window_in_ms</li>
</ul></li>
<li>If nodes become overloaded and drop writes</li>
<li>if dropped mutation is high repair was missing in its place</li>
</ul>
<h2 id="repair-guideline">Repair guideline</h2>
<ul>
<li>Make sure repair completes within gc_grace_seconds window</li>
<li>Repair should be scheduled once before every gc_grace_seconds</li>
</ul>
<h2 id="what-is-primary-range-repair">What is Primary Range Repair?</h2>
<ul>
<li>The primary range is the set of tokens the node is assigned</li>
<li>Repairing only the node’s primary range will make sure that data is synchronized for that range</li>
<li>Repairing only the node’s primary range will eliminate reduandant repairs</li>
</ul>
<h2 id="how-does-repair-work">How does repair work?</h2>
<ol type="1">
<li>Nodes build merkel-trees from partitions to represent how current data values are</li>
<li>Nodes exchange merkel trees</li>
<li>Nodes compare the merkel trees to identify specific values that need synchronization</li>
<li>Nodes exchange data values and update their data</li>
</ol>
<h2 id="events-that-trigger-repair">Events that trigger Repair</h2>
<ul>
<li>‘CL=Quorum’ - Read would trigger the repair</li>
<li>Random repair (even for non-quorum read)
<ul>
<li>read_repair_chance</li>
<li>dclocal_read-repair_chance</li>
</ul></li>
<li>Nodetool repair - externally triggered</li>
</ul>
<h2 id="dropped-mutation-vs-repair">Dropped Mutation vs Repair</h2>
<h2 id="if-10-nodes-equally-sharing-data-with-rf3-if-we-try-to-repair-nodetool-repair-on-node-3-how-many-node-will-be-involved-in-repair">If 10 nodes equally sharing data with RF=3, if we try to repair ‘nodetool repair on node-3’, How many node will be involved in repair?</h2>
<ul>
<li>5 nodes.</li>
<li>Node-3 will replicate its data to 2 other nodes (N3 (primary) + N4 (copy-1) + N5 (copy-2) )</li>
<li>Node-1 would use N3 for copy-2</li>
<li>Node-2 would use N3 for copy-1</li>
</ul>
<h2 id="how-to-specifically-use-only-one-node-to-repair-itself">How to specifically use only one node to repair itself</h2>
<ul>
<li>nodetool -pr node-3 –But we have to run in all the nodes immediately</li>
<li>runing nodetool -pr on only one node is <strong>not-recommended</strong></li>
</ul>
<h2 id="if-we-run-full-repair-on-a-n-node-cluster-with-rf3-how-many-times-we-are-repairing-the-data">If we run full repair on a ‘n’ node cluster with RF=3, How many times we are repairing the data?</h2>
<ul>
<li>We repair thrice.</li>
</ul>
<h2 id="developer-who-maintainspresented-about-reaper">Developer who maintains/presented about Reaper</h2>
<ul>
<li><a href="Alexandar%20Dejanvoski">Alexander Dejanovski</a></li>
<li><a href="https://www.slideshare.net/DataStax/real-world-tales-of-repair-alexander-dejanovski-the-last-pickle-cassandra-summit-2016">Real World Tales of Repair (Alexander Dejanovski, The Last Pickle) | Cassandra Summit 2016</a></li>
</ul>
<h2 id="repair-documentation">Repair documentation</h2>
<ul>
<li><a href="https://cassandra.apache.org/doc/latest/tools/nodetool/repair.html#nodetool-repair">All the options of nodetool-repair</a></li>
<li><a href="https://cassandra.apache.org/doc/latest/operating/repair.html">Cassandra documentation</a></li>
<li><a href="https://docs.datastax.com/en/cassandra-oss/3.x/cassandra/tools/toolsRepair.html">Datastax documentation</a></li>
</ul>
<h2 id="repair-and-some-number-related-to-time">Repair and some number related to time</h2>
<ul>
<li>First scheduled repair would always take more time</li>
<li>Repair scheduled often generally completes faster, since there are less data to repair</li>
<li>Few reported - it took 308+ hours to complete repair on 2.1.12 version</li>
<li>With 3 DC with 12 nodes, 4 tb of a keyspace took around 22 hours to repair it.</li>
</ul>
<h2 id="what-are-reaper-settings">What are Reaper settings</h2>
<ul>
<li>Segments per node</li>
<li>Tables</li>
<li>Blacklist</li>
<li>Nodes</li>
<li>Datacenters</li>
<li>Threads</li>
<li>Repair intensity</li>
</ul>
<h2 id="reaper-is-predominantly-used-for-repair-tasks">Reaper is predominantly used for repair tasks</h2>
<ul>
<li>Reaper uses concept called segments (despite in Cassandra world Segment means CommitLog)</li>
<li>As per Reaper, you need to use a segment for every 50mb, 20K Segment for every 1 TB</li>
<li>Smaller the segement, let reaper to repair it faster</li>
</ul>
<h2 id="repair-related-commands">Repair related commands</h2>
<div class="sourceCode" id="cb43"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="ex">nodetool</span> repair <span class="at">-dc</span> DC <span class="co">## is the command to repair using nodetool</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="ex">nodetool</span> <span class="at">-h</span> 1.1.1.1 status</span></code></pre></div>
<h2 id="reference-1">Reference</h2>
<ul>
<li><a href="https://www.youtube.com/watch?v=kl2ea0Cxmi0">Repair Improvements in Apache Cassandra 4.0 | DataStax</a></li>
<li><a href="http://datastax.com/dev/blog/repair-in-cassandra">Apache Cassandra Maintenance and Repair</a></li>
<li><a href="https://docs.datastax.com/en/dse/6.8/dse-arch/datastax_enterprise/dbArch/archAboutRepair.html">DSE 6.8 Architecture Guide, About Repair</a></li>
<li><a href="https://www.slideshare.net/DataStax/real-world-tales-of-repair-alexander-dejanovski-the-last-pickle-cassandra-summit-2016">Real World Tales of Repair (Alexander Dejanovski, The Last Pickle) | Cassandra Summit 2016</a></li>
<li><a href="https://cassandra.apache.org/doc/latest/operating/repair.html">Repair</a></li>
</ul>
<h2 id="how-to-create-anki-from-this-markdown-file-2">How to create anki from this markdown file</h2>
<pre><code>mdanki cassandra_repair_anki.md cassandra_repair_anki.apkg --deck &quot;Mohan::Cassandra::Repair::doc&quot;</code></pre>
<h2 id="create-keyspace-and-use-it">Create Keyspace (and use it)</h2>
<div class="sourceCode" id="cb45"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>## <span class="kw">Only</span> <span class="cf">when</span> <span class="kw">cluster</span> replication exercise</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> KEYSPACE killrvideo <span class="kw">WITH</span> replication <span class="op">=</span> {<span class="st">&#39;class&#39;</span>: <span class="st">&#39;NetworkTopologyStrategy&#39;</span>,<span class="st">&#39;east-side&#39;</span>: <span class="dv">1</span>,<span class="st">&#39;west-side&#39;</span>: <span class="dv">1</span>};</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> KEYSPACE killrvideo <span class="kw">WITH</span> replication <span class="op">=</span> {<span class="st">&#39;class&#39;</span>: <span class="st">&#39;SimpleStrategy&#39;</span>, <span class="st">&#39;replication_factor&#39;</span>: <span class="dv">1</span> };</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="kw">USE</span> killrvideo;</span></code></pre></div>
<h2 id="create-table-and-loadexport-data-in-and-out-of-tables">Create TABLE and load/export data in and out-of-tables</h2>
<div class="sourceCode" id="cb46"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> videos (video_id uuid,added_date <span class="dt">timestamp</span>,title text,<span class="kw">PRIMARY</span> <span class="kw">KEY</span> ((video_id)));</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="kw">insert</span> <span class="kw">into</span> videos (video_id, added_date, title) <span class="kw">values</span> (5645f8bd<span class="op">-</span>14bd<span class="op">-</span><span class="fl">11e5</span><span class="op">-</span>af1a<span class="op">-</span>8638355b8e3a, <span class="st">&#39;2014-02-28&#39;</span>,<span class="st">&#39;Cassndra History&#39;</span>)</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="co">-- docker cp  D:/git/cassandra_playground/labwork/data-files/videos.csv some-cassandra:/vidoes.csv</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="co">-- COPY videos(video_id, added_date, title) FROM &#39;~/labwork/data-files/videos.csv&#39; WITH HEADER=TRUE;</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> videos(video_id, added_date, title) <span class="kw">FROM</span> <span class="st">&#39;/videos.csv&#39;</span> <span class="kw">WITH</span> <span class="kw">HEADER</span><span class="op">=</span><span class="kw">TRUE</span>;</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> videos_by_tag (tag text,video_id uuid,added_date <span class="dt">timestamp</span>,title text,<span class="kw">PRIMARY</span> <span class="kw">KEY</span> ((tag), added_date, video_id)) <span class="kw">WITH</span> CLUSTERING <span class="kw">ORDER</span> <span class="kw">BY</span>(added_date <span class="kw">DESC</span>);</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a><span class="co">-- docker cp  D:/git/cassandra_playground/labwork/data-files/videos-by-tag.csv some-cassandra:/videos-by-tag.csv</span></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a><span class="co">-- COPY videos_by_tag(tag, video_id, added_date, title) FROM &#39;~/labwork/data-files/videos-by-tag.csv&#39; WITH HEADER=TRUE;</span></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> videos_by_tag(tag, video_id, added_date, title) <span class="kw">FROM</span> <span class="st">&#39;/videos-by-tag.csv&#39;</span> <span class="kw">WITH</span> <span class="kw">HEADER</span><span class="op">=</span><span class="kw">TRUE</span>;</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> killrvideo.videos_by_tag (tag, added_date, video_id, title) <span class="kw">VALUES</span> (<span class="st">&#39;cassandra&#39;</span>, <span class="st">&#39;2016-2-8&#39;</span>, uuid(), <span class="st">&#39;Me Lava Cassandra&#39;</span>);</span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a><span class="kw">UPDATE</span> killrvideo.videos_by_tag <span class="kw">SET</span> title <span class="op">=</span> <span class="st">&#39;Me LovEEEEEEEE Cassandra&#39;</span> <span class="kw">WHERE</span> tag <span class="op">=</span> <span class="st">&#39;cassandra&#39;</span> <span class="kw">AND</span> added_date <span class="op">=</span> <span class="st">&#39;2016-02-08&#39;</span> <span class="kw">AND</span> video_id <span class="op">=</span> paste_your_video_id;</span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a><span class="co">--Export data</span></span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> vidoes(video_id, added_date, title) <span class="kw">TO</span> <span class="st">&#39;/tmp/videos.csv&#39;</span> <span class="kw">WITH</span> <span class="kw">HEADER</span><span class="op">=</span><span class="kw">TRUE</span>;</span></code></pre></div>
<h2 id="how-to-select-token-values-of-primary-key">How to select token values of primary-key</h2>
<div class="sourceCode" id="cb47"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> token(tag), tag <span class="kw">FROM</span> killrvideo.videos_by_tag;</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="co">--output of gossip-info</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="kw">system</span>.token(tag)    | tag</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="co">----------------------+-----------</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a> <span class="op">-</span><span class="dv">1651127669401031945</span> |  datastax</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a> <span class="op">-</span><span class="dv">1651127669401031945</span> |  datastax</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>   <span class="dv">356242581507269238</span> | cassandra</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>   <span class="dv">356242581507269238</span> | cassandra</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>   <span class="dv">356242581507269238</span> | cassandra</span></code></pre></div>
<h2 id="cql-copy-and-rules">CQL Copy and rules</h2>
<ul>
<li>Cassandra expects same number of columns in every row (in delimited file)</li>
<li>Number of columns should match the table</li>
<li>Empty data in column is assumed by default as NULL value</li>
<li>COPY from should not be used to dump entire data (could be in TB or PB)</li>
<li>For importing larger datasets, use DSBulk</li>
<li>Can be piped with standar-input and standrd-outpu</li>
</ul>
<h2 id="cql-copy-options">CQL Copy options</h2>
<ol type="1">
<li>DELIMITER</li>
<li>HEADER</li>
<li>CHUNKSIZE - 1000 (default)</li>
<li>SKIPROW - number of rows to skip (for testing)</li>
</ol>
<h2 id="how-to-list-partition_key-or-the-actual-token-along-with-other-columns">How to list partition_key (or the actual token) along with other columns</h2>
<ul>
<li>USe token fucntion and pass all the parameter of the partition_key</li>
<li>select tag, title, video_added_date, token(tag) from videos_by_tag;</li>
<li>“InvalidRequest: code=2200 [Invalid query] message=”Invalid number of arguments in call to function token: 1 required but 2 provided”
<ul>
<li>When you pass clustering column that are not part of partition_key, CQL throws this error</li>
</ul></li>
</ul>
<h2 id="gosspinfo">Gosspinfo</h2>
<div class="sourceCode" id="cb48"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> peer, data_center, host_id, preferred_ip, rach, release_version, rpc_address, schema_version <span class="kw">FROM</span> <span class="kw">system</span>.peers;</span></code></pre></div>
<h2 id="nodetool-getendpoints-killrvideo-videos_by_tag-cassandra">nodetool getendpoints killrvideo videos_by_tag cassandra</h2>
<p>172.19.0.2</p>
<h2 id="what-are-all-the-system-schema">What are all the System Schema</h2>
<div class="sourceCode" id="cb49"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="ex">system</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="ex">system_auth</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="ex">system_distributed</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="ex">system_schema</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="ex">system_traces</span></span></code></pre></div>
<h2 id="see-how-many-rows-have-been-written-into-this-table-warning---row-scans-are-expensive-operations-on-large-tables">See how many rows have been written into this table (Warning - row scans are expensive operations on large tables)</h2>
<ul>
<li>SELECT COUNT (*) FROM user;</li>
</ul>
<h2 id="write-a-couple-of-rows-populate-different-columns-for-each-and-view-the-results">Write a couple of rows, populate different columns for each, and view the results</h2>
<ol type="1">
<li>INSERT INTO user (first_name, last_name, title) VALUES (‘Bill’, ‘Nguyen’, ‘Mr.’);</li>
<li>INSERT INTO user (first_name, last_name) VALUES (‘Mary’, ‘Rodriguez’);</li>
<li>SELECT * FROM user;</li>
</ol>
<h2 id="view-the-timestamps-generated-for-previous-writes">View the timestamps generated for previous writes</h2>
<ul>
<li>SELECT first_name, last_name, writetime(last_name) FROM user;</li>
</ul>
<h2 id="note-that-were-not-allowed-to-ask-for-the-timestamp-on-primary-key-columns">Note that we’re not allowed to ask for the timestamp on primary key columns</h2>
<ul>
<li>SELECT WRITETIME(first_name) FROM user;</li>
</ul>
<h2 id="set-the-timestamp-on-a-write">Set the timestamp on a write</h2>
<ul>
<li>UPDATE user USING TIMESTAMP 1434373756626000 SET last_name = ‘Boateng’ WHERE first_name = ‘Mary’ ;</li>
</ul>
<h2 id="verify-the-timestamp-used">Verify the timestamp used</h2>
<ul>
<li>SELECT first_name, last_name, WRITETIME(last_name) FROM user WHERE first_name = ‘Mary’;</li>
</ul>
<h2 id="view-the-time-to-live-value-for-a-column">View the time to live value for a column</h2>
<ul>
<li>SELECT first_name, last_name, TTL(last_name) FROM user WHERE first_name = ‘Mary’;</li>
</ul>
<h2 id="set-the-ttl-on-the-last-name-column-to-one-hour">Set the TTL on the last name column to one hour</h2>
<ul>
<li>UPDATE user USING TTL 3600 SET last_name = ‘McDonald’ WHERE first_name = ‘Mary’ ;</li>
</ul>
<h2 id="view-the-ttl-of-the-last_name---counting-down">View the TTL of the last_name - (counting down)</h2>
<ul>
<li>SELECT first_name, last_name, TTL(last_name) FROM user WHERE first_name = ‘Mary’;</li>
</ul>
<h2 id="find-the-token">Find the token</h2>
<ul>
<li>SELECT last_name, first_name, token(last_name) FROM user;</li>
</ul>
<h2 id="clear-the-screen-of-output-from-previous-commands">Clear the screen of output from previous commands</h2>
<ul>
<li>CLEAR</li>
</ul>
<h2 id="cassandra-dual-equivalent-table-and-sql">Cassandra Dual equivalent table and SQL</h2>
<div class="sourceCode" id="cb50"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fl">1.</span> <span class="kw">select</span> now() <span class="kw">from</span> <span class="kw">system</span>.<span class="kw">local</span>;</span></code></pre></div>
<h2 id="exit-cqlsh">Exit cqlsh</h2>
<ul>
<li>EXIT</li>
<li>Quit</li>
</ul>
<h2 id="reference-2">Reference</h2>
<ul>
<li><a href="https://www.datastax.com/blog/deep-look-cql-where-clause">A deep look at the CQL WHERE clause</a></li>
</ul>
<h2 id="storage-architecture">Storage Architecture</h2>
<ul>
<li>Only one commit log per cluster</li>
<li>Commit-logs are flused to (via MemTable) sstables</li>
<li>When memtables are flushed to disk, they are written as SSTables (fast compression used by default)</li>
<li>Memtable and SSTable is sorted by primary-key and clustering-key
<ul>
<li>A partition-key would be exist within SSTable only one page</li>
</ul></li>
<li>SSTable very poor to find absence of key (hence we need bloom-filter)</li>
</ul>
<h2 id="sstable---settings-in-cassandra.yaml">SStable - settings in cassandra.yaml</h2>
<ol type="1">
<li>flush_compression: fast</li>
<li>file_cache_enabled: false
<ul>
<li>The chunk cache will store recently accessed sections of the sstable in-memory as uncompressed buffers. - 32MB</li>
</ul></li>
<li>Memtable
<ol type="1">
<li>memtable_heap_space_in_mb: 2048</li>
<li>memtable_offheap_space_in_mb: 2048</li>
</ol></li>
<li>index_summary_capacity_in_mb (SSTable index summary)</li>
<li>index_summary_resize_interval_in_minutes
<ul>
<li>How frequently index summaries should be resampled</li>
</ul></li>
<li>compaction_throughput_mb_per_sec: 64</li>
<li>stream_entire_sstables: true</li>
<li>max_value_size_in_mb: 256</li>
</ol>
<h2 id="what-are-the-files-part-of-sstable">What are the files part of SSTable</h2>
<ul>
<li>mb-1-big-Summary.db</li>
<li>mb-1-big-Index.db</li>
<li>mb-1-big-Filter.db</li>
<li>mb-1-big-Data.db</li>
<li>SSTable metata files
<ul>
<li>mb-1-big-Digest.crc32</li>
<li>mb-1-big-Statistics.db</li>
<li>mb-1-big-CRC.db</li>
<li>mb-1-big-Toc.txt – list of the above files</li>
</ul></li>
</ul>
<h2 id="what-is-the-role-of-index-file">What is the role of index file</h2>
<ul>
<li>It lists the partition-keys/cluster-keys that are available inside the SSTable with offset information. Disk seek can directly locate few keys</li>
</ul>
<h2 id="what-is-the-role-of-statitics-file">What is the role of statitics file</h2>
<ul>
<li>It has the column definition</li>
<li>It has almost all the details about DDL of a table</li>
</ul>
<h2 id="why-sqlite4-didnt-use-lsm">Why SQLite4 didn’t use LSM?</h2>
<ul>
<li>Every insert needs to check constraint, and it requires reads. In simple, every write operation also ends up with read operation.</li>
<li>LSM is great for blind writes, but doesn’t work work as well when constraints must be checked prior to each write</li>
</ul>
<h2 id="lsm-pros-and-cons">LSM Pros and Cons</h2>
<ul>
<li>Pros
<ul>
<li>Faster writes</li>
<li>Reduced write amplification</li>
<li>Linear Writes</li>
<li>Less SSD Wear</li>
</ul></li>
<li>Cons
<ul>
<li>Slower Reads</li>
<li>Background Merge process</li>
<li>More space on disk</li>
<li>Greater Complexity</li>
</ul></li>
</ul>
<h2 id="sstable-references">SSTable references</h2>
<ul>
<li><a href="https://www.slideshare.net/DataStax/what-is-in-all-of-those-sstable-files-not-just-the-data-one-but-all-the-rest-too-john-schulz-the-pythian-group-cassandra-summit-2016">What is in All of Those SSTable Files Not Just the Data One but All the Rest Too! (John Schulz, The Pythian Group) | Cassandra Summit 2016</a></li>
<li><a href="https://blog.pythian.com/so-you-have-a-broken-cassandra-sstable-file/">So you have a broken Cassandra SSTable file?</a></li>
<li><a href="https://www.slideshare.net/InsightTechnology/dbtstky2017-c23-sqlite?from_action=save">C23: Lessons from SQLite4 by SQLite.org - Richard Hipp</a> ## DSE Cassandra Course topics</li>
</ul>
<ol type="1">
<li>Install and Start Apache Cassandra™</li>
<li>CQL</li>
<li>Partitions</li>
<li>Clustering Columns</li>
<li>Application Connectivity and Drivers</li>
<li>Node</li>
<li>Ring</li>
<li>VNodes</li>
<li>Gossip</li>
<li>Snitches</li>
<li>Replication</li>
<li>Consistency Levels</li>
<li>Hinted Handoff</li>
<li>Read Repair</li>
<li>Node Sync</li>
<li>Write Path</li>
<li>Read Path</li>
<li>Compaction</li>
<li>Advanced Performance</li>
</ol>
<h2 id="course-dse-installation">Course DSE installation</h2>
<div class="sourceCode" id="cb51"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="ex">ubuntu@ds201-node1:~$</span> tar <span class="at">-xf</span> dse-6.0.0-bin.tar.gz</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mv</span> dse-6.0.0 node</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="bu">.</span> labwork/config_node</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> node/bin</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a><span class="ex">./dse</span> cassandra</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a><span class="ex">./dsetool</span> status</span></code></pre></div>
<h2 id="nodetool-vs-dsetool">Nodetool vs DSEtool</h2>
<ul>
<li>nodetool – only Apache Cassandra</li>
<li>dsetool – Apache Cassandra™, Apache Spark™, Apache Solr™, Graph</li>
</ul>
<h2 id="nodetool-gauge-the-server-performance">Nodetool Gauge the server performance</h2>
<div class="sourceCode" id="cb52"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>.<span class="op">/</span>nodetool describecluster</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>.<span class="op">/</span>nodetool getlogginglevels</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>.<span class="op">/</span>nodetool setlogginglevels org.apache.cassandra <span class="kw">TRACE</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>## <span class="kw">Create</span> <span class="kw">and</span> populate garbage <span class="kw">to</span> stress <span class="kw">the</span> <span class="kw">cluster</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a><span class="op">/</span>home<span class="op">/</span>ubuntu<span class="op">/</span>node<span class="op">/</span>resources<span class="op">/</span>cassandra<span class="op">/</span>tools<span class="op">/</span>bin<span class="op">/</span>cassandra<span class="op">-</span>stress <span class="kw">write</span> n<span class="op">=</span><span class="dv">50000</span> <span class="kw">no</span><span class="op">-</span>warmup <span class="op">-</span>rate threads<span class="op">=</span><span class="dv">2</span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>.<span class="op">/</span>nodetool <span class="kw">flush</span></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>.<span class="op">/</span>nodetool status</span></code></pre></div>
<h2 id="find-all-the-material-view-of-a-keyspace">Find all the material view of a keyspace</h2>
<div class="sourceCode" id="cb53"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="ex">SELECT</span> view_name FROM system_schema.views where keyspace_name=<span class="st">&#39;myKeyspace&#39;</span><span class="kw">;</span></span></code></pre></div>
<h2 id="how-to-find-number-of-partitionsnode-of-partition-in-a-table">How to find number of partitions/node-of partition in a table</h2>
<ul>
<li>./nodetool tablestats -H keyspace.tablename;</li>
<li>select token(tag) from killrvideo.videos_by_tag;
<ul>
<li>./nodetool getendpoints killrvideo videos_by_tag -1651127669401031945</li>
<li>./nodetool getendpoints keyspace table_name #token_number;</li>
<li>./nodetool ring</li>
<li>./nodetool getendpoints killrvideo videos_by_tag ‘cassandra’</li>
<li>./nodetool getendpoints killrvideo videos_by_tag ‘datastax’</li>
</ul></li>
</ul>
<h2 id="cassandra-node-servervmhw">Cassandra Node (Server/VM/H/W)</h2>
<ul>
<li>Runs a java process (JVM)</li>
<li>Only supported on local storage or direct attached storage</li>
<li>If your disk has ethernet cable, It is wrong choice
<ul>
<li>Don’t run it on SAN (not supported)</li>
</ul></li>
<li>Typically 6000-12000 TXN per second / core</li>
<li>How much data a single Cassandra node can handle?
<ul>
<li>2 -to- 4 TB</li>
</ul></li>
<li>How do you manage node?
<ul>
<li>Use nodetool utilitiy</li>
</ul></li>
</ul>
<h2 id="cassandra-ring-the-cluster">Cassandra Ring (The cluster)</h2>
<ul>
<li>Any node can act as a co-ordinator to incoming data</li>
<li>How does co-ordinator knows the node that handles the data?
<ul>
<li>Co-ordinator has token-range, Token range is all about paritition key range and node</li>
<li>(2^^63)-1 –&gt; (-2^^63) - ranges of tokents are available</li>
<li>20 digit number - 18,446,744,073,709,551,616</li>
</ul></li>
</ul>
<h2 id="how-new-nodes-join-the-ring">How new nodes join the ring</h2>
<ul>
<li>Uses seed-nodes configured in new-nodes Cassandra.yaml
<ul>
<li>SeedNode provider could be rest-api</li>
</ul></li>
<li>Node joins by communicating with any seed-nodes</li>
<li>Seed nodes communicate cluster topology to the joining node</li>
<li>Once the new-node joins the cluster, all the nodes are peers
<ul>
<li>Node status could be - Leaving/Joining/Up/Running - UN (Up and Normal)</li>
</ul></li>
</ul>
<h2 id="peer-to-peer-1">Peer-to-Peer</h2>
<ul>
<li>Leader-Follower fails when we do sharding
<ul>
<li>Leader-Follower model is just client-server model on the service side</li>
</ul></li>
<li>Leader follower would fail other leaders are read-replicas, and also supports sharding</li>
<li>If Leader and follower can’t each other due to network glitch, It becomes even more error prone.</li>
<li>In Cassandra, It is peer-to-peer
<ul>
<li>No node is superior than other</li>
<li>Everyone is peer</li>
</ul></li>
</ul>
<h2 id="why-do-we-need-vnode">Why do we need VNode?</h2>
<ul>
<li>When adding a new physical node, how to equally distribute data from existing nodes into new node?</li>
<li>If overloaded node, is distributing data to new node, it would become additional burden for existing overloaded node</li>
<li>VNode also help distributing data consistently acorss nodes
<ul>
<li>Without vnode, Cluster has to store continuous sequential ranges of data into node</li>
<li>VNode automate token range assignment</li>
</ul></li>
<li>It helps making easier to bootstrap new node</li>
<li>Adding/removing nodes with vnodes helps keep the cluster balanced</li>
<li>By default each node has 128 vnodes</li>
</ul>
<h2 id="how-to-enable-vnode">How to enable VNode?</h2>
<ul>
<li>num_tokens value should greather than 1 in Cassandra.yaml</li>
<li>num_tokens = 1 ## Disable vnode</li>
</ul>
<h2 id="gossip-protocol-nodemeta-data-is-the-subject">Gossip protocol (nodemeta data is the subject)</h2>
<ul>
<li>No centralized service to spread the information - How do we share information?</li>
<li>Gossip protocol helps to spread information (despite peer-to-peer)</li>
<li>Every second a node pick one-to-three other nodes to gossip with
<ul>
<li>It might pick same node successive time, they don’t keep track of the node that they gossped with</li>
</ul></li>
</ul>
<h2 id="what-do-nodes-gossip-about">What do nodes Gossip about?</h2>
<ul>
<li>They gossip about node-meta-data
<ul>
<li>Heartbeat, generation, version and load</li>
</ul></li>
<li>What is the difference between generation and version?
<ul>
<li>Generation - timestamp of when the node-bootstraps</li>
<li>version - counter incremented every-second</li>
</ul></li>
</ul>
<h2 id="what-is-gossip-data-structure-look-like">What is Gossip data structure look like?</h2>
<ul>
<li><p>EP: 127.0.0.1, HB:100:20, LOAD:86</p></li>
<li><p>Endpoint, HeartBeat:generation:version, Load</p></li>
<li><p><code>json     EndPointState {       HeartBeatState: {         Generation: 5,         Version: 22       },       ApplicationState: {         Status: Normal/Leaving/Left/Joining/Removing,         DC: CDC1,         RACK: sg-2a,         SCHEMA: c2acbn,         Severity=0.75,       }     }</code></p></li>
</ul>
<h2 id="what-is-gossip-protocol">What is Gossip protocol?</h2>
<ul>
<li>Initiator - Sends SYN</li>
<li>Receiver - Receives SYN and Constructs and replies with ACK message</li>
<li>Initiator - Gets ACK reponse from receiver<br />
</li>
<li>Initiator - ACKs the ACK (from receiver) using ACK2 reponse</li>
</ul>
<h2 id="how-to-find-more-details-about-gossip">How to find more details about Gossip</h2>
<ul>
<li>project = CASSANDRA AND component = “Cluster/Gossip”</li>
<li>https://issues.apache.org/jira/browse/CASSANDRA-16588?jql=project%20%3D%20CASSANDRA%20AND%20component%20%3D%20%22Cluster%2FGossip%22</li>
</ul>
<h2 id="sample-gossipinfo">Sample Gossipinfo</h2>
<div class="sourceCode" id="cb54"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="er">ubuntu@ds201-node1:~/node1/bin$</span> <span class="er">./nodetool</span> <span class="er">gossipinfo</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="er">/127.0.0.1</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>  <span class="er">generation:1623251077</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>  <span class="er">heartbeat:732</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>  <span class="er">STATUS:32:NORMAL,-117951217631614635</span></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>  <span class="er">LOAD:717:6930897.0</span></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>  <span class="er">SCHEMA:322:08e0aca4-d15e-3357-8876-0e7cc6cc60ba</span></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>  <span class="er">DC:50:Cassandra</span></span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>  <span class="er">RACK:18:rack1</span></span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>  <span class="er">RELEASE_VERSION:4:4.0.0.2284</span></span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>  <span class="er">NATIVE_TRANSPORT_ADDRESS:3:127.0.0.1</span></span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>  <span class="er">X_11_PADDING:677:</span><span class="fu">{</span><span class="dt">&quot;dse_version&quot;</span><span class="fu">:</span><span class="st">&quot;6.0.0&quot;</span><span class="fu">,</span><span class="dt">&quot;workloads&quot;</span><span class="fu">:</span><span class="st">&quot;Cassandra&quot;</span><span class="fu">,</span><span class="dt">&quot;workload&quot;</span><span class="fu">:</span><span class="st">&quot;Cassandra&quot;</span><span class="fu">,</span><span class="dt">&quot;active&quot;</span><span class="fu">:</span><span class="st">&quot;true&quot;</span><span class="fu">,</span><span class="dt">&quot;server_id&quot;</span><span class="fu">:</span><span class="st">&quot;08-00-27-32-1E-DD&quot;</span><span class="fu">,</span><span class="dt">&quot;graph&quot;</span><span class="fu">:</span><span class="kw">false</span><span class="fu">,</span><span class="dt">&quot;health&quot;</span><span class="fu">:</span><span class="fl">0.1</span><span class="fu">}</span></span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>  <span class="er">NET_VERSION:1:256</span></span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>  <span class="er">HOST_ID:2:d8e387df-71c3-4584-b911-bb8867f66b8b</span></span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a>  <span class="er">NATIVE_TRANSPORT_READY:86:true</span></span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>  <span class="er">NATIVE_TRANSPORT_PORT:6:9041</span></span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a>  <span class="er">NATIVE_TRANSPORT_PORT_SSL:7:9041</span></span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a>  <span class="er">STORAGE_PORT:8:7000</span></span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a>  <span class="er">STORAGE_PORT_SSL:9:7001</span></span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a>  <span class="er">JMX_PORT:10:7199</span></span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a>  <span class="er">TOKENS:31:&lt;hidden&gt;</span></span>
<span id="cb54-22"><a href="#cb54-22" aria-hidden="true" tabindex="-1"></a><span class="er">/127.0.0.2</span></span>
<span id="cb54-23"><a href="#cb54-23" aria-hidden="true" tabindex="-1"></a>  <span class="er">generation:1623251055</span></span>
<span id="cb54-24"><a href="#cb54-24" aria-hidden="true" tabindex="-1"></a>  <span class="er">heartbeat:736</span></span>
<span id="cb54-25"><a href="#cb54-25" aria-hidden="true" tabindex="-1"></a>  <span class="er">STATUS:61:NORMAL,-1182052107726675062</span></span>
<span id="cb54-26"><a href="#cb54-26" aria-hidden="true" tabindex="-1"></a>  <span class="er">LOAD:699:7303102.0</span></span>
<span id="cb54-27"><a href="#cb54-27" aria-hidden="true" tabindex="-1"></a>  <span class="er">SCHEMA:328:08e0aca4-d15e-3357-8876-0e7cc6cc60ba</span></span>
<span id="cb54-28"><a href="#cb54-28" aria-hidden="true" tabindex="-1"></a>  <span class="er">DC:65:Cassandra</span></span>
<span id="cb54-29"><a href="#cb54-29" aria-hidden="true" tabindex="-1"></a>  <span class="er">RACK:18:rack1</span></span>
<span id="cb54-30"><a href="#cb54-30" aria-hidden="true" tabindex="-1"></a>  <span class="er">RELEASE_VERSION:4:4.0.0.2284</span></span>
<span id="cb54-31"><a href="#cb54-31" aria-hidden="true" tabindex="-1"></a>  <span class="er">NATIVE_TRANSPORT_ADDRESS:3:127.0.0.1</span></span>
<span id="cb54-32"><a href="#cb54-32" aria-hidden="true" tabindex="-1"></a>  <span class="er">X_11_PADDING:680:</span><span class="fu">{</span><span class="dt">&quot;dse_version&quot;</span><span class="fu">:</span><span class="st">&quot;6.0.0&quot;</span><span class="fu">,</span><span class="dt">&quot;workloads&quot;</span><span class="fu">:</span><span class="st">&quot;Cassandra&quot;</span><span class="fu">,</span><span class="dt">&quot;workload&quot;</span><span class="fu">:</span><span class="st">&quot;Cassandra&quot;</span><span class="fu">,</span><span class="dt">&quot;active&quot;</span><span class="fu">:</span><span class="st">&quot;true&quot;</span><span class="fu">,</span><span class="dt">&quot;server_id&quot;</span><span class="fu">:</span><span class="st">&quot;08-00-27-32-1E-DD&quot;</span><span class="fu">,</span><span class="dt">&quot;graph&quot;</span><span class="fu">:</span><span class="kw">false</span><span class="fu">,</span><span class="dt">&quot;health&quot;</span><span class="fu">:</span><span class="fl">0.1</span><span class="fu">}</span></span>
<span id="cb54-33"><a href="#cb54-33" aria-hidden="true" tabindex="-1"></a>  <span class="er">NET_VERSION:1:256</span></span>
<span id="cb54-34"><a href="#cb54-34" aria-hidden="true" tabindex="-1"></a>  <span class="er">HOST_ID:2:55c76577-e187-4948-807f-a95026a7c4dd</span></span>
<span id="cb54-35"><a href="#cb54-35" aria-hidden="true" tabindex="-1"></a>  <span class="er">NATIVE_TRANSPORT_READY:95:true</span></span>
<span id="cb54-36"><a href="#cb54-36" aria-hidden="true" tabindex="-1"></a>  <span class="er">NATIVE_TRANSPORT_PORT:6:9042</span></span>
<span id="cb54-37"><a href="#cb54-37" aria-hidden="true" tabindex="-1"></a>  <span class="er">NATIVE_TRANSPORT_PORT_SSL:7:9042</span></span>
<span id="cb54-38"><a href="#cb54-38" aria-hidden="true" tabindex="-1"></a>  <span class="er">STORAGE_PORT:8:7000</span></span>
<span id="cb54-39"><a href="#cb54-39" aria-hidden="true" tabindex="-1"></a>  <span class="er">STORAGE_PORT_SSL:9:7001</span></span>
<span id="cb54-40"><a href="#cb54-40" aria-hidden="true" tabindex="-1"></a>  <span class="er">JMX_PORT:10:7299</span></span>
<span id="cb54-41"><a href="#cb54-41" aria-hidden="true" tabindex="-1"></a>  <span class="er">TOKENS:60:&lt;hidden&gt;</span></span></code></pre></div>
<h2 id="node-failure-detector">Node failure detector</h2>
<ul>
<li>Every node declares their own status.</li>
<li>Every node detects failure of peer-node</li>
<li>They don’t send their assumptions/evaluations during gossip (nodes don’t send their judgement about other nodes)</li>
</ul>
<h2 id="snitch-meaning-informer">Snitch (meaning informer)</h2>
<ul>
<li>Snitch - toplogy of cluster</li>
<li>Informs each IP and its physical location
<ul>
<li>DC and Rack</li>
</ul></li>
<li>HttpPropertyFileSnitch</li>
<li>SimpleSnitch</li>
<li>Cloud-Based snitches
<ul>
<li>EC2Snitch</li>
<li>EC2MultiRegionSnitch</li>
<li>RackInferrringSnitch</li>
<li>GoogleCloudSnitch</li>
<li>CloudStackSnitch</li>
</ul></li>
<li>PropertyFileSnitch</li>
<li>RackInferingSnitch (don’t rely on it)
<ul>
<li>ip=DC1:RACK2</li>
<li>ip2=DC2:RACK2</li>
<li>110:100:200:105
<ul>
<li>110 - Country (ignored by snitcher)</li>
<li>100 - DC octet (second ip octet)</li>
<li>200 - rack octet</li>
<li>105 - node octet</li>
</ul></li>
<li>cassandra-rackdc.properties can contain the data</li>
</ul></li>
</ul>
<h2 id="what-is-the-role-of-dynamicsnitch">What is the role of DynamicSnitch</h2>
<ul>
<li>It uses underlying snitch</li>
<li>Maintains pulse of each nodes performance</li>
<li>Determines which node to query based on performance</li>
<li>Turned on by default for all snitches</li>
</ul>
<h2 id="mandatory-operational-practice">Mandatory operational practice</h2>
<ul>
<li>All nodes should use same snitch</li>
<li>Changing network topology requires restarting all the nodes with latest snitch</li>
<li>Run sequential repair and cleanup on each node</li>
</ul>
<h2 id="replication-with-rf1">Replication with RF=1</h2>
<ul>
<li>Every node is responsible for certain token range</li>
<li>Partitioner finds the token from the data (MurMurPartitioner)</li>
<li>RF=1 - Only one copy of the data (source alone)</li>
<li>Let us say we have token range or 0, 13, 25, 38, 50, 63, 75, 88, 100</li>
<li>If we try to insert data with token value of 59.
<ul>
<li>Node that owns token higher than 59 is (here 63 is choosen)</li>
<li>Node that owns 50 and above.. but below 63 would store the data</li>
</ul></li>
</ul>
<h2 id="replication-with-rf2">Replication with RF&gt;=2</h2>
<ul>
<li>Data would be stored in node that supposed to own token range</li>
<li>For every RF&gt;1, Node who is neighbour (token range higher) also gets copy of the data</li>
<li>Let us say if we try to store token()==59 and RF=2
<ul>
<li>Node that owns 50-63 would get a copy</li>
<li>Node that owns 63-75 would also get a copy</li>
</ul></li>
</ul>
<h2 id="replication-with-rf2-and-cross-datacenter">Replication with RF&gt;=2 and Cross DataCenter</h2>
<ul>
<li>Cross DC replication is hard</li>
<li>We can have different RF for each DC</li>
<li>Country specific replication can be controlled at the keyspace level</li>
<li>Remote Co-ordinator would act as a local-cordinator to replicate data within remote DC</li>
</ul>
<h2 id="consistency-in-cql">Consistency in CQL</h2>
<div class="sourceCode" id="cb55"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>consistency <span class="kw">ANY</span>;</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>##Consistency <span class="kw">level</span> <span class="kw">set</span> <span class="kw">to</span> <span class="kw">ANY</span>.</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> videos_by_tag;</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>##InvalidRequest: Error <span class="kw">from</span> server: code<span class="op">=</span><span class="dv">2200</span> [Invalid <span class="kw">query</span>] message<span class="op">=</span><span class="ot">&quot;ANY ConsistencyLevel is only supported for writes&quot;</span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> videos_by_tag(tag, added_date, video_id, title)  <span class="kw">VALUES</span> (<span class="st">&#39;cassandra&#39;</span>, <span class="st">&#39;2016-2-11&#39;</span>, uuid(), <span class="st">&#39;Cassandra, Take Me Home&#39;</span>);</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> videos_by_tag;InvalidRequest: Error <span class="kw">from</span> server: code<span class="op">=</span><span class="dv">2200</span> [Invalid <span class="kw">query</span>] message<span class="op">=</span><span class="ot">&quot;ANY ConsistencyLevel is only supported for writes&quot;</span></span></code></pre></div>
<h2 id="reference-3">Reference</h2>
<ul>
<li><a href="https://www.youtube.com/watch?v=69pvhO6mK_o&amp;list=PL2g2h-wyI4Spf5rzSmesewHpXYVnyQ2TS">Datastax videos</a></li>
<li><a href="https://s3.amazonaws.com/datastaxtraining/VM/DS201-VM-6.0.ova">Datastax Virtual-box VM</a></li>
</ul>
<h2 id="time-series-presentations">Time-series presentations</h2>
<ol type="1">
<li>(https://www.youtube.com/watch?v=nHes8XW1VHw)</li>
<li>(https://www.youtube.com/watch?v=YewOx6En7WM)</li>
<li>(https://www.youtube.com/watch?v=3yhd073ad5w)</li>
<li>(https://www.youtube.com/watch?v=jSRBCoOaz6I)</li>
<li>(https://www.youtube.com/watch?v=QwYH2EyKwNk)</li>
<li>(https://www.youtube.com/watch?v=4VBh6UQd6z8)</li>
<li>(https://www.youtube.com/watch?v=xVwo9lsrxfg)</li>
<li>(https://www.youtube.com/watch?v=AZB5DX9m7Hc)</li>
<li>(https://www.youtube.com/watch?v=3pPser3MYEE)</li>
<li>(https://www.youtube.com/watch?v=ovMo5pIMj8M)</li>
<li>(https://www.youtube.com/watch?v=iQBtkhvaOBM) ## What are Tombstones?</li>
</ol>
<ul>
<li>Dead cells (columns/rows) are kept it memory and disk, for other other nodes to aware about dead cells for 10-days.</li>
<li>When rows are queried, query has to scan over multiple expired cells/rows to get to the live cells</li>
</ul>
<h2 id="what-are-all-the-majore-issues-due-to-tombstones">What are all the majore issues due to Tombstones</h2>
<ul>
<li>Often query read ends up in timesout</li>
<li>Memory is occupied by dead-cells</li>
<li>Rarely TombstoneOverwhelmException happens</li>
</ul>
<h2 id="how-to-agressively-collect-tombstones-to-resolve-few-of-the-query-timeout-tactical-solution">How to agressively collect tombstones (to resolve few of the query timeout tactical solution)</h2>
<ol type="1">
<li>tombstone_threshold ratio to 0.1</li>
<li>unchecked_tombstone_compaction: true</li>
<li>min_threshold: 2 (Compaction would be triggered for just 2 similar sized SSTables)</li>
</ol>
<h2 id="where-is-tombstones-are-handled">Where is Tombstones are handled?</h2>
<ul>
<li>Tombstones are handled part of Compaction</li>
<li><a href="https://github.com/apache/cassandra/blob/cassandra-3.11/src/java/org/apache/cassandra/db/compaction/AbstractCompactionStrategy.java">AbstractCompactionStrategy</a>
<ul>
<li>protected boolean worthDroppingTombstones(SSTableReader sstable, int gcBefore)</li>
<li><code>java           System.currentTimeMillis() &gt; sstable.getCreationTimeFor(Component.DATA) + tombstoneCompactionInterval * 1000           AND           double droppableRatio = sstable.getEstimatedDroppableTombstoneRatio(gcBefore);           if (droppableRatio &gt; tombstoneThreshold=0.2f)</code> ## Hinted Handoff</li>
</ul></li>
<li>Simple sticky note on co-ordinator</li>
<li>Once actual node is available, Co-ordinator would deliver the message</li>
<li>Previous version used to store hinted-handoff in the table (not nowadays)</li>
<li>Cassandra is not good fit to design <em>Queue</em>, Hence hinted handoff is not stored in table</li>
<li>There after timeout exceeds hinted-handoff itself dropped
<ul>
<li>By default 2 hours</li>
</ul></li>
<li>How co-ordinator knows node came online?
<ul>
<li>Gossip protocol helps to trigger</li>
</ul></li>
<li>COnsistency level of ANY - Hinted handoff is considered as valid transaction</li>
</ul>
<h2 id="how-read-works">How read works?</h2>
<ul>
<li>Co-ordinator reads data from fastest machine</li>
<li>Co-ordinator reads checksum form other two machine</li>
<li>if 1 and 2, matches, then we co-ordinator responds to client queries</li>
</ul>
<h2 id="read-repair-happens-only-when-clall">Read Repair (Happens only when CL=All)</h2>
<ul>
<li>Over-time nodes goes out-of-sync</li>
<li>Every write chooses between availablity and consistency</li>
<li>When we choose availablity over consistency
<ul>
<li>We also agree that some inconsistency between server, data becomes out-of-sync</li>
</ul></li>
<li>When Co-ordinator observes data between 3 cluster is not valid, it does the following sequence
<ol type="1">
<li>Request all nodes to return latest copies of data</li>
<li>Every cell (column) has latest timestamp, Finds the latest timestamp data and latest copy is chosen as valid</li>
<li>It sends latest copies to two other nodes for them to udpate (their obsolete data is repaired)</li>
<li>Responds to client with latest result</li>
</ol></li>
</ul>
<h2 id="read-repair-chance-when-cl-all-less-than-all-consistency-read">Read Repair Chance (when CL &lt; ALL) (less than ALL consistency read)</h2>
<ul>
<li>Cassandra does read-repair even for request less than ALL, But not 100% but probablistically
<ul>
<li>Probability is configurable</li>
<li>dclocal_read_repair_chance - (0.1 – 10%)</li>
<li>read_repair_chance</li>
</ul></li>
<li>Client can’t be sure if data is latest or replicas are in sync</li>
<li>Read repair done asynchronously in the background</li>
</ul>
<h2 id="nodetool-repair">Nodetool repair</h2>
<ul>
<li>It is the last line of defence for us to improve consistency within stored data</li>
<li>Syncs all data in the cluster</li>
<li>Expensive
<ul>
<li>Grows with amount of data in cluster</li>
</ul></li>
<li>Use with clusters servicing high writes/deletes</li>
<li>Must run to synchronize a failed node coming back online</li>
<li>Run on nodes not read from very often</li>
</ul>
<h2 id="nodetool-sync-only-datastax">Nodetool Sync (only datastax)</h2>
<ul>
<li>Peforming full-repair is costly</li>
<li>Full-repair should be run before gc_grace_seconds</li>
<li>It is default and automatically enabled in datastax</li>
<li>Repairs in small chunks as we go rather than full repair
<ul>
<li>Create table myTable (…) WITH nodesync = {‘enabled’: ‘true’};</li>
</ul></li>
</ul>
<h2 id="nodetool-sync-save-points-only-datastax">Nodetool Sync Save points (only datastax)</h2>
<ul>
<li>Each node splits its local range into segments
<ul>
<li>Small token range of a table</li>
</ul></li>
<li>Each segment makes a save point
<ul>
<li>NodeSync repairs a segment</li>
<li>Then NodeSync saves its progress</li>
<li>Repeat</li>
<li>Save-point is the place where progress is stored</li>
</ul></li>
<li>NodeSync priorities segments to meet deadline target</li>
</ul>
<h2 id="nodetool-sync---segments-sizes">Nodetool Sync - Segments Sizes</h2>
<ul>
<li>Eache segment is less than 200MB</li>
<li>If a partition is great than 200MB win over segments less than 200MB</li>
<li>Each segment cannot be less than its partition size, hence if segments are larger .. it means partition was larger</li>
</ul>
<h2 id="nodetool-sync---segments-failures">Nodetool Sync - Segments failures</h2>
<ul>
<li>Node fails during segment validation, node drops all work for that segment and starts over</li>
<li>A segment repair is automic operation</li>
<li>system_distributed.nodesync_status table - has the information and progress</li>
<li>segment_outcomes
<ul>
<li>full_in_sync : All replicas were in sync</li>
<li>full_repaired : Some repair necessary</li>
<li>partial_in_sync : all respondent were in sync, but not all replicas responded</li>
<li>partial_repaired</li>
<li>uncompleted : one node availabled/responded; no validation occurred</li>
<li>failed: unexpected error happened; check logs.</li>
</ul></li>
</ul>
<h2 id="nodetool-sync---segments-validation">Nodetool Sync - Segments Validation</h2>
<ul>
<li>NodeSync - simply performs a read repair on the segment</li>
<li>read-data from all replicas</li>
<li>Check for inconsistencies</li>
<li>Repair stale nodes</li>
</ul>
<h2 id="cassandra-write-path-inside-the-node-and-for-a-partition">Cassandra Write Path (inside the node, and for <em>a</em> partition)</h2>
<ul>
<li>Two atomic operation makes a write successfull (Both commit-log + mem-table)
<ul>
<li>HDD - Commit Log</li>
<li>Memory - MemTable</li>
</ul></li>
<li>Commit log
<ul>
<li>It is append only commit log</li>
<li>Only retrieved during server restart (for replay)</li>
<li>Mem-Table: <img src="img/mem_table_commitlog.JPG" title="Commit-Log" alt="alt text" /></li>
</ul></li>
<li>Ensure Commit-log and ss-tables are stored in different drive
<ul>
<li>Commit log is append only for peformance</li>
<li>When we share same disk, disk seek operation for MM-Table would cause performance degradation</li>
</ul></li>
<li>Once Mem-Table is full, it is written as SS-Table (SSTable is immutable)</li>
<li>No inplace update performed on SS-Table</li>
</ul>
<h2 id="cassandra-read-path-inside-the-node-and-for-particular-a-partition">Cassandra Read Path (inside the node, and for particular a partition)</h2>
<ul>
<li>Read is easy if records are in mem-table
<ul>
<li>Based on token, just to binary-search on mem-table and return the data to client</li>
</ul></li>
<li>Read is bit more complex than write
<ul>
<li>Write path created plenty of SS-Table in disk for a partition</li>
</ul></li>
<li>SSTable has token:byte_off_set index
<ul>
<li>7:0,13:1120,18:3528,21:4392</li>
<li>7 partition token starts at 0th byte-offset</li>
<li>13 partition token starts at 1120th byte-offset</li>
</ul></li>
<li>Read_Token_58_From_SS_Table: <img src="img/read_58_token.JPG%20Read-token%22" alt="alt text" /></li>
<li>There is a file named “partition_index” that has details about token vs file-byte-offset index. It is used before reading ss-table</li>
<li>Partition-summary is an another index used by Cassandra
<ul>
<li>Partition-summary resides in memory</li>
</ul></li>
</ul>
<h2 id="cassandra-read-path-workflow">Cassandra Read Path workflow</h2>
<ul>
<li>ReadRequest –&gt; Bloomfilter –&gt; Key Cache –&gt; Partition Summary –&gt; Partition Index –&gt; SS-Table</li>
<li>Checks in key-cache (if succseeds, data returned directly reading ss-table)</li>
<li>Checks in partition-index (partition-summary-table)
<ul>
<li>Finds the byte-offset of ss-table from partition-index</li>
<li>Reads byte-offset from ss-table for actual data of the primary-key</li>
<li>Updates key-cache
<ul>
<li>key-cache contains byte-offsets of the most recently accessed records</li>
<li>key-cache is cache for partition-index (it avoids searcing in partition-index about ss-table byte-offset)</li>
</ul></li>
</ul></li>
<li>Finally… bloom filter can optimize all the above</li>
</ul>
<h2 id="bloom-filter-1">Bloom filter</h2>
<ul>
<li>It might stop the entire process if the data is not present</li>
<li>It might produce false positives, but never ends in false negative</li>
<li>If Bloom-filter says “no-data”, there is no such partition data in that node</li>
<li>If Bloom-filter says “possible-data”, there may or may not present data in that node</li>
</ul>
<h2 id="datastax">Datastax</h2>
<ul>
<li>Trie based partition-summary is being used</li>
<li>SSTable lookups are extreemly fast</li>
<li>When migrating from OSS to Datastax
<ul>
<li>Datastax can work with both kinds of ss_table-partition-index</li>
<li>It will gradually compact oss version into Trie-based partition-index</li>
<li>Tried based partition index is extreemly faster</li>
</ul></li>
</ul>
<h2 id="compaction-merging-ss-tables">Compaction (merging ss-tables)</h2>
<ul>
<li>Compaction
<ul>
<li>Removes old un-necessary immutable data</li>
<li>Deleted data (columns) are removed after gc_grace_seconds</li>
<li>Lesser number of ss-table, but during compaction it requires both old and new ss-table</li>
</ul></li>
<li>It merges two set-of partitions into one
<ul>
<li>Common partition data values are merged</li>
<li>Last write wins selected</li>
<li>Tombstone is marker for deleted record, that won’t move into new ss-table (if record passed gc_grace_seconds=10-days)</li>
<li>nodetool compact <keyspace> <code>{=html}     &lt;table&gt;</code> , There is no real offline compaction</li>
</ul></li>
<li>Not all tombstones are discarded</li>
<li></li>
<li>We never modify ss-table
<ul>
<li>Merge creates new ss-table</li>
<li>Stale data removed and compacted (reduced and combined into fewer ss-tables)</li>
</ul></li>
</ul>
<h2 id="compaction-strategies-based-on-use-case">Compaction Strategies (based on use-case)</h2>
<ul>
<li>Choose proper strategy based on use-case
<ul>
<li>SizeTieredCompaction - For write heavy</li>
<li>LeveledCompaction - For read heavy</li>
<li>TimeWindowCompaction - For timeseries</li>
</ul></li>
<li>We can change compaction strategy</li>
</ul>
<h2 id="advanced-peformance-gains-in-dse">Advanced Peformance Gains in (DSE)</h2>
<ul>
<li>OSS uses thread-pools, might cause thread contention</li>
<li>DSE - uses only one thread per core</li>
<li>DSE - Uses asynchronous a lot and non-blocking</li>
</ul>
<h2 id="before-and-after-flush">Before and after flush</h2>
<pre><code>Total number of tables: 47                  Total number of tables: 47
----------------                        ----------------
Keyspace : keyspace1                        Keyspace : keyspace1
    Read Count: 0                           Read Count: 0
    Read Latency: NaN ms                        Read Latency: NaN ms
    Write Count: 574408                     Write Count: 574408
    Write Latency: 0.009942241403323074 ms              Write Latency: 0.009942241403323074 ms
    Pending Flushes: 0                      Pending Flushes: 0
        Table: standard1                        Table: standard1
        SSTable count: 3                  |         SSTable count: 4
        Space used (live): 92.67 MiB              |         Space used (live): 97.73 MiB
        Space used (total): 92.67 MiB             |         Space used (total): 97.73 MiB
        Space used by snapshots (total): 0 bytes            Space used by snapshots (total): 0 bytes
        Off heap memory used (total): 497.8 KiB       |         Off heap memory used (total): 525.04 KiB
        SSTable Compression Ratio: -1.0                 SSTable Compression Ratio: -1.0
        Number of partitions (estimate): 426808       |         Number of partitions (estimate): 427070
        Memtable cell count: 22313            |         Memtable cell count: 0
        Memtable data size: 5.94 MiB              |         Memtable data size: 0 bytes
        Memtable off heap memory used: 0 bytes              Memtable off heap memory used: 0 bytes
        Memtable switch count: 18             |         Memtable switch count: 19
        Local read count: 0                     Local read count: 0
        Local read latency: NaN ms                  Local read latency: NaN ms
        Local write count: 574408                   Local write count: 574408
        Local write latency: 0.009 ms                   Local write latency: 0.009 ms
        Pending flushes: 0                      Pending flushes: 0
        Percent repaired: 0.0                       Percent repaired: 0.0
        Bytes repaired: 0.000KiB                    Bytes repaired: 0.000KiB
        Bytes unrepaired: 88.575MiB           |         Bytes unrepaired: 93.424MiB
        Bytes pending repair: 0.000KiB                  Bytes pending repair: 0.000KiB
        Bloom filter false positives: 0                 Bloom filter false positives: 0
        Bloom filter false ratio: 0.00000               Bloom filter false ratio: 0.00000
        Bloom filter space used: 497.82 KiB       |         Bloom filter space used: 525.07 KiB
        Bloom filter off heap memory used: 497.8 KiB  |         Bloom filter off heap memory used: 525.04 KiB
        Index summary off heap memory used: 0 bytes         Index summary off heap memory used: 0 bytes
        Compression metadata off heap memory used: 0            Compression metadata off heap memory used: 0 
        Compacted partition minimum bytes: 180              Compacted partition minimum bytes: 180
        Compacted partition maximum bytes: 258              Compacted partition maximum bytes: 258
        Compacted partition mean bytes: 258             Compacted partition mean bytes: 258
        Average live cells per slice (last five minut           Average live cells per slice (last five minut
        Maximum live cells per slice (last five minut           Maximum live cells per slice (last five minut
        Average tombstones per slice (last five minut           Average tombstones per slice (last five minut
        Maximum tombstones per slice (last five minut           Maximum tombstones per slice (last five minut
        Dropped Mutations: 0 bytes                  Dropped Mutations: 0 bytes
        Failed Replication Count: null                  Failed Replication Count: null</code></pre>
<h2 id="sample-data-directory-wiht-with-bloom_filter_fp_chance-0.1">Sample data directory wiht WITH bloom_filter_fp_chance = 0.1;</h2>
<pre><code>ubuntu@ds201-node1:~/node1/data/data/keyspace1/standard1-000692d1cb3811eb8b932752b509e266$ ls -ltar
total 36296
drwxrwxr-x 2 ubuntu ubuntu     4096 Jun 12 04:38 backups
drwxrwxr-x 4 ubuntu ubuntu     4096 Jun 12 04:38 ..
-rw-rw-r-- 1 ubuntu ubuntu        0 Jun 12 04:41 aa-9-bti-Rows.db
-rw-rw-r-- 1 ubuntu ubuntu 35457984 Jun 12 04:41 aa-9-bti-Data.db
-rw-rw-r-- 1 ubuntu ubuntu  1472810 Jun 12 04:41 aa-9-bti-Partitions.db
-rw-rw-r-- 1 ubuntu ubuntu   194656 Jun 12 04:41 aa-9-bti-Filter.db
-rw-rw-r-- 1 ubuntu ubuntu    10271 Jun 12 04:41 aa-9-bti-Statistics.db
-rw-rw-r-- 1 ubuntu ubuntu       10 Jun 12 04:41 aa-9-bti-Digest.crc32
-rw-rw-r-- 1 ubuntu ubuntu     2176 Jun 12 04:41 aa-9-bti-CRC.db
-rw-rw-r-- 1 ubuntu ubuntu       82 Jun 12 04:41 aa-9-bti-TOC.txt
drwxrwxr-x 3 ubuntu ubuntu     4096 Jun 12 04:41 .</code></pre>
<h2 id="sample-data-directory-wiht-with-bloom_filter_fp_chance-0.0001">Sample data directory wiht WITH bloom_filter_fp_chance = 0.0001;</h2>
<pre><code>ubuntu@ds201-node1:~/node1/data/data/keyspace1/standard1-000692d1cb3811eb8b932752b509e266$ ls -ltar
total 36488
drwxrwxr-x 2 ubuntu ubuntu     4096 Jun 12 04:38 backups
drwxrwxr-x 4 ubuntu ubuntu     4096 Jun 12 04:38 ..
-rw-rw-r-- 1 ubuntu ubuntu        0 Jun 12 04:47 aa-10-bti-Rows.db
-rw-rw-r-- 1 ubuntu ubuntu 35457984 Jun 12 04:47 aa-10-bti-Data.db
-rw-rw-r-- 1 ubuntu ubuntu  1472810 Jun 12 04:47 aa-10-bti-Partitions.db
-rw-rw-r-- 1 ubuntu ubuntu   389304 Jun 12 04:47 aa-10-bti-Filter.db
-rw-rw-r-- 1 ubuntu ubuntu       10 Jun 12 04:47 aa-10-bti-Digest.crc32
-rw-rw-r-- 1 ubuntu ubuntu     2176 Jun 12 04:47 aa-10-bti-CRC.db
-rw-rw-r-- 1 ubuntu ubuntu       82 Jun 12 04:47 aa-10-bti-TOC.txt
-rw-rw-r-- 1 ubuntu ubuntu    10271 Jun 12 04:47 aa-10-bti-Statistics.db
drwxrwxr-x 3 ubuntu ubuntu     4096 Jun 12 04:47 .</code></pre>
<h2 id="sample-data-directory-wiht-with-bloom_filter_fp_chance-1.0-100-false-positive-allowed-no-filter-file">Sample data directory wiht WITH bloom_filter_fp_chance = 1.0; (100% false positive allowed… No filter file)</h2>
<pre><code>ubuntu@ds201-node1:~/node1/data/data/keyspace1/standard1-000692d1cb3811eb8b932752b509e266$ ls -ltar
total 36104
drwxrwxr-x 2 ubuntu ubuntu     4096 Jun 12 04:38 backups
drwxrwxr-x 4 ubuntu ubuntu     4096 Jun 12 04:38 ..
-rw-rw-r-- 1 ubuntu ubuntu        0 Jun 12 04:53 aa-12-bti-Rows.db
-rw-rw-r-- 1 ubuntu ubuntu 35457984 Jun 12 04:53 aa-12-bti-Data.db
-rw-rw-r-- 1 ubuntu ubuntu  1472810 Jun 12 04:53 aa-12-bti-Partitions.db
-rw-rw-r-- 1 ubuntu ubuntu       10 Jun 12 04:53 aa-12-bti-Digest.crc32
-rw-rw-r-- 1 ubuntu ubuntu     2176 Jun 12 04:53 aa-12-bti-CRC.db
-rw-rw-r-- 1 ubuntu ubuntu    10271 Jun 12 04:53 aa-12-bti-Statistics.db
-rw-rw-r-- 1 ubuntu ubuntu       72 Jun 12 04:53 aa-12-bti-TOC.txt
drwxrwxr-x 3 ubuntu ubuntu     4096 Jun 12 04:53 .
ubuntu@ds201-node1:~/node1/data/data/keyspace1/standard1-0</code></pre>
<h2 id="nodetool-cfstats">Nodetool CFStats</h2>
<pre><code>ubuntu@ds201-node1:~/node/bin$ ./nodetool cfstats keyspace1
Total number of tables: 47
----------------
Keyspace : keyspace1
    Read Count: 0
    Read Latency: NaN ms
    Write Count: 154846
    Write Latency: 0.011354216447308938 ms
    Pending Flushes: 0
        Table: counter1
        SSTable count: 0
        Space used (live): 0
        Space used (total): 0
        Space used by snapshots (total): 0
        Off heap memory used (total): 0
        SSTable Compression Ratio: -1.0
        Number of partitions (estimate): 0
        Memtable cell count: 0
        Memtable data size: 0
        Memtable off heap memory used: 0
        Memtable switch count: 0
        Local read count: 0
        Local read latency: NaN ms
        Local write count: 0
        Local write latency: NaN ms
        Pending flushes: 0
        Percent repaired: 100.0
        Bytes repaired: 0.000KiB
        Bytes unrepaired: 0.000KiB
        Bytes pending repair: 0.000KiB
        Bloom filter false positives: 0
        Bloom filter false ratio: 0.00000
        Bloom filter space used: 0
        Bloom filter off heap memory used: 0
        Index summary off heap memory used: 0
        Compression metadata off heap memory used: 0
        Compacted partition minimum bytes: 0
        Compacted partition maximum bytes: 0
        Compacted partition mean bytes: 0
        Average live cells per slice (last five minutes): NaN
        Maximum live cells per slice (last five minutes): 0
        Average tombstones per slice (last five minutes): NaN
        Maximum tombstones per slice (last five minutes): 0
        Dropped Mutations: 0
        Failed Replication Count: null

        Table: standard1
        SSTable count: 1
        Space used (live): 36943323
        Space used (total): 36943323
        Space used by snapshots (total): 0
        Off heap memory used (total): 0
        SSTable Compression Ratio: -1.0
        Number of partitions (estimate): 155716
        Memtable cell count: 0
        Memtable data size: 0
        Memtable off heap memory used: 0
        Memtable switch count: 9
        Local read count: 0
        Local read latency: NaN ms
        Local write count: 154846
        Local write latency: 0.010 ms
        Pending flushes: 0
        Percent repaired: 0.0
        Bytes repaired: 0.000KiB
        Bytes unrepaired: 33.815MiB
        Bytes pending repair: 0.000KiB
        Bloom filter false positives: 0
        Bloom filter false ratio: 0.00000
        Bloom filter space used: 0
        Bloom filter off heap memory used: 0
        Index summary off heap memory used: 0
        Compression metadata off heap memory used: 0
        Compacted partition minimum bytes: 180
        Compacted partition maximum bytes: 258
        Compacted partition mean bytes: 258
        Average live cells per slice (last five minutes): NaN
        Maximum live cells per slice (last five minutes): 0
        Average tombstones per slice (last five minutes): NaN
        Maximum tombstones per slice (last five minutes): 0
        Dropped Mutations: 0
        Failed Replication Count: null

----------------
ubuntu@ds201-node1:~/node/bin$ 

./cassandra-stress read CL=ONE no-warmup n=1000000 -rate threads=1
./nodetool cfstats</code></pre>
<h2 id="followup-questions">Followup questions</h2>
<ul>
<li>we could not find /var/log/system.log
<ul>
<li>During single-node check console output or nohup.out or terminal output</li>
</ul></li>
<li>What is the difference between partition-summary and partition-index?</li>
</ul>
<h2 id="what-is-compaction-in-cassandra">What is compaction in Cassandra?</h2>
<ul>
<li>It is similar to comapaction of file-system</li>
<li>Multiple SS-Tables are merged (like merge-sort), and deleted removed, tombstones removed, updated records retained.
<ul>
<li>It leads to lean SS-Table</li>
</ul></li>
</ul>
<h2 id="pre-requisite-for-compaction">Pre-requisite for Compaction</h2>
<ul>
<li>Find table statistics
<ul>
<li>nodetool cfstats</li>
<li>nodetool tpstats</li>
</ul></li>
</ul>
<h2 id="we-have-problem-with-two-nodes-with-large-number-of-compaction-pending-how-to-speed-up">We have problem with two nodes with large number of compaction pending, how to speed up?</h2>
<ul>
<li>Disable the node act as a co-ordinator? (it can spend its io/cpu in compaction)
<ul>
<li>nodetool disablebinary</li>
</ul></li>
<li>Disable the node accepting write (should be lesser than hinted-handoff period) ?
<ul>
<li>nodetool disablegossip (marking node as down)</li>
<li>nodetool disablehandoff (marking node as down)</li>
</ul></li>
<li>Disable the node accepting write (should be lesser than hinted-handoff period) ?
<ul>
<li>nodetool disablegossip</li>
</ul></li>
<li>Increase the compaction througput (there would be consequences for read)
<ul>
<li>nodetool setconcurrentcompactors 2</li>
</ul></li>
</ul>
<h2 id="reference-4">Reference</h2>
<p><em><a href="https://thelastpickle.com/blog/2017/03/16/compaction-nuance.html">Understanding the Nuance of Compaction in Apache Cassandra</a> </em> <a href="https://thelastpickle.com/blog/2016/12/08/TWCS-part1.html">TWCS part 1 - how does it work and when should you use it ?</a> ## Queue anti-pattern</p>
<ul>
<li>Cassandra is not suited for Queue</li>
</ul>
<h2 id="anti-patterns-in-the-cassandra">Anti-patterns in the Cassandra</h2>
<ul>
<li><p><a href="https://docs.datastax.com/en/cassandra-oss/2.2/cassandra/planning/planPlanningAntiPatterns.html">Anti-patterns in Cassandra - 2.2</a></p></li>
<li><p><a href="https://docs.datastax.com/en/dse-planning/doc/planning/planningAntiPatterns.html">Anti-patterns-Planning and testing DataStax Enterprise deployments</a></p></li>
<li><p><a href="https://morioh.com/p/9e872f2fcd88">Anti-patterns which all Cassandra users must know</a></p></li>
<li><p><a href="https://medium.com/analytics-vidhya/anti-patterns-which-all-cassandra-users-must-know-1e54c60ff1fa">Anti-patterns which all Cassandra users must know</a></p></li>
<li><p><a href="https://www.slideshare.net/doanduyhai/cassandra-nice-use-cases-and-worst-anti-patterns">Cassandra nice use cases and worst anti patterns</a></p></li>
<li><p><a href="https://www.infoq.com/presentations/Apache-Cassandra-Anti-Patterns/">Apache Cassandra Anti Patterns-2012</a></p></li>
<li><p><a href="https://irrlab.com/2016/04/14/cassandra-anti-patterns-queues-and-queue-like-datasets/">Cassandra anti-patterns: Queues and queue-like datasets</a></p></li>
<li><p><a href="https://www.tomaz.me/slides/2014-24-03-cassandra-anti-patterns/#/">Cassandra Anti-Patterns</a></p></li>
<li><p>Building a queue, Frequently updated data, Query flexibility, Incorrect use of BATCH, Querying an entire table</p></li>
<li><pre class="pre"><code>    Using Apache Cassandra as a backend for a queue or queue-like structure is never going to end well. We have discussed at length that, due to Cassandra&#39;s log-based storage engine, inserts, updates, and deletes are all treated as writes. Well, what does a queue do? It does the following:

        Data gets written to a queue.
        Data gets updated while it&#39;s in the queue (example: status). Sometimes several times.
        When the data is no longer required, it gets deleted.

    Given what we have covered about how Cassandra handles things, such as in-place updates (obsoleted data) and deletes (tombstones), it should be obvious that this is not a good idea. Remember, a data model built to accommodate a small amount of in-place updates or deletes is fine. A data model that relies on in-place updates and deletes isn’t going to make anyone happy in the end.</code></pre></li>
</ul>
<h2 id="important-spring-java-project">Important Spring Java project</h2>
<ul>
<li><p><a href="https://github.com/spring-petclinic/spring-petclinic-reactive">Cassandra Datastax PetClinic</a></p></li>
<li><p><a href="https://github.com/DataStax-Examples/spring-petclinic-reactive">Cassandra Datastax Reactive PetClinic</a> # Important Cassandra links</p></li>
<li><p><a href="https://issues.apache.org/jira/browse/CASSANDRA-8844">JIRA</a></p></li>
<li><p><a href="https://cwiki.apache.org/confluence/display/CASSANDRA/Home">Cassandra Cwiki</a></p></li>
<li><p><a href="https://gitbox.apache.org/repos/asf/cassandra.git">GIT Cassandra</a></p></li>
<li><p><a href="https://ci-cassandra.apache.org/job/Cassandra-trunk/531/">CI-Cassandra-Build</a></p></li>
<li><p><a href="https://ci-cassandra.apache.org/job/Cassandra-4.0-artifacts/jdk=jdk_1.8_latest,label=cassandra/59/consoleFull">CI Console log</a></p></li>
</ul>
<h2 id="jira-based-on-labels">JIRA based on labels</h2>
<ul>
<li><a href="https://issues.apache.org/jira/browse/CASSANDRA-16773?jql=project%20%3D%20CASSANDRA%20AND%20component%20%3D%20%22Consistency%2FCoordination%22">Consistency/Coordination</a></li>
<li><a href="https://issues.apache.org/jira/browse/CASSANDRA-16479?jql=project%20%3D%20CASSANDRA%20AND%20component%20%3D%20%22Feature%2FMaterialized%20Views%22">Materialized View</a></li>
<li><a href="https://issues.apache.org/jira/browse/CASSANDRA-16390?jql=project%20%3D%20CASSANDRA%20AND%20component%20%3D%20%22Feature%2FSASI%22">Sasi</a></li>
</ul>
<h2 id="jira-features-in-cassandra">JIRA Features in Cassandra</h2>
<ul>
<li><p><a href="https://issues.apache.org/jira/projects/CASSANDRA?selectedItem=com.atlassian.jira.jira-projects-plugin:components-page">All the Components</a></p></li>
<li><p><a href="https://issues.apache.org/jira/browse/CASSANDRA-16772?jql=project%20%3D%20CASSANDRA%20AND%20component%20%3D%20%22Local%2FSSTable%22">Local/SSTable</a></p></li>
<li><p>Local/Compaction/LCS</p></li>
<li><p>Feature/Lightweight Transactions</p></li>
<li><p>Consistency/Repair, Observability/Logging</p></li>
<li><p>Test/unit</p></li>
<li><p>Cluster/Schema</p></li>
<li><p>Tool/sstable ## Cassandra usages in famous producs</p></li>
<li><p><a href="https://community.pega.com/knowledgebase/articles/decision-management/84/managing-cassandra-source-decision-management-data">Pega - decision management data</a> ## Cassandra Course Videos</p></li>
<li><p><a href="https://www.youtube.com/watch?v=69pvhO6mK_o&amp;list=PL2g2h-wyI4Spf5rzSmesewHpXYVnyQ2TS">DS-201 vidoes</a></p></li>
</ul>
<h2 id="cassandra-index">Cassandra index</h2>
<ul>
<li><a href="https://github.com/mohanmca/cassandra_playground/blob/master/Architecture.md">Architecture</a></li>
<li><a href="https://github.com/mohanmca/cassandra_playground/blob/master/README.md">README</a></li>
<li><a href="https://github.com/mohanmca/cassandra_playground/blob/master/cassandra_commands_output.md">cassandra_commands_output</a></li>
<li><a href="https://github.com/mohanmca/cassandra_playground/blob/master/cassandra_definitive_guide_anki.md">cassandra_definitive_guide_anki</a></li>
<li><a href="https://github.com/mohanmca/cassandra_playground/blob/master/cassandra_docker.md">cassandra_docker</a></li>
<li><a href="https://github.com/mohanmca/cassandra_playground/blob/master/cqls_anki.md">cqls_anki</a></li>
<li><a href="https://github.com/mohanmca/cassandra_playground/blob/master/data_types.md">data_types</a></li>
<li><a href="https://github.com/mohanmca/cassandra_playground/blob/master/partition.md">partition</a></li>
<li><a href="https://github.com/mohanmca/cassandra_playground/blob/master/setup.md">setup</a></li>
<li><a href="https://github.com/mohanmca/cassandra_playground/blob/master/todo.md">todo</a></li>
<li><a href="https://github.com/mohanmca/cassandra_playground/blob/master/log/debug.log">Debug log</a></li>
<li><a href="https://github.com/mohanmca/cassandra_playground/blob/master/log/system.log">System Log</a></li>
</ul>
<h2 id="famous-cassandra-articles">Famous Cassandra articles</h2>
<ul>
<li><p><a href="https://blog.pythian.com/the-things-i-hate-about-apache-cassandra/">The things I hate about Apache Cassandra - John Schulz</a> ## How to generate conf/cassandra_simple.yaml</p></li>
<li><p>grep -v “^#” conf/cassandra.yaml | sed ‘/^$/d’ &gt; conf/cassandra_simple.yaml</p></li>
</ul>
<h2 id="analyze-cassandra-code">Analyze Cassandra code</h2>
<pre><code>cat test/unit/org/apache/cassandra/db/compaction/LeveledCompactionStrategyTest.java | tr &#39; &#39; &#39;\r\n&#39; | tr A-Z a-z | sort| tr -d &#39;[\\}\\{}]&#39; | sort  </code></pre>
<h2 id="k8ssandra">K8ssandra</h2>
<ul>
<li><a href="https://github.com/datastaxdevs/workshop-k8ssandra">Workshop</a></li>
<li><a href="https://github.com/datastaxdevs/k8ssandra-workshop/raw/main/K8ssandra%20Workshop%20Feb%202021.pdf">Workshop slides</a></li>
<li><a href="https://github.com/datastaxdevs/workshop-k8ssandra/wiki">Workshop Steps</a></li>
</ul>
</body>
</html>
